{"version":3,"file":"playwright/ai-fixture.mjs","sources":["../../../src/playwright/ai-fixture.ts"],"sourcesContent":["import { rmSync, writeFileSync } from 'node:fs';\nimport { tmpdir } from 'node:os';\nimport { join } from 'node:path';\nimport { PlaywrightAgent, type PlaywrightWebPage } from '@/playwright/index';\nimport type { WebPageAgentOpt } from '@/web-element';\nimport type { Cache } from '@midscene/core';\nimport type { AgentOpt, Agent as PageAgent } from '@midscene/core/agent';\nimport { processCacheConfig } from '@midscene/core/utils';\nimport {\n  DEFAULT_WAIT_FOR_NAVIGATION_TIMEOUT,\n  DEFAULT_WAIT_FOR_NETWORK_IDLE_TIMEOUT,\n} from '@midscene/shared/constants';\nimport { getDebug } from '@midscene/shared/logger';\nimport { uuid } from '@midscene/shared/utils';\nimport { replaceIllegalPathCharsAndSpace } from '@midscene/shared/utils';\nimport { type TestInfo, type TestType, test } from '@playwright/test';\nimport type { Page as OriginPlaywrightPage } from 'playwright';\nexport type APITestType = Pick<TestType<any, any>, 'step'>;\n\nconst debugPage = getDebug('web:playwright:ai-fixture');\n\nconst groupAndCaseForTest = (testInfo: TestInfo) => {\n  let taskFile: string;\n  let taskTitle: string;\n  const titlePath = [...testInfo.titlePath];\n\n  if (titlePath.length > 1) {\n    taskFile = titlePath.shift() || 'unnamed';\n    taskTitle = titlePath.join('__');\n  } else if (titlePath.length === 1) {\n    taskTitle = titlePath[0];\n    taskFile = `${taskTitle}`;\n  } else {\n    taskTitle = 'unnamed';\n    taskFile = 'unnamed';\n  }\n\n  const taskTitleWithRetry = `${taskTitle}${testInfo.retry ? `(retry #${testInfo.retry})` : ''}`;\n\n  return {\n    file: taskFile,\n    id: replaceIllegalPathCharsAndSpace(`${taskFile}(${taskTitle})`),\n    title: replaceIllegalPathCharsAndSpace(taskTitleWithRetry),\n  };\n};\n\nconst midsceneAgentKeyId = '_midsceneAgentId';\nexport const midsceneDumpAnnotationId = 'MIDSCENE_DUMP_ANNOTATION';\n\n// Track temporary dump files per page for cleanup\nconst pageTempFiles = new Map<string, string>();\n\ntype PlaywrightCacheConfig = {\n  strategy?: 'read-only' | 'read-write' | 'write-only';\n  id?: string;\n};\ntype PlaywrightCache = false | true | PlaywrightCacheConfig;\n\nexport const PlaywrightAiFixture = (options?: {\n  forceSameTabNavigation?: boolean;\n  waitForNetworkIdleTimeout?: number;\n  waitForNavigationTimeout?: number;\n  cache?: PlaywrightCache;\n}) => {\n  const {\n    forceSameTabNavigation = true,\n    waitForNetworkIdleTimeout = DEFAULT_WAIT_FOR_NETWORK_IDLE_TIMEOUT,\n    waitForNavigationTimeout = DEFAULT_WAIT_FOR_NAVIGATION_TIMEOUT,\n    cache,\n  } = options ?? {};\n\n  // Helper function to process cache configuration and auto-generate ID from test info\n  const processTestCacheConfig = (testInfo: TestInfo): Cache | undefined => {\n    // Generate ID from test info\n    const { id } = groupAndCaseForTest(testInfo);\n\n    // Use shared processCacheConfig with generated ID as fallback\n    return processCacheConfig(cache as Cache, id);\n  };\n\n  const pageAgentMap: Record<string, PageAgent<PlaywrightWebPage>> = {};\n  const createOrReuseAgentForPage = (\n    page: OriginPlaywrightPage,\n    testInfo: TestInfo, // { testId: string; taskFile: string; taskTitle: string },\n    opts?: WebPageAgentOpt,\n  ) => {\n    let idForPage = (page as any)[midsceneAgentKeyId];\n    if (!idForPage) {\n      idForPage = uuid();\n      (page as any)[midsceneAgentKeyId] = idForPage;\n      const { testId } = testInfo;\n      const { file, title } = groupAndCaseForTest(testInfo);\n      const cacheConfig = processTestCacheConfig(testInfo);\n\n      pageAgentMap[idForPage] = new PlaywrightAgent(page, {\n        testId: `playwright-${testId}-${idForPage}`,\n        forceSameTabNavigation,\n        cache: cacheConfig,\n        groupName: title,\n        groupDescription: file,\n        generateReport: false, // we will generate it in the reporter\n        ...opts,\n      });\n\n      pageAgentMap[idForPage].onDumpUpdate = (dump: string) => {\n        updateDumpAnnotation(testInfo, dump, idForPage);\n      };\n\n      page.on('close', () => {\n        debugPage('page closed');\n\n        // Note: We don't clean up temp files here because the reporter\n        // needs to read them in onTestEnd. The reporter will clean them up\n        // after reading. If the test is interrupted (Ctrl+C), the process\n        // exit handlers will clean up remaining temp files.\n\n        // However, we do clean up the pageTempFiles Map entry to avoid memory leaks\n        pageTempFiles.delete(idForPage);\n\n        pageAgentMap[idForPage].destroy();\n        delete pageAgentMap[idForPage];\n      });\n    }\n\n    return pageAgentMap[idForPage];\n  };\n\n  async function generateAiFunction(options: {\n    page: OriginPlaywrightPage;\n    testInfo: TestInfo;\n    use: any;\n    aiActionType:\n      | 'ai'\n      | 'aiAct'\n      | 'aiAction'\n      | 'aiHover'\n      | 'aiInput'\n      | 'aiKeyboardPress'\n      | 'aiScroll'\n      | 'aiTap'\n      | 'aiRightClick'\n      | 'aiDoubleClick'\n      | 'aiQuery'\n      | 'aiAssert'\n      | 'aiWaitFor'\n      | 'aiLocate'\n      | 'aiNumber'\n      | 'aiString'\n      | 'aiBoolean'\n      | 'aiAsk'\n      | 'runYaml'\n      | 'setAIActionContext'\n      | 'evaluateJavaScript'\n      | 'recordToReport'\n      | 'logScreenshot'\n      | 'freezePageContext'\n      | 'unfreezePageContext';\n  }) {\n    const { page, testInfo, use, aiActionType } = options;\n    const agent = createOrReuseAgentForPage(page, testInfo, {\n      waitForNavigationTimeout,\n      waitForNetworkIdleTimeout,\n    }) as PlaywrightAgent;\n\n    await use(async (taskPrompt: string, ...args: any[]) => {\n      return new Promise((resolve, reject) => {\n        test.step(`ai-${aiActionType} - ${JSON.stringify(taskPrompt)}`, async () => {\n          try {\n            debugPage(\n              `waitForNetworkIdle timeout: ${waitForNetworkIdleTimeout}`,\n            );\n            await agent.waitForNetworkIdle(waitForNetworkIdleTimeout);\n          } catch (error) {\n            console.warn(\n              '[midscene:warning] Waiting for network idle has timed out, but Midscene will continue execution. Please check https://midscenejs.com/faq.html#customize-the-network-timeout for more information on customizing the network timeout',\n            );\n          }\n          try {\n            type AgentMethod = (\n              prompt: string,\n              ...restArgs: any[]\n            ) => Promise<any>;\n            const result = await (agent[aiActionType] as AgentMethod).bind(\n              agent,\n            )(taskPrompt, ...args);\n            resolve(result);\n          } catch (error) {\n            reject(error);\n          }\n        });\n      });\n    });\n  }\n\n  const updateDumpAnnotation = (\n    test: TestInfo,\n    dump: string,\n    pageId: string,\n  ) => {\n    // 1. First, clean up the old temp file if it exists\n    const oldTempFilePath = pageTempFiles.get(pageId);\n    if (oldTempFilePath) {\n      try {\n        rmSync(oldTempFilePath, { force: true });\n      } catch (error) {\n        // Silently ignore if old file is already cleaned up\n      }\n    }\n\n    // 2. Create new temp file with predictable name using pageId\n    const tempFileName = `midscene-dump-${test.testId || uuid()}-${pageId}.json`;\n    const tempFilePath = join(tmpdir(), tempFileName);\n\n    // 3. Write dump to the new temporary file\n    try {\n      writeFileSync(tempFilePath, dump, 'utf-8');\n      debugPage(`Dump written to temp file: ${tempFilePath}`);\n\n      // 4. Track the new temp file (only if write succeeded)\n      pageTempFiles.set(pageId, tempFilePath);\n\n      // Store only the file path in annotation (only if write succeeded)\n      const currentAnnotation = test.annotations.find((item) => {\n        return item.type === midsceneDumpAnnotationId;\n      });\n      if (currentAnnotation) {\n        // Store file path instead of dump content\n        currentAnnotation.description = tempFilePath;\n      } else {\n        test.annotations.push({\n          type: midsceneDumpAnnotationId,\n          description: tempFilePath,\n        });\n      }\n    } catch (error) {\n      // If write fails (e.g., disk full), don't track the file or add annotation\n      // This prevents reporter from trying to read a non-existent file\n      debugPage(\n        `Failed to write temp file: ${tempFilePath}. Skipping annotation.`,\n        error,\n      );\n    }\n  };\n\n  return {\n    agentForPage: async (\n      { page }: { page: OriginPlaywrightPage },\n      use: any,\n      testInfo: TestInfo,\n    ) => {\n      await use(\n        async (\n          propsPage?: OriginPlaywrightPage | undefined,\n          opts?: AgentOpt,\n        ) => {\n          const cacheConfig = processTestCacheConfig(testInfo);\n\n          // Handle cache configuration priority:\n          // 1. If user provides cache in opts, use it (but auto-generate ID if missing)\n          // 2. Otherwise use fixture's cache config\n          let finalCacheConfig = cacheConfig;\n          if (opts?.cache !== undefined) {\n            const userCache = opts.cache;\n            if (userCache === false) {\n              finalCacheConfig = false;\n            } else if (userCache === true) {\n              // Auto-generate ID for user's cache: true\n              const { id } = groupAndCaseForTest(testInfo);\n              finalCacheConfig = { id };\n            } else if (typeof userCache === 'object') {\n              if (!userCache.id) {\n                // Auto-generate ID for user's cache object without ID\n                const { id } = groupAndCaseForTest(testInfo);\n                finalCacheConfig = { ...userCache, id };\n              } else {\n                finalCacheConfig = userCache;\n              }\n            }\n          }\n\n          const agent = createOrReuseAgentForPage(propsPage || page, testInfo, {\n            waitForNavigationTimeout,\n            waitForNetworkIdleTimeout,\n            cache: finalCacheConfig,\n            ...opts,\n          });\n          return agent;\n        },\n      );\n    },\n    ai: async (\n      { page }: { page: OriginPlaywrightPage },\n      use: any,\n      testInfo: TestInfo,\n    ) => {\n      await generateAiFunction({\n        page,\n        testInfo,\n        use,\n        aiActionType: 'ai',\n      });\n    },\n    aiAct: async (\n      { page }: { page: OriginPlaywrightPage },\n      use: any,\n      testInfo: TestInfo,\n    ) => {\n      await generateAiFunction({\n        page,\n        testInfo,\n        use,\n        aiActionType: 'aiAct',\n      });\n    },\n    /**\n     * @deprecated Use {@link PlaywrightAiFixture.aiAct} instead.\n     */\n    aiAction: async (\n      { page }: { page: OriginPlaywrightPage },\n      use: any,\n      testInfo: TestInfo,\n    ) => {\n      await generateAiFunction({\n        page,\n        testInfo,\n        use,\n        aiActionType: 'aiAction',\n      });\n    },\n    aiTap: async (\n      { page }: { page: OriginPlaywrightPage },\n      use: any,\n      testInfo: TestInfo,\n    ) => {\n      await generateAiFunction({\n        page,\n        testInfo,\n        use,\n        aiActionType: 'aiTap',\n      });\n    },\n    aiRightClick: async (\n      { page }: { page: OriginPlaywrightPage },\n      use: any,\n      testInfo: TestInfo,\n    ) => {\n      await generateAiFunction({\n        page,\n        testInfo,\n        use,\n        aiActionType: 'aiRightClick',\n      });\n    },\n    aiDoubleClick: async (\n      { page }: { page: OriginPlaywrightPage },\n      use: any,\n      testInfo: TestInfo,\n    ) => {\n      await generateAiFunction({\n        page,\n        testInfo,\n        use,\n        aiActionType: 'aiDoubleClick',\n      });\n    },\n    aiHover: async (\n      { page }: { page: OriginPlaywrightPage },\n      use: any,\n      testInfo: TestInfo,\n    ) => {\n      await generateAiFunction({\n        page,\n        testInfo,\n        use,\n        aiActionType: 'aiHover',\n      });\n    },\n    aiInput: async (\n      { page }: { page: OriginPlaywrightPage },\n      use: any,\n      testInfo: TestInfo,\n    ) => {\n      await generateAiFunction({\n        page,\n        testInfo,\n        use,\n        aiActionType: 'aiInput',\n      });\n    },\n    aiKeyboardPress: async (\n      { page }: { page: OriginPlaywrightPage },\n      use: any,\n      testInfo: TestInfo,\n    ) => {\n      await generateAiFunction({\n        page,\n        testInfo,\n        use,\n        aiActionType: 'aiKeyboardPress',\n      });\n    },\n    aiScroll: async (\n      { page }: { page: OriginPlaywrightPage },\n      use: any,\n      testInfo: TestInfo,\n    ) => {\n      await generateAiFunction({\n        page,\n        testInfo,\n        use,\n        aiActionType: 'aiScroll',\n      });\n    },\n    aiQuery: async (\n      { page }: { page: OriginPlaywrightPage },\n      use: any,\n      testInfo: TestInfo,\n    ) => {\n      await generateAiFunction({\n        page,\n        testInfo,\n        use,\n        aiActionType: 'aiQuery',\n      });\n    },\n    aiAssert: async (\n      { page }: { page: OriginPlaywrightPage },\n      use: any,\n      testInfo: TestInfo,\n    ) => {\n      await generateAiFunction({\n        page,\n        testInfo,\n        use,\n        aiActionType: 'aiAssert',\n      });\n    },\n    aiWaitFor: async (\n      { page }: { page: OriginPlaywrightPage },\n      use: any,\n      testInfo: TestInfo,\n    ) => {\n      await generateAiFunction({\n        page,\n        testInfo,\n        use,\n        aiActionType: 'aiWaitFor',\n      });\n    },\n    aiLocate: async (\n      { page }: { page: OriginPlaywrightPage },\n      use: any,\n      testInfo: TestInfo,\n    ) => {\n      await generateAiFunction({\n        page,\n        testInfo,\n        use,\n        aiActionType: 'aiLocate',\n      });\n    },\n    aiNumber: async (\n      { page }: { page: OriginPlaywrightPage },\n      use: any,\n      testInfo: TestInfo,\n    ) => {\n      await generateAiFunction({\n        page,\n        testInfo,\n        use,\n        aiActionType: 'aiNumber',\n      });\n    },\n    aiString: async (\n      { page }: { page: OriginPlaywrightPage },\n      use: any,\n      testInfo: TestInfo,\n    ) => {\n      await generateAiFunction({\n        page,\n        testInfo,\n        use,\n        aiActionType: 'aiString',\n      });\n    },\n    aiBoolean: async (\n      { page }: { page: OriginPlaywrightPage },\n      use: any,\n      testInfo: TestInfo,\n    ) => {\n      await generateAiFunction({\n        page,\n        testInfo,\n        use,\n        aiActionType: 'aiBoolean',\n      });\n    },\n    aiAsk: async (\n      { page }: { page: OriginPlaywrightPage },\n      use: any,\n      testInfo: TestInfo,\n    ) => {\n      await generateAiFunction({\n        page,\n        testInfo,\n        use,\n        aiActionType: 'aiAsk',\n      });\n    },\n    runYaml: async (\n      { page }: { page: OriginPlaywrightPage },\n      use: any,\n      testInfo: TestInfo,\n    ) => {\n      await generateAiFunction({\n        page,\n        testInfo,\n        use,\n        aiActionType: 'runYaml',\n      });\n    },\n    setAIActionContext: async (\n      { page }: { page: OriginPlaywrightPage },\n      use: any,\n      testInfo: TestInfo,\n    ) => {\n      await generateAiFunction({\n        page,\n        testInfo,\n        use,\n        aiActionType: 'setAIActionContext',\n      });\n    },\n    evaluateJavaScript: async (\n      { page }: { page: OriginPlaywrightPage },\n      use: any,\n      testInfo: TestInfo,\n    ) => {\n      await generateAiFunction({\n        page,\n        testInfo,\n        use,\n        aiActionType: 'evaluateJavaScript',\n      });\n    },\n    recordToReport: async (\n      { page }: { page: OriginPlaywrightPage },\n      use: any,\n      testInfo: TestInfo,\n    ) => {\n      await generateAiFunction({\n        page,\n        testInfo,\n        use,\n        aiActionType: 'recordToReport',\n      });\n    },\n    logScreenshot: async (\n      { page }: { page: OriginPlaywrightPage },\n      use: any,\n      testInfo: TestInfo,\n    ) => {\n      await generateAiFunction({\n        page,\n        testInfo,\n        use,\n        aiActionType: 'logScreenshot',\n      });\n    },\n    freezePageContext: async (\n      { page }: { page: OriginPlaywrightPage },\n      use: any,\n      testInfo: TestInfo,\n    ) => {\n      await generateAiFunction({\n        page,\n        testInfo,\n        use,\n        aiActionType: 'freezePageContext',\n      });\n    },\n    unfreezePageContext: async (\n      { page }: { page: OriginPlaywrightPage },\n      use: any,\n      testInfo: TestInfo,\n    ) => {\n      await generateAiFunction({\n        page,\n        testInfo,\n        use,\n        aiActionType: 'unfreezePageContext',\n      });\n    },\n  };\n};\n\nexport type PlayWrightAiFixtureType = {\n  agentForPage: (\n    page?: any,\n    opts?: any,\n  ) => Promise<PageAgent<PlaywrightWebPage>>;\n  ai: <T = any>(...args: Parameters<PageAgent['ai']>) => Promise<T>;\n  aiAct: (\n    ...args: Parameters<PageAgent['aiAct']>\n  ) => ReturnType<PageAgent['aiAct']>;\n  /**\n   * @deprecated Use {@link PlayWrightAiFixtureType.aiAct} instead.\n   */\n  aiAction: (\n    ...args: Parameters<PageAgent['aiAction']>\n  ) => ReturnType<PageAgent['aiAction']>;\n  aiTap: (\n    ...args: Parameters<PageAgent['aiTap']>\n  ) => ReturnType<PageAgent['aiTap']>;\n  aiRightClick: (\n    ...args: Parameters<PageAgent['aiRightClick']>\n  ) => ReturnType<PageAgent['aiRightClick']>;\n  aiDoubleClick: (\n    ...args: Parameters<PageAgent['aiDoubleClick']>\n  ) => ReturnType<PageAgent['aiDoubleClick']>;\n  aiHover: (\n    ...args: Parameters<PageAgent['aiHover']>\n  ) => ReturnType<PageAgent['aiHover']>;\n  aiInput: (\n    ...args: Parameters<PageAgent['aiInput']>\n  ) => ReturnType<PageAgent['aiInput']>;\n  aiKeyboardPress: (\n    ...args: Parameters<PageAgent['aiKeyboardPress']>\n  ) => ReturnType<PageAgent['aiKeyboardPress']>;\n  aiScroll: (\n    ...args: Parameters<PageAgent['aiScroll']>\n  ) => ReturnType<PageAgent['aiScroll']>;\n  aiQuery: <T = any>(...args: Parameters<PageAgent['aiQuery']>) => Promise<T>;\n  aiAssert: (\n    ...args: Parameters<PageAgent['aiAssert']>\n  ) => ReturnType<PageAgent['aiAssert']>;\n  aiWaitFor: (...args: Parameters<PageAgent['aiWaitFor']>) => Promise<void>;\n  aiLocate: (\n    ...args: Parameters<PageAgent['aiLocate']>\n  ) => ReturnType<PageAgent['aiLocate']>;\n  aiNumber: (\n    ...args: Parameters<PageAgent['aiNumber']>\n  ) => ReturnType<PageAgent['aiNumber']>;\n  aiString: (\n    ...args: Parameters<PageAgent['aiString']>\n  ) => ReturnType<PageAgent['aiString']>;\n  aiBoolean: (\n    ...args: Parameters<PageAgent['aiBoolean']>\n  ) => ReturnType<PageAgent['aiBoolean']>;\n  aiAsk: (\n    ...args: Parameters<PageAgent['aiAsk']>\n  ) => ReturnType<PageAgent['aiAsk']>;\n  runYaml: (\n    ...args: Parameters<PageAgent['runYaml']>\n  ) => ReturnType<PageAgent['runYaml']>;\n  setAIActionContext: (\n    ...args: Parameters<PageAgent['setAIActionContext']>\n  ) => ReturnType<PageAgent['setAIActionContext']>;\n  evaluateJavaScript: (\n    ...args: Parameters<PageAgent['evaluateJavaScript']>\n  ) => ReturnType<PageAgent['evaluateJavaScript']>;\n  recordToReport: (\n    ...args: Parameters<PageAgent['recordToReport']>\n  ) => ReturnType<PageAgent['recordToReport']>;\n  logScreenshot: (\n    ...args: Parameters<PageAgent['logScreenshot']>\n  ) => ReturnType<PageAgent['logScreenshot']>;\n  freezePageContext: (\n    ...args: Parameters<PageAgent['freezePageContext']>\n  ) => ReturnType<PageAgent['freezePageContext']>;\n  unfreezePageContext: (\n    ...args: Parameters<PageAgent['unfreezePageContext']>\n  ) => ReturnType<PageAgent['unfreezePageContext']>;\n};\n"],"names":["debugPage","getDebug","groupAndCaseForTest","testInfo","taskFile","taskTitle","titlePath","taskTitleWithRetry","replaceIllegalPathCharsAndSpace","midsceneAgentKeyId","midsceneDumpAnnotationId","pageTempFiles","Map","PlaywrightAiFixture","options","forceSameTabNavigation","waitForNetworkIdleTimeout","DEFAULT_WAIT_FOR_NETWORK_IDLE_TIMEOUT","waitForNavigationTimeout","DEFAULT_WAIT_FOR_NAVIGATION_TIMEOUT","cache","processTestCacheConfig","id","processCacheConfig","pageAgentMap","createOrReuseAgentForPage","page","opts","idForPage","uuid","testId","file","title","cacheConfig","PlaywrightAgent","dump","updateDumpAnnotation","generateAiFunction","use","aiActionType","agent","taskPrompt","args","Promise","resolve","reject","test","JSON","error","console","result","pageId","oldTempFilePath","rmSync","tempFileName","tempFilePath","join","tmpdir","writeFileSync","currentAnnotation","item","propsPage","finalCacheConfig","undefined","userCache"],"mappings":"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"}