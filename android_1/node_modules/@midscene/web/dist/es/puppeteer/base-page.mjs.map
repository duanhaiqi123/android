{"version":3,"file":"puppeteer/base-page.mjs","sources":["../../../src/puppeteer/base-page.ts"],"sourcesContent":["import { type WebPageAgentOpt, WebPageContextParser } from '@/web-element';\nimport type {\n  DeviceAction,\n  ElementCacheFeature,\n  ElementTreeNode,\n  Point,\n  Rect,\n  Size,\n  UIContext,\n} from '@midscene/core';\nimport {\n  AiJudgeOrderSensitive,\n  callAIWithObjectResponse,\n} from '@midscene/core/ai-model';\nimport type { AbstractInterface } from '@midscene/core/device';\nimport { sleep } from '@midscene/core/utils';\nimport {\n  DEFAULT_WAIT_FOR_NAVIGATION_TIMEOUT,\n  DEFAULT_WAIT_FOR_NETWORK_IDLE_CONCURRENCY,\n  DEFAULT_WAIT_FOR_NETWORK_IDLE_TIMEOUT,\n} from '@midscene/shared/constants';\nimport type { IModelConfig } from '@midscene/shared/env';\nimport type { ElementInfo } from '@midscene/shared/extractor';\nimport { treeToList } from '@midscene/shared/extractor';\nimport { createImgBase64ByFormat } from '@midscene/shared/img';\nimport { type DebugFunction, getDebug } from '@midscene/shared/logger';\nimport {\n  getElementInfosScriptContent,\n  getExtraReturnLogic,\n} from '@midscene/shared/node';\nimport { assert } from '@midscene/shared/utils';\nimport type { Page as PlaywrightPage } from 'playwright';\nimport type { Page as PuppeteerPage } from 'puppeteer';\nimport {\n  type KeyInput,\n  type MouseButton,\n  commonWebActionsForWebPage,\n} from '../web-page';\n\nexport const debugPage = getDebug('web:page');\n\ntype WebElementCacheFeature = ElementCacheFeature & {\n  xpaths?: string[];\n};\n\nconst sanitizeXpaths = (xpaths: unknown): string[] => {\n  if (!Array.isArray(xpaths)) {\n    return [];\n  }\n\n  return xpaths.filter(\n    (xpath): xpath is string => typeof xpath === 'string' && xpath.length > 0,\n  );\n};\n\nexport class Page<\n  AgentType extends 'puppeteer' | 'playwright',\n  InterfaceType extends PuppeteerPage | PlaywrightPage,\n> implements AbstractInterface\n{\n  underlyingPage: InterfaceType;\n  protected waitForNavigationTimeout: number;\n  protected waitForNetworkIdleTimeout: number;\n  private viewportSize?: Size;\n  private onBeforeInvokeAction?: AbstractInterface['beforeInvokeAction'];\n  private onAfterInvokeAction?: AbstractInterface['afterInvokeAction'];\n  private customActions?: DeviceAction<any>[];\n  private enableTouchEventsInActionSpace: boolean;\n  interfaceType: AgentType;\n\n  actionSpace(): DeviceAction[] {\n    const defaultActions = commonWebActionsForWebPage(\n      this,\n      this.enableTouchEventsInActionSpace,\n    );\n    const customActions = this.customActions || [];\n    return [...defaultActions, ...customActions];\n  }\n\n  private async evaluate<R>(\n    pageFunction: string | ((...args: any[]) => R | Promise<R>),\n    arg?: any,\n  ): Promise<R> {\n    let result: R;\n    debugPage('evaluate function begin');\n    if (this.interfaceType === 'puppeteer') {\n      result = await (this.underlyingPage as PuppeteerPage).evaluate(\n        pageFunction,\n        arg,\n      );\n    } else {\n      result = await (this.underlyingPage as PlaywrightPage).evaluate(\n        pageFunction,\n        arg,\n      );\n    }\n    debugPage('evaluate function end');\n    return result;\n  }\n\n  constructor(\n    underlyingPage: InterfaceType,\n    interfaceType: AgentType,\n    opts?: WebPageAgentOpt,\n  ) {\n    this.underlyingPage = underlyingPage;\n    this.interfaceType = interfaceType;\n    this.waitForNavigationTimeout =\n      opts?.waitForNavigationTimeout ?? DEFAULT_WAIT_FOR_NAVIGATION_TIMEOUT;\n    this.waitForNetworkIdleTimeout =\n      opts?.waitForNetworkIdleTimeout ?? DEFAULT_WAIT_FOR_NETWORK_IDLE_TIMEOUT;\n    this.onBeforeInvokeAction = opts?.beforeInvokeAction;\n    this.onAfterInvokeAction = opts?.afterInvokeAction;\n    this.customActions = opts?.customActions;\n    this.enableTouchEventsInActionSpace =\n      opts?.enableTouchEventsInActionSpace ?? false;\n  }\n\n  async evaluateJavaScript<T = any>(script: string): Promise<T> {\n    return this.evaluate(script);\n  }\n\n  async waitForNavigation() {\n    if (this.waitForNavigationTimeout === 0) {\n      debugPage('waitForNavigation timeout is 0, skip waiting');\n      return;\n    }\n\n    // issue: https://github.com/puppeteer/puppeteer/issues/3323\n    if (\n      this.interfaceType === 'puppeteer' ||\n      this.interfaceType === 'playwright'\n    ) {\n      debugPage('waitForNavigation begin');\n      debugPage(`waitForNavigation timeout: ${this.waitForNavigationTimeout}`);\n      try {\n        await (this.underlyingPage as PuppeteerPage).waitForSelector('html', {\n          timeout: this.waitForNavigationTimeout,\n        });\n      } catch (error) {\n        // Ignore timeout error, continue execution\n        console.warn(\n          '[midscene:warning] Waiting for the \"navigation\" has timed out, but Midscene will continue execution. Please check https://midscenejs.com/faq.html#customize-the-network-timeout for more information on customizing the network timeout',\n        );\n      }\n      debugPage('waitForNavigation end');\n    }\n  }\n\n  async waitForNetworkIdle(): Promise<void> {\n    if (this.interfaceType === 'puppeteer') {\n      if (this.waitForNetworkIdleTimeout === 0) {\n        debugPage('waitForNetworkIdle timeout is 0, skip waiting');\n        return;\n      }\n\n      try {\n        await (this.underlyingPage as PuppeteerPage).waitForNetworkIdle({\n          idleTime: 200,\n          concurrency: DEFAULT_WAIT_FOR_NETWORK_IDLE_CONCURRENCY,\n          timeout: this.waitForNetworkIdleTimeout,\n        });\n      } catch (error) {\n        // Ignore timeout error, continue execution\n        console.warn(\n          '[midscene:warning] Waiting for the \"network idle\" has timed out, but Midscene will continue execution. Please check https://midscenejs.com/faq.html#customize-the-network-timeout for more information on customizing the network timeout',\n        );\n      }\n    } else {\n      // TODO: implement playwright waitForNetworkIdle\n    }\n  }\n\n  // @deprecated\n  async getElementsInfo() {\n    // const scripts = await getExtraReturnLogic();\n    // const captureElementSnapshot = await this.evaluate(scripts);\n    // return captureElementSnapshot as ElementInfo[];\n    await this.waitForNavigation();\n    debugPage('getElementsInfo begin');\n    const tree = await this.getElementsNodeTree();\n    debugPage('getElementsInfo end');\n    return treeToList(tree);\n  }\n\n  private async getXpathsByPoint(point: Point, isOrderSensitive: boolean) {\n    const elementInfosScriptContent = getElementInfosScriptContent();\n\n    return this.evaluateJavaScript(\n      `${elementInfosScriptContent}midscene_element_inspector.getXpathsByPoint({left: ${point.left}, top: ${point.top}}, ${isOrderSensitive})`,\n    );\n  }\n\n  private async getElementInfoByXpath(xpath: string) {\n    const elementInfosScriptContent = getElementInfosScriptContent();\n\n    return this.evaluateJavaScript(\n      `${elementInfosScriptContent}midscene_element_inspector.getElementInfoByXpath(${JSON.stringify(xpath)})`,\n    );\n  }\n\n  async cacheFeatureForRect(\n    rect: Rect,\n    options?: {\n      targetDescription?: string;\n      modelConfig?: IModelConfig;\n    },\n  ): Promise<ElementCacheFeature> {\n    const center: Point = {\n      left: Math.floor(rect.left + rect.width / 2),\n      top: Math.floor(rect.top + rect.height / 2),\n    };\n\n    try {\n      // Determine isOrderSensitive\n      let isOrderSensitive = false;\n      if (options?.targetDescription && options?.modelConfig) {\n        try {\n          const judgeResult = await AiJudgeOrderSensitive(\n            options.targetDescription,\n            callAIWithObjectResponse,\n            options.modelConfig,\n          );\n          isOrderSensitive = judgeResult.isOrderSensitive;\n          debugPage(\n            'judged isOrderSensitive=%s for description: %s',\n            isOrderSensitive,\n            options.targetDescription,\n          );\n        } catch (error) {\n          debugPage('Failed to judge isOrderSensitive: %s', error);\n          // Fall back to false on error\n        }\n      }\n\n      const xpaths = await this.getXpathsByPoint(center, isOrderSensitive);\n      const sanitized = sanitizeXpaths(xpaths);\n      if (!sanitized.length) {\n        debugPage('cacheFeatureForRect: no xpath found at rect %o', rect);\n      }\n      return {\n        xpaths: sanitized,\n      };\n    } catch (error) {\n      debugPage('cacheFeatureForRect failed: %s', error);\n      return {\n        xpaths: [],\n      };\n    }\n  }\n\n  async rectMatchesCacheFeature(feature: ElementCacheFeature): Promise<Rect> {\n    const webFeature = feature as WebElementCacheFeature;\n    const xpaths = sanitizeXpaths(webFeature.xpaths);\n\n    for (const xpath of xpaths) {\n      try {\n        const elementInfo = await this.getElementInfoByXpath(xpath);\n        if (elementInfo?.rect) {\n          const matchedRect: Rect = {\n            left: elementInfo.rect.left,\n            top: elementInfo.rect.top,\n            width: elementInfo.rect.width,\n            height: elementInfo.rect.height,\n          };\n\n          if (this.viewportSize?.dpr) {\n            matchedRect.dpr = this.viewportSize.dpr;\n          }\n\n          return matchedRect;\n        }\n      } catch (error) {\n        debugPage(\n          'rectMatchesCacheFeature failed for xpath %s: %s',\n          xpath,\n          error,\n        );\n      }\n    }\n\n    throw new Error(\n      'No matching element rect found for the provided cache feature',\n    );\n  }\n\n  async getElementsNodeTree() {\n    // ref: packages/web-integration/src/playwright/ai-fixture.ts popup logic\n    // During test execution, a new page might be opened through a connection, and the page remains confined to the same page instance.\n    // The page may go through opening, closing, and reopening; if the page is closed, evaluate may return undefined, which can lead to errors.\n    await this.waitForNavigation();\n    const scripts = await getExtraReturnLogic(true);\n    assert(scripts, 'scripts should be set before writing report in browser');\n    const startTime = Date.now();\n    const captureElementSnapshot = await this.evaluate(scripts);\n    const endTime = Date.now();\n    debugPage(`getElementsNodeTree end, cost: ${endTime - startTime}ms`);\n    return captureElementSnapshot as ElementTreeNode<ElementInfo>;\n  }\n\n  async size(): Promise<Size> {\n    if (this.viewportSize) return this.viewportSize;\n    const sizeInfo: Size = await this.evaluate(() => {\n      return {\n        width: document.documentElement.clientWidth,\n        height: document.documentElement.clientHeight,\n        dpr: window.devicePixelRatio,\n      };\n    });\n    this.viewportSize = sizeInfo;\n    return sizeInfo;\n  }\n\n  async screenshotBase64(): Promise<string> {\n    const imgType = 'jpeg';\n    const quality = 90;\n    await this.waitForNavigation();\n    const startTime = Date.now();\n    debugPage('screenshotBase64 begin');\n\n    let base64: string;\n    if (this.interfaceType === 'puppeteer') {\n      const result = await (this.underlyingPage as PuppeteerPage).screenshot({\n        type: imgType,\n        quality,\n        encoding: 'base64',\n      });\n      base64 = createImgBase64ByFormat(imgType, result);\n    } else if (this.interfaceType === 'playwright') {\n      const buffer = await (this.underlyingPage as PlaywrightPage).screenshot({\n        type: imgType,\n        quality,\n        timeout: 10 * 1000,\n      });\n      base64 = createImgBase64ByFormat(imgType, buffer.toString('base64'));\n    } else {\n      throw new Error('Unsupported page type for screenshot');\n    }\n    const endTime = Date.now();\n    debugPage(`screenshotBase64 end, cost: ${endTime - startTime}ms`);\n    return base64;\n  }\n\n  async url(): Promise<string> {\n    return this.underlyingPage.url();\n  }\n\n  describe(): string {\n    const url = this.underlyingPage.url();\n    return url || '';\n  }\n\n  get mouse() {\n    return {\n      click: async (\n        x: number,\n        y: number,\n        options?: { button?: MouseButton; count?: number },\n      ) => {\n        await this.mouse.move(x, y);\n        const { button = 'left', count = 1 } = options || {};\n        debugPage(`mouse click ${x}, ${y}, ${button}, ${count}`);\n\n        if (count === 2 && this.interfaceType === 'playwright') {\n          await (this.underlyingPage as PlaywrightPage).mouse.dblclick(x, y, {\n            button,\n          });\n        } else {\n          if (this.interfaceType === 'puppeteer') {\n            if (button === 'left' && count === 1) {\n              await (this.underlyingPage as PuppeteerPage).mouse.click(x, y);\n            } else {\n              await (this.underlyingPage as PuppeteerPage).mouse.click(x, y, {\n                button,\n                count,\n              });\n            }\n          } else if (this.interfaceType === 'playwright') {\n            (this.underlyingPage as PlaywrightPage).mouse.click(x, y, {\n              button,\n              clickCount: count,\n            });\n          }\n        }\n      },\n      wheel: async (deltaX: number, deltaY: number) => {\n        debugPage(`mouse wheel ${deltaX}, ${deltaY}`);\n        if (this.interfaceType === 'puppeteer') {\n          await (this.underlyingPage as PuppeteerPage).mouse.wheel({\n            deltaX,\n            deltaY,\n          });\n        } else if (this.interfaceType === 'playwright') {\n          await (this.underlyingPage as PlaywrightPage).mouse.wheel(\n            deltaX,\n            deltaY,\n          );\n        }\n      },\n      move: async (x: number, y: number) => {\n        this.everMoved = true;\n        debugPage(`mouse move to ${x}, ${y}`);\n        return this.underlyingPage.mouse.move(x, y);\n      },\n      drag: async (\n        from: { x: number; y: number },\n        to: { x: number; y: number },\n      ) => {\n        debugPage(\n          `begin mouse drag from ${from.x}, ${from.y} to ${to.x}, ${to.y}`,\n        );\n        await (this.underlyingPage as PlaywrightPage).mouse.move(\n          from.x,\n          from.y,\n        );\n        await sleep(200);\n        await (this.underlyingPage as PlaywrightPage).mouse.down();\n        await sleep(300);\n        await (this.underlyingPage as PlaywrightPage).mouse.move(to.x, to.y, {\n          steps: 20,\n        });\n        await sleep(500);\n        await (this.underlyingPage as PlaywrightPage).mouse.up();\n        await sleep(200);\n        debugPage(\n          `end mouse drag from ${from.x}, ${from.y} to ${to.x}, ${to.y}`,\n        );\n      },\n    };\n  }\n\n  get keyboard() {\n    return {\n      type: async (text: string) => {\n        debugPage(`keyboard type ${text}`);\n        return this.underlyingPage.keyboard.type(text, { delay: 80 });\n      },\n      press: async (\n        action:\n          | { key: KeyInput; command?: string }\n          | { key: KeyInput; command?: string }[],\n      ) => {\n        const keys = Array.isArray(action) ? action : [action];\n        debugPage('keyboard press', keys);\n        for (const k of keys) {\n          const commands = k.command ? [k.command] : [];\n          await this.underlyingPage.keyboard.down(k.key, { commands });\n        }\n        for (const k of [...keys].reverse()) {\n          await this.underlyingPage.keyboard.up(k.key);\n        }\n      },\n      down: async (key: KeyInput) => {\n        debugPage(`keyboard down ${key}`);\n        return this.underlyingPage.keyboard.down(key);\n      },\n      up: async (key: KeyInput) => {\n        debugPage(`keyboard up ${key}`);\n        return this.underlyingPage.keyboard.up(key);\n      },\n    };\n  }\n\n  async clearInput(element: ElementInfo): Promise<void> {\n    if (!element) {\n      console.warn('No element to clear input');\n      return;\n    }\n\n    const backspace = async () => {\n      await sleep(100);\n      await this.keyboard.press([{ key: 'Backspace' }]);\n    };\n\n    const isMac = process.platform === 'darwin';\n    debugPage('clearInput begin');\n    if (isMac) {\n      if (this.interfaceType === 'puppeteer') {\n        // https://github.com/segment-boneyard/nightmare/issues/810#issuecomment-452669866\n        await this.mouse.click(element.center[0], element.center[1], {\n          count: 3,\n        });\n        await backspace();\n      }\n\n      await this.mouse.click(element.center[0], element.center[1]);\n      await this.underlyingPage.keyboard.down('Meta');\n      await this.underlyingPage.keyboard.press('a');\n      await this.underlyingPage.keyboard.up('Meta');\n      await backspace();\n    } else {\n      await this.mouse.click(element.center[0], element.center[1]);\n      await this.underlyingPage.keyboard.down('Control');\n      await this.underlyingPage.keyboard.press('a');\n      await this.underlyingPage.keyboard.up('Control');\n      await backspace();\n    }\n    debugPage('clearInput end');\n  }\n\n  private everMoved = false;\n  private async moveToPointBeforeScroll(point?: Point): Promise<void> {\n    if (point) {\n      await this.mouse.move(point.left, point.top);\n    } else if (!this.everMoved) {\n      // If the mouse has never moved, move it to the center of the page\n      const size = await this.size();\n      const targetX = Math.floor(size.width / 2);\n      const targetY = Math.floor(size.height / 2);\n      await this.mouse.move(targetX, targetY);\n    }\n  }\n\n  async scrollUntilTop(startingPoint?: Point): Promise<void> {\n    await this.moveToPointBeforeScroll(startingPoint);\n    return this.mouse.wheel(0, -9999999);\n  }\n\n  async scrollUntilBottom(startingPoint?: Point): Promise<void> {\n    await this.moveToPointBeforeScroll(startingPoint);\n    return this.mouse.wheel(0, 9999999);\n  }\n\n  async scrollUntilLeft(startingPoint?: Point): Promise<void> {\n    await this.moveToPointBeforeScroll(startingPoint);\n    return this.mouse.wheel(-9999999, 0);\n  }\n\n  async scrollUntilRight(startingPoint?: Point): Promise<void> {\n    await this.moveToPointBeforeScroll(startingPoint);\n    return this.mouse.wheel(9999999, 0);\n  }\n\n  async scrollUp(distance?: number, startingPoint?: Point): Promise<void> {\n    const innerHeight = await this.evaluate(() => window.innerHeight);\n    const scrollDistance = distance || innerHeight * 0.7;\n    await this.moveToPointBeforeScroll(startingPoint);\n    return this.mouse.wheel(0, -scrollDistance);\n  }\n\n  async scrollDown(distance?: number, startingPoint?: Point): Promise<void> {\n    const innerHeight = await this.evaluate(() => window.innerHeight);\n    const scrollDistance = distance || innerHeight * 0.7;\n    await this.moveToPointBeforeScroll(startingPoint);\n    return this.mouse.wheel(0, scrollDistance);\n  }\n\n  async scrollLeft(distance?: number, startingPoint?: Point): Promise<void> {\n    const innerWidth = await this.evaluate(() => window.innerWidth);\n    const scrollDistance = distance || innerWidth * 0.7;\n    await this.moveToPointBeforeScroll(startingPoint);\n    return this.mouse.wheel(-scrollDistance, 0);\n  }\n\n  async scrollRight(distance?: number, startingPoint?: Point): Promise<void> {\n    const innerWidth = await this.evaluate(() => window.innerWidth);\n    const scrollDistance = distance || innerWidth * 0.7;\n    await this.moveToPointBeforeScroll(startingPoint);\n    return this.mouse.wheel(scrollDistance, 0);\n  }\n\n  async navigate(url: string): Promise<void> {\n    debugPage(`navigate to ${url}`);\n    if (this.interfaceType === 'puppeteer') {\n      await (this.underlyingPage as PuppeteerPage).goto(url);\n    } else if (this.interfaceType === 'playwright') {\n      await (this.underlyingPage as PlaywrightPage).goto(url);\n    } else {\n      throw new Error('Unsupported page type for navigate');\n    }\n  }\n\n  async reload(): Promise<void> {\n    debugPage('reload page');\n    if (this.interfaceType === 'puppeteer') {\n      await (this.underlyingPage as PuppeteerPage).reload();\n    } else if (this.interfaceType === 'playwright') {\n      await (this.underlyingPage as PlaywrightPage).reload();\n    } else {\n      throw new Error('Unsupported page type for reload');\n    }\n  }\n\n  async goBack(): Promise<void> {\n    debugPage('go back');\n    if (this.interfaceType === 'puppeteer') {\n      await (this.underlyingPage as PuppeteerPage).goBack();\n    } else if (this.interfaceType === 'playwright') {\n      await (this.underlyingPage as PlaywrightPage).goBack();\n    } else {\n      throw new Error('Unsupported page type for go back');\n    }\n  }\n\n  async beforeInvokeAction(name: string, param: any): Promise<void> {\n    if (this.onBeforeInvokeAction) {\n      await this.onBeforeInvokeAction(name, param);\n    }\n  }\n\n  async afterInvokeAction(name: string, param: any): Promise<void> {\n    await this.waitForNavigation();\n    await this.waitForNetworkIdle();\n    if (this.onAfterInvokeAction) {\n      await this.onAfterInvokeAction(name, param);\n    }\n  }\n\n  async destroy(): Promise<void> {}\n\n  async getContext(): Promise<UIContext> {\n    return await WebPageContextParser(this, {});\n  }\n  async swipe(\n    from: { x: number; y: number },\n    to: { x: number; y: number },\n    duration?: number,\n  ) {\n    const LONG_PRESS_THRESHOLD = 500;\n    const MIN_PRESS_THRESHOLD = 150;\n    duration = duration || 100;\n    if (duration < MIN_PRESS_THRESHOLD) {\n      duration = MIN_PRESS_THRESHOLD;\n    }\n    if (duration > LONG_PRESS_THRESHOLD) {\n      duration = LONG_PRESS_THRESHOLD;\n    }\n    debugPage(\n      `mouse swipe from ${from.x}, ${from.y} to ${to.x}, ${to.y} with duration ${duration}ms`,\n    );\n\n    if (this.interfaceType === 'puppeteer') {\n      const page = this.underlyingPage as PuppeteerPage;\n      await page.mouse.move(from.x, from.y);\n      await page.mouse.down({ button: 'left' });\n\n      const steps = 30;\n      const delay = duration / steps;\n      for (let i = 1; i <= steps; i++) {\n        const x = from.x + (to.x - from.x) * (i / steps);\n        const y = from.y + (to.y - from.y) * (i / steps);\n        await page.mouse.move(x, y);\n        await new Promise((resolve) => setTimeout(resolve, delay));\n      }\n\n      await page.mouse.up({ button: 'left' });\n    } else if (this.interfaceType === 'playwright') {\n      const page = this.underlyingPage as PlaywrightPage;\n      await page.mouse.move(from.x, from.y);\n      await page.mouse.down();\n\n      const steps = 30;\n      const delay = duration / steps;\n      for (let i = 1; i <= steps; i++) {\n        const x = from.x + (to.x - from.x) * (i / steps);\n        const y = from.y + (to.y - from.y) * (i / steps);\n        await page.mouse.move(x, y);\n        await page.waitForTimeout(delay);\n      }\n\n      await page.mouse.up({ button: 'left' });\n    }\n  }\n  async longPress(x: number, y: number, duration?: number) {\n    duration = duration || 500;\n    const LONG_PRESS_THRESHOLD = 600;\n    const MIN_PRESS_THRESHOLD = 300;\n    if (duration > LONG_PRESS_THRESHOLD) {\n      duration = LONG_PRESS_THRESHOLD;\n    }\n    if (duration < MIN_PRESS_THRESHOLD) {\n      duration = MIN_PRESS_THRESHOLD;\n    }\n    debugPage(`mouse longPress at ${x}, ${y} for ${duration}ms`);\n    if (this.interfaceType === 'puppeteer') {\n      const page = this.underlyingPage as PuppeteerPage;\n      await page.mouse.move(x, y);\n      await page.mouse.down({ button: 'left' });\n      await new Promise((res) => setTimeout(res, duration));\n      await page.mouse.up({ button: 'left' });\n    } else if (this.interfaceType === 'playwright') {\n      const page = this.underlyingPage as PlaywrightPage;\n      await page.mouse.move(x, y);\n      await page.mouse.down({ button: 'left' });\n      await page.waitForTimeout(duration);\n      await page.mouse.up({ button: 'left' });\n    }\n  }\n}\n\nexport function forceClosePopup(\n  page: PuppeteerPage | PlaywrightPage,\n  debugProfile: DebugFunction,\n) {\n  page.on('popup', async (popup) => {\n    if (!popup) {\n      console.warn('got a popup event, but the popup is not ready yet, skip');\n      return;\n    }\n    const url = await (popup as PuppeteerPage).url();\n    console.log(`Popup opened: ${url}`);\n    if (!(popup as PuppeteerPage).isClosed()) {\n      try {\n        await (popup as PuppeteerPage).close(); // Close the newly opened TAB\n      } catch (error) {\n        debugProfile(`failed to close popup ${url}, error: ${error}`);\n      }\n    } else {\n      debugProfile(`popup is already closed, skip close ${url}`);\n    }\n\n    if (!page.isClosed()) {\n      try {\n        await page.goto(url);\n      } catch (error) {\n        debugProfile(`failed to goto ${url}, error: ${error}`);\n      }\n    } else {\n      debugProfile(`page is already closed, skip goto ${url}`);\n    }\n  });\n}\n\n/**\n * Force Chrome to render select elements using base-select appearance instead of OS-native rendering.\n * This makes select elements visible in screenshots captured by Playwright/Puppeteer.\n *\n * Reference: https://developer.chrome.com/blog/a-customizable-select\n *\n * Adds a style tag with CSS rules to make all select elements use base-select appearance.\n */\nexport function forceChromeSelectRendering(\n  page: PuppeteerPage | PlaywrightPage,\n): void {\n  // Force Chrome to render select elements using base-select appearance\n  // Reference: https://developer.chrome.com/blog/a-customizable-select\n  const styleContent = `\n/* Add by Midscene because of forceChromeSelectRendering is enabled*/\nselect {\n  &, &::picker(select) {\n    appearance: base-select !important;\n  }\n}`;\n  const styleId = 'midscene-force-select-rendering';\n\n  const injectStyle = async () => {\n    try {\n      await (page as PuppeteerPage & PlaywrightPage).evaluate(\n        (id, content) => {\n          if (document.getElementById(id)) return;\n          const style = document.createElement('style');\n          style.id = id;\n          style.textContent = content;\n          document.head.appendChild(style);\n        },\n        styleId,\n        styleContent,\n      );\n      console.log(\n        'Midscene - Added base-select appearance style for select elements because of forceChromeSelectRendering is enabled',\n      );\n    } catch (err) {\n      console.log(\n        'Midscene - Failed to add base-select appearance style:',\n        err,\n      );\n    }\n  };\n\n  // Inject immediately for the current document\n  void injectStyle();\n\n  // Ensure the style is reapplied on future navigations/new documents\n  (page as PuppeteerPage & PlaywrightPage).on('load', () => {\n    void injectStyle();\n  });\n}\n"],"names":["debugPage","getDebug","sanitizeXpaths","xpaths","Array","xpath","Page","defaultActions","commonWebActionsForWebPage","customActions","pageFunction","arg","result","script","error","console","DEFAULT_WAIT_FOR_NETWORK_IDLE_CONCURRENCY","tree","treeToList","point","isOrderSensitive","elementInfosScriptContent","getElementInfosScriptContent","JSON","rect","options","center","Math","judgeResult","AiJudgeOrderSensitive","callAIWithObjectResponse","sanitized","feature","webFeature","elementInfo","matchedRect","Error","scripts","getExtraReturnLogic","assert","startTime","Date","captureElementSnapshot","endTime","sizeInfo","document","window","imgType","quality","base64","createImgBase64ByFormat","buffer","url","x","y","button","count","deltaX","deltaY","from","to","sleep","text","action","keys","k","commands","key","element","backspace","isMac","process","size","targetX","targetY","startingPoint","distance","innerHeight","scrollDistance","innerWidth","name","param","WebPageContextParser","duration","LONG_PRESS_THRESHOLD","MIN_PRESS_THRESHOLD","page","steps","delay","i","Promise","resolve","setTimeout","res","underlyingPage","interfaceType","opts","DEFAULT_WAIT_FOR_NAVIGATION_TIMEOUT","DEFAULT_WAIT_FOR_NETWORK_IDLE_TIMEOUT","forceClosePopup","debugProfile","popup","forceChromeSelectRendering","styleContent","styleId","injectStyle","id","content","style","err"],"mappings":"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"}