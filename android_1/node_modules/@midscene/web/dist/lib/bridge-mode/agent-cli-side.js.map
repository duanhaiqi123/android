{"version":3,"file":"bridge-mode/agent-cli-side.js","sources":["webpack/runtime/define_property_getters","webpack/runtime/has_own_property","webpack/runtime/make_namespace_object","../../../src/bridge-mode/agent-cli-side.ts"],"sourcesContent":["__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n        if(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n            Object.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n        }\n    }\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","import { Agent, type AgentOpt } from '@midscene/core/agent';\nimport { assert } from '@midscene/shared/utils';\nimport { commonWebActionsForWebPage } from '../web-page';\nimport type { KeyboardAction, MouseAction } from '../web-page';\nimport {\n  type BridgeConnectTabOptions,\n  BridgeEvent,\n  BridgePageType,\n  DefaultBridgeServerHost,\n  DefaultBridgeServerPort,\n  KeyboardEvent,\n  MouseEvent,\n  getBridgeServerHost,\n} from './common';\nimport { BridgeServer } from './io-server';\nimport type { ExtensionBridgePageBrowserSide } from './page-browser-side';\n\ninterface ChromeExtensionPageCliSide extends ExtensionBridgePageBrowserSide {\n  showStatusMessage: (message: string) => Promise<void>;\n}\n\nconst sleep = (ms: number) => new Promise((resolve) => setTimeout(resolve, ms));\n\n// actually, this is a proxy to the page in browser side\nexport const getBridgePageInCliSide = (options?: {\n  host?: string;\n  port?: number;\n  timeout?: number | false;\n  closeConflictServer?: boolean;\n}): ChromeExtensionPageCliSide => {\n  const host = options?.host || DefaultBridgeServerHost;\n  const port = options?.port || DefaultBridgeServerPort;\n  const server = new BridgeServer(\n    host,\n    port,\n    undefined,\n    undefined,\n    options?.closeConflictServer,\n  );\n  server.listen({\n    timeout: options?.timeout,\n  });\n  const bridgeCaller = (method: string) => {\n    return async (...args: any[]) => {\n      const response = await server.call(method, args);\n      return response;\n    };\n  };\n  const page = {\n    showStatusMessage: async (message: string) => {\n      await server.call(BridgeEvent.UpdateAgentStatus, [message]);\n    },\n  };\n\n  const proxyPage = new Proxy(page, {\n    get(target, prop, receiver) {\n      assert(typeof prop === 'string', 'prop must be a string');\n\n      if (prop === 'toJSON') {\n        return () => {\n          return {\n            interfaceType: BridgePageType,\n          };\n        };\n      }\n\n      if (prop === 'getContext') {\n        return undefined;\n      }\n\n      if (prop === 'interfaceType') {\n        return BridgePageType;\n      }\n\n      if (prop === 'actionSpace') {\n        return () => commonWebActionsForWebPage(proxyPage);\n      }\n\n      if (Object.keys(page).includes(prop)) {\n        return page[prop as keyof typeof page];\n      }\n\n      if (prop === 'mouse') {\n        const mouse: MouseAction = {\n          click: bridgeCaller(MouseEvent.Click),\n          wheel: bridgeCaller(MouseEvent.Wheel),\n          move: bridgeCaller(MouseEvent.Move),\n          drag: bridgeCaller(MouseEvent.Drag),\n        };\n        return mouse;\n      }\n\n      if (prop === 'keyboard') {\n        const keyboard: KeyboardAction = {\n          type: bridgeCaller(KeyboardEvent.Type),\n          press: bridgeCaller(KeyboardEvent.Press),\n        };\n        return keyboard;\n      }\n\n      if (prop === 'destroy') {\n        return async (...args: any[]) => {\n          try {\n            const caller = bridgeCaller('destroy');\n            await caller(...args);\n          } catch (e) {\n            // console.error('error calling destroy', e);\n          }\n          return server.close();\n        };\n      }\n\n      return bridgeCaller(prop);\n    },\n  }) as ChromeExtensionPageCliSide;\n\n  return proxyPage;\n};\n\nexport class AgentOverChromeBridge extends Agent<ChromeExtensionPageCliSide> {\n  private destroyAfterDisconnectFlag?: boolean;\n\n  constructor(\n    opts?: AgentOpt & {\n      /**\n       * Enable remote access to the bridge server.\n       * - false (default): Only localhost can connect (most secure)\n       * - true: Allow remote machines to connect (binds to 0.0.0.0)\n       */\n      allowRemoteAccess?: boolean;\n      /**\n       * Custom host to bind the bridge server to.\n       * Overrides allowRemoteAccess if specified.\n       */\n      host?: string;\n      /**\n       * Custom port for the bridge server.\n       * @default 3766\n       */\n      port?: number;\n      closeNewTabsAfterDisconnect?: boolean;\n      serverListeningTimeout?: number | false;\n      closeConflictServer?: boolean;\n    },\n  ) {\n    const host = getBridgeServerHost({\n      host: opts?.host,\n      allowRemoteAccess: opts?.allowRemoteAccess,\n    });\n    const page = getBridgePageInCliSide({\n      host,\n      port: opts?.port,\n      timeout: opts?.serverListeningTimeout,\n      closeConflictServer: opts?.closeConflictServer,\n    });\n    const originalOnTaskStartTip = opts?.onTaskStartTip;\n    super(\n      page,\n      Object.assign(opts || {}, {\n        onTaskStartTip: (tip: string) => {\n          this.page.showStatusMessage(tip);\n          if (originalOnTaskStartTip) {\n            originalOnTaskStartTip?.call(this, tip);\n          }\n        },\n      }),\n    );\n    this.destroyAfterDisconnectFlag = opts?.closeNewTabsAfterDisconnect;\n  }\n\n  async setDestroyOptionsAfterConnect() {\n    if (this.destroyAfterDisconnectFlag) {\n      this.page.setDestroyOptions({\n        closeTab: true,\n      });\n    }\n  }\n\n  async connectNewTabWithUrl(url: string, options?: BridgeConnectTabOptions) {\n    await this.page.connectNewTabWithUrl(url, options);\n    await sleep(500);\n    await this.setDestroyOptionsAfterConnect();\n  }\n\n  async getBrowserTabList() {\n    return await this.page.getBrowserTabList();\n  }\n\n  async setActiveTabId(tabId: string) {\n    return await this.page.setActiveTabId(Number.parseInt(tabId));\n  }\n\n  async connectCurrentTab(options?: BridgeConnectTabOptions) {\n    await this.page.connectCurrentTab(options);\n    await sleep(500);\n    await this.setDestroyOptionsAfterConnect();\n  }\n\n  async aiAct(prompt: string, options?: any) {\n    if (options) {\n      console.warn(\n        'the `options` parameter of aiAct is not supported in cli side',\n      );\n    }\n    return await super.aiAct(prompt);\n  }\n\n  async destroy(closeNewTabsAfterDisconnect?: boolean) {\n    if (typeof closeNewTabsAfterDisconnect === 'boolean') {\n      await this.page.setDestroyOptions({\n        closeTab: closeNewTabsAfterDisconnect,\n      });\n    }\n    await super.destroy();\n  }\n}\n"],"names":["__webpack_require__","definition","key","Object","obj","prop","Symbol","sleep","ms","Promise","resolve","setTimeout","getBridgePageInCliSide","options","host","DefaultBridgeServerHost","port","DefaultBridgeServerPort","server","BridgeServer","undefined","bridgeCaller","method","args","response","page","message","BridgeEvent","proxyPage","Proxy","target","receiver","assert","BridgePageType","commonWebActionsForWebPage","mouse","MouseEvent","keyboard","KeyboardEvent","caller","e","AgentOverChromeBridge","Agent","url","tabId","Number","prompt","console","closeNewTabsAfterDisconnect","opts","getBridgeServerHost","originalOnTaskStartTip","tip"],"mappings":"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"}