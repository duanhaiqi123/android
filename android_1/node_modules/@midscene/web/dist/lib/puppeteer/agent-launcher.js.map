{"version":3,"file":"puppeteer/agent-launcher.js","sources":["webpack/runtime/compat_get_default_export","webpack/runtime/define_property_getters","webpack/runtime/has_own_property","webpack/runtime/make_namespace_object","../../../src/puppeteer/agent-launcher.ts"],"sourcesContent":["// getDefaultExport function for compatibility with non-ESM modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};\n","__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n        if(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n            Object.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n        }\n    }\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","import { readFileSync } from 'node:fs';\nimport { getDebug } from '@midscene/shared/logger';\nimport { assert } from '@midscene/shared/utils';\n\nimport { PuppeteerAgent } from '@/puppeteer/index';\nimport type { AgentOpt, Cache, MidsceneYamlScriptWebEnv } from '@midscene/core';\nimport { DEFAULT_WAIT_FOR_NETWORK_IDLE_TIMEOUT } from '@midscene/shared/constants';\nimport puppeteer, { type Browser } from 'puppeteer';\n\nexport const defaultUA =\n  'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36';\nexport const defaultViewportWidth = 1440;\nexport const defaultViewportHeight = 768;\nexport const defaultViewportScale = process.platform === 'darwin' ? 2 : 1;\nexport const defaultWaitForNetworkIdleTimeout =\n  DEFAULT_WAIT_FOR_NETWORK_IDLE_TIMEOUT;\n\nexport function resolveAiActionContext(\n  target: MidsceneYamlScriptWebEnv,\n  preference?: Partial<Pick<AgentOpt, 'aiActionContext' | 'aiActContext'>>,\n): AgentOpt['aiActionContext'] | undefined {\n  // Prefer agent-level preference if provided; otherwise fall back to target-level context.\n  // Priority: preference.aiActContext > preference.aiActionContext (deprecated) > target.aiActionContext\n  const data =\n    preference?.aiActContext ??\n    preference?.aiActionContext ??\n    target.aiActionContext;\n  return data;\n}\n\n/**\n * Chrome arguments that may reduce browser security.\n * These should only be used in controlled testing environments.\n *\n * Security implications:\n * - `--no-sandbox`: Disables Chrome's sandbox security model\n * - `--disable-setuid-sandbox`: Disables setuid sandbox on Linux\n * - `--disable-web-security`: Allows cross-origin requests without CORS\n * - `--ignore-certificate-errors`: Ignores SSL/TLS certificate errors\n * - `--disable-features=IsolateOrigins`: Disables origin isolation\n * - `--disable-site-isolation-trials`: Disables site isolation\n * - `--allow-running-insecure-content`: Allows mixed HTTP/HTTPS content\n */\nconst DANGEROUS_ARGS = [\n  '--no-sandbox',\n  '--disable-setuid-sandbox',\n  '--disable-web-security',\n  '--ignore-certificate-errors',\n  '--disable-features=IsolateOrigins',\n  '--disable-site-isolation-trials',\n  '--allow-running-insecure-content',\n] as const;\n\n/**\n * Validates Chrome launch arguments for security concerns.\n * Emits a warning if dangerous arguments are detected.\n *\n * This function filters out arguments that are already present in baseArgs\n * to avoid warning about platform-specific defaults (e.g., --no-sandbox on non-Windows).\n *\n * @param args - Chrome launch arguments to validate\n * @param baseArgs - Base Chrome arguments already configured\n *\n * @example\n * ```typescript\n * // Will show warning for --disable-web-security\n * validateChromeArgs(['--disable-web-security', '--headless'], ['--no-sandbox']);\n *\n * // Will NOT show warning for --no-sandbox (already in baseArgs)\n * validateChromeArgs(['--no-sandbox'], ['--no-sandbox', '--headless']);\n * ```\n */\nfunction validateChromeArgs(args: string[], baseArgs: string[]): void {\n  // Filter out arguments that are already in baseArgs\n  const newArgs = args.filter(\n    (arg) =>\n      !baseArgs.some((baseArg) => {\n        // Check if arg starts with the same flag as baseArg (before '=' if present)\n        const argFlag = arg.split('=')[0];\n        const baseFlag = baseArg.split('=')[0];\n        return argFlag === baseFlag;\n      }),\n  );\n\n  const dangerousArgs = newArgs.filter((arg) =>\n    DANGEROUS_ARGS.some((dangerous) => arg.startsWith(dangerous)),\n  );\n\n  if (dangerousArgs.length > 0) {\n    console.warn(\n      `Warning: Dangerous Chrome arguments detected: ${dangerousArgs.join(', ')}.\\nThese arguments may reduce browser security. Use only in controlled testing environments.`,\n    );\n  }\n}\n\ninterface FreeFn {\n  name: string;\n  fn: () => void;\n}\n\nconst launcherDebug = getDebug('puppeteer:launcher');\n\nexport async function launchPuppeteerPage(\n  target: MidsceneYamlScriptWebEnv,\n  preference?: {\n    headed?: boolean;\n    keepWindow?: boolean;\n  },\n  browser?: Browser,\n) {\n  assert(target.url, 'url is required');\n  const freeFn: FreeFn[] = [];\n\n  // prepare the environment\n  const ua = target.userAgent || defaultUA;\n  let width = defaultViewportWidth;\n  if (target.viewportWidth) {\n    assert(\n      typeof target.viewportWidth === 'number',\n      'viewportWidth must be a number',\n    );\n    width = Number.parseInt(target.viewportWidth as unknown as string, 10);\n    assert(width > 0, `viewportWidth must be greater than 0, but got ${width}`);\n  }\n  let height = defaultViewportHeight;\n  if (target.viewportHeight) {\n    assert(\n      typeof target.viewportHeight === 'number',\n      'viewportHeight must be a number',\n    );\n    height = Number.parseInt(target.viewportHeight as unknown as string, 10);\n    assert(\n      height > 0,\n      `viewportHeight must be greater than 0, but got ${height}`,\n    );\n  }\n  let dpr = defaultViewportScale;\n  if (target.viewportScale) {\n    assert(\n      typeof target.viewportScale === 'number',\n      'viewportScale must be a number',\n    );\n    dpr = Number.parseInt(target.viewportScale as unknown as string, 10);\n    assert(dpr > 0, `viewportScale must be greater than 0, but got ${dpr}`);\n  }\n  const viewportConfig = {\n    width,\n    height,\n    deviceScaleFactor: dpr,\n  };\n\n  const headed = preference?.headed || preference?.keepWindow;\n  const windowSizeArg = `--window-size=${width},${height + (headed ? 100 : 0)}`; // add 100px for the address bar in headed mode\n  const defaultViewportConfig = headed ? null : viewportConfig;\n\n  // launch the browser\n  if (headed && process.env.CI === '1') {\n    console.warn(\n      'you are probably running headed mode in CI, this will usually fail.',\n    );\n  }\n  // do not use 'no-sandbox' on windows https://www.perplexity.ai/search/how-to-solve-this-with-nodejs-dMHpdCypRa..JA8TkQzbeQ\n  const isWindows = process.platform === 'win32';\n\n  const baseArgs = [\n    ...(isWindows ? [] : ['--no-sandbox', '--disable-setuid-sandbox']),\n    '--disable-features=HttpsFirstBalancedModeAutoEnable',\n    '--disable-features=PasswordLeakDetection',\n    '--disable-save-password-bubble',\n    `--user-agent=\"${ua}\"`,\n    windowSizeArg,\n  ];\n\n  // Merge custom Chrome arguments\n  let args = baseArgs;\n  if (target.chromeArgs && target.chromeArgs.length > 0) {\n    validateChromeArgs(target.chromeArgs, baseArgs);\n\n    // Custom args come after base args, allowing them to override defaults\n    args = [...baseArgs, ...target.chromeArgs];\n    launcherDebug(\n      'Merging custom Chrome arguments',\n      target.chromeArgs,\n      'Final args',\n      args,\n    );\n  }\n\n  launcherDebug(\n    'launching browser with viewport, headed',\n    headed,\n    'viewport',\n    viewportConfig,\n    'args',\n    args,\n    'preference',\n    preference,\n  );\n  let browserInstance = browser;\n  if (!browserInstance) {\n    browserInstance = await puppeteer.launch({\n      headless: !preference?.headed,\n      defaultViewport: defaultViewportConfig,\n      args,\n      acceptInsecureCerts: target.acceptInsecureCerts,\n    });\n    freeFn.push({\n      name: 'puppeteer_browser',\n      fn: () => {\n        if (!preference?.keepWindow) {\n          if (isWindows) {\n            setTimeout(() => {\n              browserInstance?.close();\n            }, 800);\n          } else {\n            browserInstance?.close();\n          }\n        }\n      },\n    });\n  }\n  const page = await browserInstance.newPage();\n\n  if (target.cookie) {\n    const cookieFileContent = readFileSync(target.cookie, 'utf-8');\n    await browserInstance.setCookie(...JSON.parse(cookieFileContent));\n  }\n\n  if (ua) {\n    await page.setUserAgent(ua);\n  }\n\n  if (viewportConfig) {\n    await page.setViewport(viewportConfig);\n  }\n\n  const waitForNetworkIdleTimeout =\n    typeof target.waitForNetworkIdle?.timeout === 'number'\n      ? target.waitForNetworkIdle.timeout\n      : defaultWaitForNetworkIdleTimeout;\n\n  try {\n    launcherDebug('goto', target.url);\n    await page.goto(target.url);\n    if (waitForNetworkIdleTimeout > 0) {\n      launcherDebug('waitForNetworkIdle', waitForNetworkIdleTimeout);\n      await page.waitForNetworkIdle({\n        timeout: waitForNetworkIdleTimeout,\n      });\n    }\n  } catch (e) {\n    if (\n      typeof target.waitForNetworkIdle?.continueOnNetworkIdleError ===\n        'boolean' &&\n      !target.waitForNetworkIdle?.continueOnNetworkIdleError\n    ) {\n      const newError = new Error(`failed to wait for network idle: ${e}`, {\n        cause: e,\n      });\n      throw newError;\n    }\n    const newMessage = `failed to wait for network idle after ${waitForNetworkIdleTimeout}ms, but the script will continue.`;\n    console.warn(newMessage);\n  }\n\n  return { page, freeFn };\n}\n\nexport async function puppeteerAgentForTarget(\n  target: MidsceneYamlScriptWebEnv,\n  preference?: {\n    headed?: boolean;\n    keepWindow?: boolean;\n  } & Partial<\n    Pick<\n      AgentOpt,\n      | 'testId'\n      | 'groupName'\n      | 'groupDescription'\n      | 'generateReport'\n      | 'autoPrintReportMsg'\n      | 'reportFileName'\n      | 'replanningCycleLimit'\n      | 'cache'\n      | 'aiActionContext'\n    >\n  >,\n  browser?: Browser,\n) {\n  const { page, freeFn } = await launchPuppeteerPage(\n    target,\n    preference,\n    browser,\n  );\n  const aiActContext = resolveAiActionContext(target, preference);\n\n  const { aiActionContext, ...preferenceToUse } = preference ?? {};\n\n  // prepare Midscene agent\n  const agent = new PuppeteerAgent(page, {\n    ...preferenceToUse,\n    aiActContext,\n    forceSameTabNavigation:\n      typeof target.forceSameTabNavigation !== 'undefined'\n        ? target.forceSameTabNavigation\n        : true, // true for default in yaml script\n  });\n\n  freeFn.push({\n    name: 'midscene_puppeteer_agent',\n    fn: () => agent.destroy(),\n  });\n\n  return { agent, freeFn };\n}\n"],"names":["__webpack_require__","module","getter","definition","key","Object","obj","prop","Symbol","defaultUA","defaultViewportWidth","defaultViewportHeight","defaultViewportScale","process","defaultWaitForNetworkIdleTimeout","DEFAULT_WAIT_FOR_NETWORK_IDLE_TIMEOUT","resolveAiActionContext","target","preference","data","DANGEROUS_ARGS","validateChromeArgs","args","baseArgs","newArgs","arg","baseArg","argFlag","baseFlag","dangerousArgs","dangerous","console","launcherDebug","getDebug","launchPuppeteerPage","browser","assert","freeFn","ua","width","Number","height","dpr","viewportConfig","headed","windowSizeArg","defaultViewportConfig","isWindows","browserInstance","puppeteer","setTimeout","page","cookieFileContent","readFileSync","JSON","waitForNetworkIdleTimeout","e","newError","Error","newMessage","puppeteerAgentForTarget","aiActContext","aiActionContext","preferenceToUse","agent","PuppeteerAgent"],"mappings":"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"}