"use strict";
var __webpack_require__ = {};
(()=>{
    __webpack_require__.d = (exports1, definition)=>{
        for(var key in definition)if (__webpack_require__.o(definition, key) && !__webpack_require__.o(exports1, key)) Object.defineProperty(exports1, key, {
            enumerable: true,
            get: definition[key]
        });
    };
})();
(()=>{
    __webpack_require__.o = (obj, prop)=>Object.prototype.hasOwnProperty.call(obj, prop);
})();
(()=>{
    __webpack_require__.r = (exports1)=>{
        if ('undefined' != typeof Symbol && Symbol.toStringTag) Object.defineProperty(exports1, Symbol.toStringTag, {
            value: 'Module'
        });
        Object.defineProperty(exports1, '__esModule', {
            value: true
        });
    };
})();
var __webpack_exports__ = {};
__webpack_require__.r(__webpack_exports__);
__webpack_require__.d(__webpack_exports__, {
    modelFamilyToVLConfig: ()=>modelFamilyToVLConfig,
    parseOpenaiSdkConfig: ()=>parseOpenaiSdkConfig,
    legacyConfigToModelFamily: ()=>legacyConfigToModelFamily,
    decideModelConfigFromIntentConfig: ()=>decideModelConfigFromIntentConfig
});
const external_constants_js_namespaceObject = require("./constants.js");
const external_types_js_namespaceObject = require("./types.js");
const external_logger_js_namespaceObject = require("../logger.js");
const external_utils_js_namespaceObject = require("../utils.js");
const external_helper_js_namespaceObject = require("./helper.js");
const external_init_debug_js_namespaceObject = require("./init-debug.js");
const KEYS_MAP = {
    insight: external_constants_js_namespaceObject.INSIGHT_MODEL_CONFIG_KEYS,
    planning: external_constants_js_namespaceObject.PLANNING_MODEL_CONFIG_KEYS,
    default: external_constants_js_namespaceObject.DEFAULT_MODEL_CONFIG_KEYS
};
const modelFamilyToVLConfig = (modelFamily)=>{
    if (!modelFamily) return {
        vlMode: void 0,
        uiTarsVersion: void 0
    };
    if ('vlm-ui-tars' === modelFamily) return {
        vlMode: 'vlm-ui-tars',
        uiTarsVersion: external_types_js_namespaceObject.UITarsModelVersion.V1_0
    };
    if ('vlm-ui-tars-doubao' === modelFamily || 'vlm-ui-tars-doubao-1.5' === modelFamily) return {
        vlMode: 'vlm-ui-tars',
        uiTarsVersion: external_types_js_namespaceObject.UITarsModelVersion.DOUBAO_1_5_20B
    };
    if (!external_types_js_namespaceObject.MODEL_FAMILY_VALUES.includes(modelFamily)) throw new Error(`Invalid MIDSCENE_MODEL_FAMILY value: ${modelFamily}`);
    return {
        vlMode: modelFamily,
        uiTarsVersion: void 0
    };
};
const legacyConfigToModelFamily = (provider)=>{
    const isDoubao = provider[external_types_js_namespaceObject.MIDSCENE_USE_DOUBAO_VISION];
    const isQwen = provider[external_types_js_namespaceObject.MIDSCENE_USE_QWEN_VL];
    const isQwen3 = provider[external_types_js_namespaceObject.MIDSCENE_USE_QWEN3_VL];
    const isUiTars = provider[external_types_js_namespaceObject.MIDSCENE_USE_VLM_UI_TARS];
    const isGemini = provider[external_types_js_namespaceObject.MIDSCENE_USE_GEMINI];
    const enabledModes = [
        isDoubao && external_types_js_namespaceObject.MIDSCENE_USE_DOUBAO_VISION,
        isQwen && external_types_js_namespaceObject.MIDSCENE_USE_QWEN_VL,
        isQwen3 && external_types_js_namespaceObject.MIDSCENE_USE_QWEN3_VL,
        isUiTars && external_types_js_namespaceObject.MIDSCENE_USE_VLM_UI_TARS,
        isGemini && external_types_js_namespaceObject.MIDSCENE_USE_GEMINI
    ].filter(Boolean);
    if (enabledModes.length > 1) throw new Error(`Only one vision mode can be enabled at a time. Currently enabled modes: ${enabledModes.join(', ')}. Please disable all but one mode.`);
    if (isQwen3) return 'qwen3-vl';
    if (isQwen) return 'qwen2.5-vl';
    if (isDoubao) return 'doubao-vision';
    if (isGemini) return 'gemini';
    if (isUiTars) if ('1' === isUiTars) return 'vlm-ui-tars';
    else if ('DOUBAO' === isUiTars || 'DOUBAO-1.5' === isUiTars) return 'vlm-ui-tars-doubao-1.5';
    else return 'vlm-ui-tars-doubao';
};
const parseOpenaiSdkConfig = ({ keys, provider, useLegacyLogic = false })=>{
    (0, external_init_debug_js_namespaceObject.initDebugConfig)();
    const debugLog = (0, external_logger_js_namespaceObject.getDebug)('ai:config');
    debugLog('enter parseOpenaiSdkConfig with keys:', keys);
    const legacyAPIKey = useLegacyLogic ? provider[external_types_js_namespaceObject.OPENAI_API_KEY] : void 0;
    const legacyBaseURL = useLegacyLogic ? provider[external_types_js_namespaceObject.OPENAI_BASE_URL] : void 0;
    const legacySocksProxy = useLegacyLogic ? provider[external_types_js_namespaceObject.MIDSCENE_OPENAI_SOCKS_PROXY] : void 0;
    const legacyHttpProxy = useLegacyLogic ? provider[external_types_js_namespaceObject.MIDSCENE_OPENAI_HTTP_PROXY] : void 0;
    const legacyOpenaiExtraConfig = useLegacyLogic ? provider[external_types_js_namespaceObject.MIDSCENE_OPENAI_INIT_CONFIG_JSON] : void 0;
    const legacyModelFamily = useLegacyLogic ? legacyConfigToModelFamily(provider) : void 0;
    const modelFamilyRaw = provider[keys.modelFamily] || legacyModelFamily;
    const openaiApiKey = provider[keys.openaiApiKey] || legacyAPIKey;
    const openaiBaseURL = provider[keys.openaiBaseURL] || legacyBaseURL;
    const socksProxy = provider[keys.socksProxy] || legacySocksProxy;
    const httpProxy = provider[keys.httpProxy] || legacyHttpProxy;
    const modelName = provider[keys.modelName];
    const openaiExtraConfigStr = provider[keys.openaiExtraConfig];
    const openaiExtraConfig = (0, external_helper_js_namespaceObject.parseJson)(keys.openaiExtraConfig, openaiExtraConfigStr || legacyOpenaiExtraConfig);
    const temperature = provider[keys.temperature] ? Number(provider[keys.temperature]) : 0;
    const { vlMode, uiTarsVersion } = modelFamilyToVLConfig(modelFamilyRaw);
    const getModelDescription = (vlMode, uiTarsVersion)=>{
        if (vlMode) if (uiTarsVersion) return `UI-TARS=${uiTarsVersion}`;
        else return `${vlMode} mode`;
        return '';
    };
    const modelDescription = getModelDescription(vlMode, uiTarsVersion);
    return {
        socksProxy,
        httpProxy,
        vlModeRaw: vlMode,
        openaiBaseURL,
        openaiApiKey,
        openaiExtraConfig,
        vlMode,
        uiTarsModelVersion: uiTarsVersion,
        modelName: modelName,
        modelDescription,
        intent: '-',
        timeout: provider[keys.timeout] ? Number(provider[keys.timeout]) : void 0,
        temperature
    };
};
const decideModelConfigFromIntentConfig = (intent, configMap)=>{
    const debugLog = (0, external_logger_js_namespaceObject.getDebug)('ai:config');
    debugLog('will decideModelConfig base on agent.modelConfig()', intent, (0, external_helper_js_namespaceObject.maskConfig)(configMap));
    const keysForFn = KEYS_MAP[intent];
    const modelName = configMap[keysForFn.modelName];
    if (!modelName) return void debugLog('no modelName found for intent', intent);
    const finalResult = parseOpenaiSdkConfig({
        keys: keysForFn,
        provider: configMap,
        useLegacyLogic: 'default' === intent
    });
    finalResult.intent = intent;
    debugLog('decideModelConfig result by agent.modelConfig() with intent', intent, (0, external_helper_js_namespaceObject.maskConfig)({
        ...finalResult
    }));
    (0, external_utils_js_namespaceObject.assert)(finalResult.openaiBaseURL, `failed to get base URL of model (intent=${intent}). See https://midscenejs.com/model-strategy`);
    if (!finalResult.modelName) console.warn(`modelName is not set for intent ${intent}, this may cause unexpected behavior. See https://midscenejs.com/model-strategy`);
    return finalResult;
};
exports.decideModelConfigFromIntentConfig = __webpack_exports__.decideModelConfigFromIntentConfig;
exports.legacyConfigToModelFamily = __webpack_exports__.legacyConfigToModelFamily;
exports.modelFamilyToVLConfig = __webpack_exports__.modelFamilyToVLConfig;
exports.parseOpenaiSdkConfig = __webpack_exports__.parseOpenaiSdkConfig;
for(var __rspack_i in __webpack_exports__)if (-1 === [
    "decideModelConfigFromIntentConfig",
    "legacyConfigToModelFamily",
    "modelFamilyToVLConfig",
    "parseOpenaiSdkConfig"
].indexOf(__rspack_i)) exports[__rspack_i] = __webpack_exports__[__rspack_i];
Object.defineProperty(exports, '__esModule', {
    value: true
});
