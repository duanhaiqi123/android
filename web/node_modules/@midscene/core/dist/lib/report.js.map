{"version":3,"file":"report.js","sources":["webpack/runtime/define_property_getters","webpack/runtime/has_own_property","webpack/runtime/make_namespace_object","../../src/report.ts"],"sourcesContent":["__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n        if(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n            Object.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n        }\n    }\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","import * as fs from 'node:fs';\nimport * as path from 'node:path';\nimport { getMidsceneRunSubDir } from '@midscene/shared/common';\nimport { getReportFileName } from './agent';\nimport type { ReportFileWithAttributes } from './types';\nimport { getReportTpl, reportHTMLContent } from './utils';\n\nexport class ReportMergingTool {\n  private reportInfos: ReportFileWithAttributes[] = [];\n  public append(reportInfo: ReportFileWithAttributes) {\n    this.reportInfos.push(reportInfo);\n  }\n  public clear() {\n    this.reportInfos = [];\n  }\n  private extractScriptContent(filePath: string): string {\n    // Regular expression to match content between script tags\n    // Requires newline before <script and </script>\n    const scriptRegex =\n      /\\n<script type=\"midscene_web_dump\" type=\"application\\/json\"[^>]*>([\\s\\S]*?)\\n<\\/script>/;\n\n    const fileContent = fs.readFileSync(filePath, 'utf-8');\n    const match = scriptRegex.exec(fileContent);\n\n    return match ? match[1].trim() : '';\n  }\n\n  public mergeReports(\n    reportFileName: 'AUTO' | string = 'AUTO', // user custom report filename, save into midscene report dir if undefined\n    opts?: {\n      rmOriginalReports?: boolean; // whether to remove origin report files\n      overwrite?: boolean; // if output filepath specified, throw an error when overwrite = true, otherwise overwrite the file\n    },\n  ): string | null {\n    if (this.reportInfos.length <= 1) {\n      console.log('Not enough report to merge');\n      return null;\n    }\n    opts = Object.assign(\n      {\n        rmOriginalReports: false,\n        overwrite: false,\n      },\n      opts || {},\n    );\n    const { rmOriginalReports, overwrite } = opts;\n    let outputFilePath;\n    const targetDir = `${getMidsceneRunSubDir('report')}`;\n    if (reportFileName === 'AUTO') {\n      outputFilePath = path.resolve(\n        targetDir,\n        `${getReportFileName('merged-report')}.html`,\n      );\n    } else {\n      // user specified a output filepath\n      outputFilePath = path.resolve(targetDir, `${reportFileName}.html`);\n      if (fs.existsSync(outputFilePath) && !overwrite) {\n        throw Error(\n          `report file already existed: ${outputFilePath}\\nset override to true to overwrite this file.`,\n        );\n      } else if (fs.existsSync(outputFilePath) && overwrite) {\n        fs.unlinkSync(outputFilePath);\n      }\n    }\n\n    console.log(\n      `Start merging ${this.reportInfos.length} reports...\\nCreating template file...`,\n    );\n\n    try {\n      // Write template\n      fs.appendFileSync(outputFilePath, getReportTpl());\n\n      // Process all reports one by one\n      for (let i = 0; i < this.reportInfos.length; i++) {\n        const reportInfo = this.reportInfos[i];\n        console.log(`Processing report ${i + 1}/${this.reportInfos.length}`);\n\n        const dumpString = this.extractScriptContent(reportInfo.reportFilePath);\n        const reportAttributes = reportInfo.reportAttributes;\n\n        const reportHtmlStr = `${reportHTMLContent(\n          {\n            dumpString,\n            attributes: {\n              playwright_test_duration: reportAttributes.testDuration,\n              playwright_test_status: reportAttributes.testStatus,\n              playwright_test_title: reportAttributes.testTitle,\n              playwright_test_id: reportAttributes.testId,\n              playwright_test_description: reportAttributes.testDescription,\n            },\n          },\n          undefined,\n          undefined,\n          false,\n        )}\\n`; // use existed function to achieve report script content\n\n        fs.appendFileSync(outputFilePath, reportHtmlStr);\n      }\n\n      console.log(`Successfully merged new report: ${outputFilePath}`);\n\n      // Remove original reports if needed\n      if (rmOriginalReports) {\n        for (const info of this.reportInfos) {\n          try {\n            fs.unlinkSync(info.reportFilePath);\n          } catch (error) {\n            console.error(\n              `Error deleting report ${info.reportFilePath}:`,\n              error,\n            );\n          }\n        }\n        console.log(`Removed ${this.reportInfos.length} original reports`);\n      }\n      return outputFilePath;\n    } catch (error) {\n      console.error('Error in mergeReports:', error);\n      throw error;\n    }\n  }\n}\n"],"names":["__webpack_require__","definition","key","Object","obj","prop","Symbol","ReportMergingTool","reportInfo","filePath","scriptRegex","fileContent","fs","match","reportFileName","opts","console","rmOriginalReports","overwrite","outputFilePath","targetDir","getMidsceneRunSubDir","path","getReportFileName","Error","getReportTpl","i","dumpString","reportAttributes","reportHtmlStr","reportHTMLContent","undefined","info","error"],"mappings":"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"}