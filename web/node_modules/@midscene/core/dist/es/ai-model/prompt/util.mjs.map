{"version":3,"file":"ai-model/prompt/util.mjs","sources":["../../../../src/ai-model/prompt/util.ts"],"sourcesContent":["import type { BaseElement, ElementTreeNode, Size, UIContext } from '@/types';\nimport { NodeType } from '@midscene/shared/constants';\nimport { assert } from '@midscene/shared/utils';\n\nexport function describeSize(size: Size) {\n  return `${size.width} x ${size.height}`;\n}\n\nexport function describeElement(\n  elements: (Pick<BaseElement, 'rect' | 'content'> & { id: string })[],\n) {\n  const sliceLength = 80;\n  return elements\n    .map((item) =>\n      [\n        item.id,\n        item.rect.left,\n        item.rect.top,\n        item.rect.left + item.rect.width,\n        item.rect.top + item.rect.height,\n        item.content.length > sliceLength\n          ? `${item.content.slice(0, sliceLength)}...`\n          : item.content,\n      ].join(', '),\n    )\n    .join('\\n');\n}\nexport const distanceThreshold = 16;\n\n// export function elementByPositionWithElementInfo(\n//   treeRoot: ElementTreeNode<BaseElement>,\n//   position: {\n//     x: number;\n//     y: number;\n//   },\n//   options?: {\n//     requireStrictDistance?: boolean;\n//     filterPositionElements?: boolean;\n//   },\n// ) {\n//   const requireStrictDistance = options?.requireStrictDistance ?? true;\n//   const filterPositionElements = options?.filterPositionElements ?? false;\n\n//   assert(typeof position !== 'undefined', 'position is required for query');\n\n//   const matchingElements: BaseElement[] = [];\n\n//   function dfs(node: ElementTreeNode<BaseElement>) {\n//     if (node?.node) {\n//       const item = node.node;\n//       if (\n//         item.rect.left <= position.x &&\n//         position.x <= item.rect.left + item.rect.width &&\n//         item.rect.top <= position.y &&\n//         position.y <= item.rect.top + item.rect.height\n//       ) {\n//         if (\n//           !(\n//             filterPositionElements &&\n//             item.attributes?.nodeType === NodeType.POSITION\n//           ) &&\n//           item.isVisible\n//         ) {\n//           matchingElements.push(item);\n//         }\n//       }\n//     }\n\n//     for (const child of node.children) {\n//       dfs(child);\n//     }\n//   }\n\n//   dfs(treeRoot);\n\n//   if (matchingElements.length === 0) {\n//     return undefined;\n//   }\n\n//   // Find the smallest element by area\n//   const element = matchingElements.reduce((smallest, current) => {\n//     const smallestArea = smallest.rect.width * smallest.rect.height;\n//     const currentArea = current.rect.width * current.rect.height;\n//     return currentArea < smallestArea ? current : smallest;\n//   });\n\n//   const distanceToCenter = distance(\n//     { x: element.center[0], y: element.center[1] },\n//     position,\n//   );\n\n//   if (requireStrictDistance) {\n//     return distanceToCenter <= distanceThreshold ? element : undefined;\n//   }\n\n//   return element;\n// }\n\nexport function distance(\n  point1: { x: number; y: number },\n  point2: { x: number; y: number },\n) {\n  return Math.sqrt((point1.x - point2.x) ** 2 + (point1.y - point2.y) ** 2);\n}\n\nexport const samplePageDescription = `\nAnd the page is described as follows:\n====================\nThe size of the page: 1280 x 720\nSome of the elements are marked with a rectangle in the screenshot corresponding to the markerId, some are not.\n\nDescription of all the elements in screenshot:\n<div id=\"969f1637\" markerId=\"1\" left=\"100\" top=\"100\" width=\"100\" height=\"100\"> // The markerId indicated by the rectangle label in the screenshot\n  <h4 id=\"b211ecb2\" markerId=\"5\" left=\"150\" top=\"150\" width=\"90\" height=\"60\">\n    The username is accepted\n  </h4>\n  ...many more\n</div>\n====================\n`;\n\nexport async function describeUserPage(context: UIContext) {\n  return `The size of the page: ${describeSize(context.size)}`;\n}\n"],"names":["describeSize","size","describeElement","elements","sliceLength","item","distanceThreshold","distance","point1","point2","Math","samplePageDescription","describeUserPage","context"],"mappings":"AAIO,SAASA,aAAaC,IAAU;IACrC,OAAO,GAAGA,KAAK,KAAK,CAAC,GAAG,EAAEA,KAAK,MAAM,EAAE;AACzC;AAEO,SAASC,gBACdC,QAAoE;IAEpE,MAAMC,cAAc;IACpB,OAAOD,SACJ,GAAG,CAAC,CAACE,OACJ;YACEA,KAAK,EAAE;YACPA,KAAK,IAAI,CAAC,IAAI;YACdA,KAAK,IAAI,CAAC,GAAG;YACbA,KAAK,IAAI,CAAC,IAAI,GAAGA,KAAK,IAAI,CAAC,KAAK;YAChCA,KAAK,IAAI,CAAC,GAAG,GAAGA,KAAK,IAAI,CAAC,MAAM;YAChCA,KAAK,OAAO,CAAC,MAAM,GAAGD,cAClB,GAAGC,KAAK,OAAO,CAAC,KAAK,CAAC,GAAGD,aAAa,GAAG,CAAC,GAC1CC,KAAK,OAAO;SACjB,CAAC,IAAI,CAAC,OAER,IAAI,CAAC;AACV;AACO,MAAMC,oBAAoB;AAuE1B,SAASC,SACdC,MAAgC,EAChCC,MAAgC;IAEhC,OAAOC,KAAK,IAAI,CAAEF,AAAAA,CAAAA,OAAO,CAAC,GAAGC,OAAO,CAAC,AAAD,KAAM,IAAKD,AAAAA,CAAAA,OAAO,CAAC,GAAGC,OAAO,CAAC,AAAD,KAAM;AACzE;AAEO,MAAME,wBAAwB,CAAC;;;;;;;;;;;;;;AActC,CAAC;AAEM,eAAeC,iBAAiBC,OAAkB;IACvD,OAAO,CAAC,sBAAsB,EAAEb,aAAaa,QAAQ,IAAI,GAAG;AAC9D"}