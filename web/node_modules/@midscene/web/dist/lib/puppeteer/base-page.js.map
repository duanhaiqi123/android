{"version":3,"file":"puppeteer/base-page.js","sources":["webpack/runtime/define_property_getters","webpack/runtime/has_own_property","webpack/runtime/make_namespace_object","../../../src/puppeteer/base-page.ts"],"sourcesContent":["__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n        if(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n            Object.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n        }\n    }\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","import { type WebPageAgentOpt, WebPageContextParser } from '@/web-element';\nimport type {\n  DeviceAction,\n  ElementCacheFeature,\n  ElementTreeNode,\n  Point,\n  Rect,\n  Size,\n  UIContext,\n} from '@midscene/core';\nimport {\n  AiJudgeOrderSensitive,\n  callAIWithObjectResponse,\n} from '@midscene/core/ai-model';\nimport type { AbstractInterface } from '@midscene/core/device';\nimport { sleep } from '@midscene/core/utils';\nimport {\n  DEFAULT_WAIT_FOR_NAVIGATION_TIMEOUT,\n  DEFAULT_WAIT_FOR_NETWORK_IDLE_CONCURRENCY,\n  DEFAULT_WAIT_FOR_NETWORK_IDLE_TIMEOUT,\n} from '@midscene/shared/constants';\nimport type { IModelConfig } from '@midscene/shared/env';\nimport type { ElementInfo } from '@midscene/shared/extractor';\nimport { treeToList } from '@midscene/shared/extractor';\nimport { createImgBase64ByFormat } from '@midscene/shared/img';\nimport { type DebugFunction, getDebug } from '@midscene/shared/logger';\nimport {\n  getElementInfosScriptContent,\n  getExtraReturnLogic,\n} from '@midscene/shared/node';\nimport { assert } from '@midscene/shared/utils';\nimport type { Page as PlaywrightPage } from 'playwright';\nimport type { CDPSession, Protocol, Page as PuppeteerPage } from 'puppeteer';\nimport {\n  type KeyInput,\n  type MouseButton,\n  commonWebActionsForWebPage,\n} from '../web-page';\n\nexport const debugPage = getDebug('web:page');\n\ntype WebElementCacheFeature = ElementCacheFeature & {\n  xpaths?: string[];\n};\n\nconst sanitizeXpaths = (xpaths: unknown): string[] => {\n  if (!Array.isArray(xpaths)) {\n    return [];\n  }\n\n  return xpaths.filter(\n    (xpath): xpath is string => typeof xpath === 'string' && xpath.length > 0,\n  );\n};\n\nexport class Page<\n  AgentType extends 'puppeteer' | 'playwright',\n  InterfaceType extends PuppeteerPage | PlaywrightPage,\n> implements AbstractInterface\n{\n  underlyingPage: InterfaceType;\n  protected waitForNavigationTimeout: number;\n  protected waitForNetworkIdleTimeout: number;\n  private viewportSize?: Size;\n  private onBeforeInvokeAction?: AbstractInterface['beforeInvokeAction'];\n  private onAfterInvokeAction?: AbstractInterface['afterInvokeAction'];\n  private customActions?: DeviceAction<any>[];\n  private enableTouchEventsInActionSpace: boolean;\n  private puppeteerFileChooserSession?: CDPSession;\n  private puppeteerFileChooserHandler?: (\n    event: Protocol.Page.FileChooserOpenedEvent,\n  ) => Promise<void>;\n  interfaceType: AgentType;\n\n  actionSpace(): DeviceAction[] {\n    const defaultActions = commonWebActionsForWebPage(\n      this,\n      this.enableTouchEventsInActionSpace,\n    );\n    const customActions = this.customActions || [];\n    return [...defaultActions, ...customActions];\n  }\n\n  private async evaluate<R>(\n    pageFunction: string | ((...args: any[]) => R | Promise<R>),\n    arg?: any,\n  ): Promise<R> {\n    let result: R;\n    debugPage('evaluate function begin');\n    if (this.interfaceType === 'puppeteer') {\n      result = await (this.underlyingPage as PuppeteerPage).evaluate(\n        pageFunction,\n        arg,\n      );\n    } else {\n      result = await (this.underlyingPage as PlaywrightPage).evaluate(\n        pageFunction,\n        arg,\n      );\n    }\n    debugPage('evaluate function end');\n    return result;\n  }\n\n  constructor(\n    underlyingPage: InterfaceType,\n    interfaceType: AgentType,\n    opts?: WebPageAgentOpt,\n  ) {\n    this.underlyingPage = underlyingPage;\n    this.interfaceType = interfaceType;\n    this.waitForNavigationTimeout =\n      opts?.waitForNavigationTimeout ?? DEFAULT_WAIT_FOR_NAVIGATION_TIMEOUT;\n    this.waitForNetworkIdleTimeout =\n      opts?.waitForNetworkIdleTimeout ?? DEFAULT_WAIT_FOR_NETWORK_IDLE_TIMEOUT;\n    this.onBeforeInvokeAction = opts?.beforeInvokeAction;\n    this.onAfterInvokeAction = opts?.afterInvokeAction;\n    this.customActions = opts?.customActions;\n    this.enableTouchEventsInActionSpace =\n      opts?.enableTouchEventsInActionSpace ?? false;\n  }\n\n  async evaluateJavaScript<T = any>(script: string): Promise<T> {\n    return this.evaluate(script);\n  }\n\n  async waitForNavigation() {\n    if (this.waitForNavigationTimeout === 0) {\n      debugPage('waitForNavigation timeout is 0, skip waiting');\n      return;\n    }\n\n    // issue: https://github.com/puppeteer/puppeteer/issues/3323\n    if (\n      this.interfaceType === 'puppeteer' ||\n      this.interfaceType === 'playwright'\n    ) {\n      debugPage('waitForNavigation begin');\n      debugPage(`waitForNavigation timeout: ${this.waitForNavigationTimeout}`);\n      try {\n        await (this.underlyingPage as PuppeteerPage).waitForSelector('html', {\n          timeout: this.waitForNavigationTimeout,\n        });\n      } catch (error) {\n        // Ignore timeout error, continue execution\n        console.warn(\n          '[midscene:warning] Waiting for the \"navigation\" has timed out, but Midscene will continue execution. Please check https://midscenejs.com/faq.html#customize-the-network-timeout for more information on customizing the network timeout',\n        );\n      }\n      debugPage('waitForNavigation end');\n    }\n  }\n\n  async waitForNetworkIdle(): Promise<void> {\n    if (this.interfaceType === 'puppeteer') {\n      if (this.waitForNetworkIdleTimeout === 0) {\n        debugPage('waitForNetworkIdle timeout is 0, skip waiting');\n        return;\n      }\n\n      try {\n        await (this.underlyingPage as PuppeteerPage).waitForNetworkIdle({\n          idleTime: 200,\n          concurrency: DEFAULT_WAIT_FOR_NETWORK_IDLE_CONCURRENCY,\n          timeout: this.waitForNetworkIdleTimeout,\n        });\n      } catch (error) {\n        // Ignore timeout error, continue execution\n        console.warn(\n          '[midscene:warning] Waiting for the \"network idle\" has timed out, but Midscene will continue execution. Please check https://midscenejs.com/faq.html#customize-the-network-timeout for more information on customizing the network timeout',\n        );\n      }\n    } else {\n      // TODO: implement playwright waitForNetworkIdle\n    }\n  }\n\n  // @deprecated\n  async getElementsInfo() {\n    // const scripts = await getExtraReturnLogic();\n    // const captureElementSnapshot = await this.evaluate(scripts);\n    // return captureElementSnapshot as ElementInfo[];\n    await this.waitForNavigation();\n    debugPage('getElementsInfo begin');\n    const tree = await this.getElementsNodeTree();\n    debugPage('getElementsInfo end');\n    return treeToList(tree);\n  }\n\n  private async getXpathsByPoint(point: Point, isOrderSensitive: boolean) {\n    const elementInfosScriptContent = getElementInfosScriptContent();\n\n    return this.evaluateJavaScript(\n      `${elementInfosScriptContent}midscene_element_inspector.getXpathsByPoint({left: ${point.left}, top: ${point.top}}, ${isOrderSensitive})`,\n    );\n  }\n\n  private async getElementInfoByXpath(xpath: string) {\n    const elementInfosScriptContent = getElementInfosScriptContent();\n\n    return this.evaluateJavaScript(\n      `${elementInfosScriptContent}midscene_element_inspector.getElementInfoByXpath(${JSON.stringify(xpath)})`,\n    );\n  }\n\n  async cacheFeatureForRect(\n    rect: Rect,\n    options?: {\n      targetDescription?: string;\n      modelConfig?: IModelConfig;\n    },\n  ): Promise<ElementCacheFeature> {\n    const center: Point = {\n      left: Math.floor(rect.left + rect.width / 2),\n      top: Math.floor(rect.top + rect.height / 2),\n    };\n\n    try {\n      // Determine isOrderSensitive\n      let isOrderSensitive = false;\n      if (options?.targetDescription && options?.modelConfig) {\n        try {\n          const judgeResult = await AiJudgeOrderSensitive(\n            options.targetDescription,\n            callAIWithObjectResponse,\n            options.modelConfig,\n          );\n          isOrderSensitive = judgeResult.isOrderSensitive;\n          debugPage(\n            'judged isOrderSensitive=%s for description: %s',\n            isOrderSensitive,\n            options.targetDescription,\n          );\n        } catch (error) {\n          debugPage('Failed to judge isOrderSensitive: %s', error);\n          // Fall back to false on error\n        }\n      }\n\n      const xpaths = await this.getXpathsByPoint(center, isOrderSensitive);\n      const sanitized = sanitizeXpaths(xpaths);\n      if (!sanitized.length) {\n        debugPage('cacheFeatureForRect: no xpath found at rect %o', rect);\n      }\n      return {\n        xpaths: sanitized,\n      };\n    } catch (error) {\n      debugPage('cacheFeatureForRect failed: %s', error);\n      return {\n        xpaths: [],\n      };\n    }\n  }\n\n  async rectMatchesCacheFeature(feature: ElementCacheFeature): Promise<Rect> {\n    const webFeature = feature as WebElementCacheFeature;\n    const xpaths = sanitizeXpaths(webFeature.xpaths);\n\n    for (const xpath of xpaths) {\n      try {\n        const elementInfo = await this.getElementInfoByXpath(xpath);\n        if (elementInfo?.rect) {\n          const matchedRect: Rect = {\n            left: elementInfo.rect.left,\n            top: elementInfo.rect.top,\n            width: elementInfo.rect.width,\n            height: elementInfo.rect.height,\n          };\n\n          if (this.viewportSize?.dpr) {\n            matchedRect.dpr = this.viewportSize.dpr;\n          }\n\n          return matchedRect;\n        }\n      } catch (error) {\n        debugPage(\n          'rectMatchesCacheFeature failed for xpath %s: %s',\n          xpath,\n          error,\n        );\n      }\n    }\n\n    throw new Error(\n      'No matching element rect found for the provided cache feature',\n    );\n  }\n\n  async getElementsNodeTree() {\n    // ref: packages/web-integration/src/playwright/ai-fixture.ts popup logic\n    // During test execution, a new page might be opened through a connection, and the page remains confined to the same page instance.\n    // The page may go through opening, closing, and reopening; if the page is closed, evaluate may return undefined, which can lead to errors.\n    await this.waitForNavigation();\n    const scripts = await getExtraReturnLogic(true);\n    assert(scripts, 'scripts should be set before writing report in browser');\n    const startTime = Date.now();\n    const captureElementSnapshot = await this.evaluate(scripts);\n    const endTime = Date.now();\n    debugPage(`getElementsNodeTree end, cost: ${endTime - startTime}ms`);\n    return captureElementSnapshot as ElementTreeNode<ElementInfo>;\n  }\n\n  async size(): Promise<Size> {\n    if (this.viewportSize) return this.viewportSize;\n    const sizeInfo: Size = await this.evaluate(() => {\n      return {\n        width: document.documentElement.clientWidth,\n        height: document.documentElement.clientHeight,\n        dpr: window.devicePixelRatio,\n      };\n    });\n    this.viewportSize = sizeInfo;\n    return sizeInfo;\n  }\n\n  async screenshotBase64(): Promise<string> {\n    const imgType = 'jpeg';\n    const quality = 90;\n    await this.waitForNavigation();\n    const startTime = Date.now();\n    debugPage('screenshotBase64 begin');\n\n    let base64: string;\n    if (this.interfaceType === 'puppeteer') {\n      const result = await (this.underlyingPage as PuppeteerPage).screenshot({\n        type: imgType,\n        quality,\n        encoding: 'base64',\n      });\n      base64 = createImgBase64ByFormat(imgType, result);\n    } else if (this.interfaceType === 'playwright') {\n      const buffer = await (this.underlyingPage as PlaywrightPage).screenshot({\n        type: imgType,\n        quality,\n        timeout: 10 * 1000,\n      });\n      base64 = createImgBase64ByFormat(imgType, buffer.toString('base64'));\n    } else {\n      throw new Error('Unsupported page type for screenshot');\n    }\n    const endTime = Date.now();\n    debugPage(`screenshotBase64 end, cost: ${endTime - startTime}ms`);\n    return base64;\n  }\n\n  async url(): Promise<string> {\n    return this.underlyingPage.url();\n  }\n\n  describe(): string {\n    const url = this.underlyingPage.url();\n    return url || '';\n  }\n\n  get mouse() {\n    return {\n      click: async (\n        x: number,\n        y: number,\n        options?: { button?: MouseButton; count?: number },\n      ) => {\n        await this.mouse.move(x, y);\n        const { button = 'left', count = 1 } = options || {};\n        debugPage(`mouse click ${x}, ${y}, ${button}, ${count}`);\n\n        if (count === 2 && this.interfaceType === 'playwright') {\n          await (this.underlyingPage as PlaywrightPage).mouse.dblclick(x, y, {\n            button,\n          });\n        } else if (this.interfaceType === 'puppeteer') {\n          const page = this.underlyingPage as PuppeteerPage;\n          if (button === 'left' && count === 1) {\n            await page.mouse.click(x, y);\n          } else {\n            await page.mouse.click(x, y, { button, count });\n          }\n        } else if (this.interfaceType === 'playwright') {\n          await (this.underlyingPage as PlaywrightPage).mouse.click(x, y, {\n            button,\n            clickCount: count,\n          });\n        }\n      },\n      wheel: async (deltaX: number, deltaY: number) => {\n        debugPage(`mouse wheel ${deltaX}, ${deltaY}`);\n        if (this.interfaceType === 'puppeteer') {\n          await (this.underlyingPage as PuppeteerPage).mouse.wheel({\n            deltaX,\n            deltaY,\n          });\n        } else if (this.interfaceType === 'playwright') {\n          await (this.underlyingPage as PlaywrightPage).mouse.wheel(\n            deltaX,\n            deltaY,\n          );\n        }\n      },\n      move: async (x: number, y: number) => {\n        this.everMoved = true;\n        debugPage(`mouse move to ${x}, ${y}`);\n        return this.underlyingPage.mouse.move(x, y);\n      },\n      drag: async (\n        from: { x: number; y: number },\n        to: { x: number; y: number },\n      ) => {\n        debugPage(\n          `begin mouse drag from ${from.x}, ${from.y} to ${to.x}, ${to.y}`,\n        );\n        await (this.underlyingPage as PlaywrightPage).mouse.move(\n          from.x,\n          from.y,\n        );\n        await sleep(200);\n        await (this.underlyingPage as PlaywrightPage).mouse.down();\n        await sleep(300);\n        await (this.underlyingPage as PlaywrightPage).mouse.move(to.x, to.y, {\n          steps: 20,\n        });\n        await sleep(500);\n        await (this.underlyingPage as PlaywrightPage).mouse.up();\n        await sleep(200);\n        debugPage(\n          `end mouse drag from ${from.x}, ${from.y} to ${to.x}, ${to.y}`,\n        );\n      },\n    };\n  }\n\n  get keyboard() {\n    return {\n      type: async (text: string) => {\n        debugPage(`keyboard type ${text}`);\n        return this.underlyingPage.keyboard.type(text, { delay: 80 });\n      },\n      press: async (\n        action:\n          | { key: KeyInput; command?: string }\n          | { key: KeyInput; command?: string }[],\n      ) => {\n        const keys = Array.isArray(action) ? action : [action];\n        debugPage('keyboard press', keys);\n        for (const k of keys) {\n          const commands = k.command ? [k.command] : [];\n          await this.underlyingPage.keyboard.down(k.key, { commands });\n        }\n        for (const k of [...keys].reverse()) {\n          await this.underlyingPage.keyboard.up(k.key);\n        }\n      },\n      down: async (key: KeyInput) => {\n        debugPage(`keyboard down ${key}`);\n        return this.underlyingPage.keyboard.down(key);\n      },\n      up: async (key: KeyInput) => {\n        debugPage(`keyboard up ${key}`);\n        return this.underlyingPage.keyboard.up(key);\n      },\n    };\n  }\n\n  async clearInput(element: ElementInfo): Promise<void> {\n    if (!element) {\n      console.warn('No element to clear input');\n      return;\n    }\n\n    const backspace = async () => {\n      await sleep(100);\n      await this.keyboard.press([{ key: 'Backspace' }]);\n    };\n\n    const isMac = process.platform === 'darwin';\n    debugPage('clearInput begin');\n    if (isMac) {\n      if (this.interfaceType === 'puppeteer') {\n        // https://github.com/segment-boneyard/nightmare/issues/810#issuecomment-452669866\n        await this.mouse.click(element.center[0], element.center[1], {\n          count: 3,\n        });\n        await backspace();\n      }\n\n      await this.mouse.click(element.center[0], element.center[1]);\n      await this.underlyingPage.keyboard.down('Meta');\n      await this.underlyingPage.keyboard.press('a');\n      await this.underlyingPage.keyboard.up('Meta');\n      await backspace();\n    } else {\n      await this.mouse.click(element.center[0], element.center[1]);\n      await this.underlyingPage.keyboard.down('Control');\n      await this.underlyingPage.keyboard.press('a');\n      await this.underlyingPage.keyboard.up('Control');\n      await backspace();\n    }\n    debugPage('clearInput end');\n  }\n\n  private everMoved = false;\n  private async moveToPointBeforeScroll(point?: Point): Promise<void> {\n    if (point) {\n      await this.mouse.move(point.left, point.top);\n    } else if (!this.everMoved) {\n      // If the mouse has never moved, move it to the center of the page\n      const size = await this.size();\n      const targetX = Math.floor(size.width / 2);\n      const targetY = Math.floor(size.height / 2);\n      await this.mouse.move(targetX, targetY);\n    }\n  }\n\n  async scrollUntilTop(startingPoint?: Point): Promise<void> {\n    await this.moveToPointBeforeScroll(startingPoint);\n    return this.mouse.wheel(0, -9999999);\n  }\n\n  async scrollUntilBottom(startingPoint?: Point): Promise<void> {\n    await this.moveToPointBeforeScroll(startingPoint);\n    return this.mouse.wheel(0, 9999999);\n  }\n\n  async scrollUntilLeft(startingPoint?: Point): Promise<void> {\n    await this.moveToPointBeforeScroll(startingPoint);\n    return this.mouse.wheel(-9999999, 0);\n  }\n\n  async scrollUntilRight(startingPoint?: Point): Promise<void> {\n    await this.moveToPointBeforeScroll(startingPoint);\n    return this.mouse.wheel(9999999, 0);\n  }\n\n  async scrollUp(distance?: number, startingPoint?: Point): Promise<void> {\n    const innerHeight = await this.evaluate(() => window.innerHeight);\n    const scrollDistance = distance || innerHeight * 0.7;\n    await this.moveToPointBeforeScroll(startingPoint);\n    return this.mouse.wheel(0, -scrollDistance);\n  }\n\n  async scrollDown(distance?: number, startingPoint?: Point): Promise<void> {\n    const innerHeight = await this.evaluate(() => window.innerHeight);\n    const scrollDistance = distance || innerHeight * 0.7;\n    await this.moveToPointBeforeScroll(startingPoint);\n    return this.mouse.wheel(0, scrollDistance);\n  }\n\n  async scrollLeft(distance?: number, startingPoint?: Point): Promise<void> {\n    const innerWidth = await this.evaluate(() => window.innerWidth);\n    const scrollDistance = distance || innerWidth * 0.7;\n    await this.moveToPointBeforeScroll(startingPoint);\n    return this.mouse.wheel(-scrollDistance, 0);\n  }\n\n  async scrollRight(distance?: number, startingPoint?: Point): Promise<void> {\n    const innerWidth = await this.evaluate(() => window.innerWidth);\n    const scrollDistance = distance || innerWidth * 0.7;\n    await this.moveToPointBeforeScroll(startingPoint);\n    return this.mouse.wheel(scrollDistance, 0);\n  }\n\n  async navigate(url: string): Promise<void> {\n    debugPage(`navigate to ${url}`);\n    if (this.interfaceType === 'puppeteer') {\n      await (this.underlyingPage as PuppeteerPage).goto(url);\n    } else if (this.interfaceType === 'playwright') {\n      await (this.underlyingPage as PlaywrightPage).goto(url);\n    } else {\n      throw new Error('Unsupported page type for navigate');\n    }\n  }\n\n  async reload(): Promise<void> {\n    debugPage('reload page');\n    if (this.interfaceType === 'puppeteer') {\n      await (this.underlyingPage as PuppeteerPage).reload();\n    } else if (this.interfaceType === 'playwright') {\n      await (this.underlyingPage as PlaywrightPage).reload();\n    } else {\n      throw new Error('Unsupported page type for reload');\n    }\n  }\n\n  async goBack(): Promise<void> {\n    debugPage('go back');\n    if (this.interfaceType === 'puppeteer') {\n      await (this.underlyingPage as PuppeteerPage).goBack();\n    } else if (this.interfaceType === 'playwright') {\n      await (this.underlyingPage as PlaywrightPage).goBack();\n    } else {\n      throw new Error('Unsupported page type for go back');\n    }\n  }\n\n  async beforeInvokeAction(name: string, param: any): Promise<void> {\n    if (this.onBeforeInvokeAction) {\n      await this.onBeforeInvokeAction(name, param);\n    }\n  }\n\n  async afterInvokeAction(name: string, param: any): Promise<void> {\n    await this.waitForNavigation();\n    await this.waitForNetworkIdle();\n    if (this.onAfterInvokeAction) {\n      await this.onAfterInvokeAction(name, param);\n    }\n  }\n\n  async destroy(): Promise<void> {}\n\n  async getContext(): Promise<UIContext> {\n    return await WebPageContextParser(this, {});\n  }\n  async swipe(\n    from: { x: number; y: number },\n    to: { x: number; y: number },\n    duration?: number,\n  ) {\n    const LONG_PRESS_THRESHOLD = 500;\n    const MIN_PRESS_THRESHOLD = 150;\n    duration = duration || 100;\n    if (duration < MIN_PRESS_THRESHOLD) {\n      duration = MIN_PRESS_THRESHOLD;\n    }\n    if (duration > LONG_PRESS_THRESHOLD) {\n      duration = LONG_PRESS_THRESHOLD;\n    }\n    debugPage(\n      `mouse swipe from ${from.x}, ${from.y} to ${to.x}, ${to.y} with duration ${duration}ms`,\n    );\n\n    if (this.interfaceType === 'puppeteer') {\n      const page = this.underlyingPage as PuppeteerPage;\n      await page.mouse.move(from.x, from.y);\n      await page.mouse.down({ button: 'left' });\n\n      const steps = 30;\n      const delay = duration / steps;\n      for (let i = 1; i <= steps; i++) {\n        const x = from.x + (to.x - from.x) * (i / steps);\n        const y = from.y + (to.y - from.y) * (i / steps);\n        await page.mouse.move(x, y);\n        await new Promise((resolve) => setTimeout(resolve, delay));\n      }\n\n      await page.mouse.up({ button: 'left' });\n    } else if (this.interfaceType === 'playwright') {\n      const page = this.underlyingPage as PlaywrightPage;\n      await page.mouse.move(from.x, from.y);\n      await page.mouse.down();\n\n      const steps = 30;\n      const delay = duration / steps;\n      for (let i = 1; i <= steps; i++) {\n        const x = from.x + (to.x - from.x) * (i / steps);\n        const y = from.y + (to.y - from.y) * (i / steps);\n        await page.mouse.move(x, y);\n        await page.waitForTimeout(delay);\n      }\n\n      await page.mouse.up({ button: 'left' });\n    }\n  }\n  async longPress(x: number, y: number, duration?: number) {\n    duration = duration || 500;\n    const LONG_PRESS_THRESHOLD = 600;\n    const MIN_PRESS_THRESHOLD = 300;\n    if (duration > LONG_PRESS_THRESHOLD) {\n      duration = LONG_PRESS_THRESHOLD;\n    }\n    if (duration < MIN_PRESS_THRESHOLD) {\n      duration = MIN_PRESS_THRESHOLD;\n    }\n    debugPage(`mouse longPress at ${x}, ${y} for ${duration}ms`);\n    if (this.interfaceType === 'puppeteer') {\n      const page = this.underlyingPage as PuppeteerPage;\n      await page.mouse.move(x, y);\n      await page.mouse.down({ button: 'left' });\n      await new Promise((res) => setTimeout(res, duration));\n      await page.mouse.up({ button: 'left' });\n    } else if (this.interfaceType === 'playwright') {\n      const page = this.underlyingPage as PlaywrightPage;\n      await page.mouse.move(x, y);\n      await page.mouse.down({ button: 'left' });\n      await page.waitForTimeout(duration);\n      await page.mouse.up({ button: 'left' });\n    }\n  }\n\n  private async ensurePuppeteerFileChooserSession(\n    page: PuppeteerPage,\n  ): Promise<CDPSession> {\n    if (this.puppeteerFileChooserSession) {\n      return this.puppeteerFileChooserSession;\n    }\n    const session = await page.target().createCDPSession();\n    await session.send('Page.enable');\n    await session.send('DOM.enable');\n    await session.send('Page.setInterceptFileChooserDialog', { enabled: true });\n    this.puppeteerFileChooserSession = session;\n    return session;\n  }\n\n  async registerFileChooserListener(\n    handler: (\n      chooser: import('@midscene/core/device').FileChooserHandler,\n    ) => Promise<void>,\n  ): Promise<{ dispose: () => void; getError: () => Error | undefined }> {\n    if (this.interfaceType !== 'puppeteer') {\n      throw new Error(\n        'registerFileChooserListener is only supported in Puppeteer',\n      );\n    }\n\n    const page = this.underlyingPage as PuppeteerPage;\n    const session = await this.ensurePuppeteerFileChooserSession(page);\n    if (this.puppeteerFileChooserHandler) {\n      session.off('Page.fileChooserOpened', this.puppeteerFileChooserHandler);\n    }\n\n    let capturedError: Error | undefined;\n\n    this.puppeteerFileChooserHandler = async (event) => {\n      if (event.backendNodeId === undefined) {\n        debugPage('puppeteer file chooser opened without backendNodeId, skip');\n        return;\n      }\n      try {\n        await handler({\n          accept: async (files: string[]) => {\n            // Check if input supports multiple files\n            if (files.length > 1) {\n              const { node } = await session.send('DOM.describeNode', {\n                backendNodeId: event.backendNodeId,\n              });\n              // attributes is a flat array: ['attr1', 'value1', 'attr2', 'value2', ...]\n              const hasMultiple = node.attributes?.includes('multiple');\n              if (!hasMultiple) {\n                throw new Error(\n                  'Non-multiple file input can only accept single file',\n                );\n              }\n            }\n            await session.send('DOM.setFileInputFiles', {\n              files,\n              backendNodeId: event.backendNodeId,\n            });\n          },\n        });\n      } catch (error) {\n        capturedError = error as Error;\n      }\n    };\n    session.on('Page.fileChooserOpened', this.puppeteerFileChooserHandler);\n    return {\n      dispose: () => {\n        if (this.puppeteerFileChooserHandler) {\n          session.off(\n            'Page.fileChooserOpened',\n            this.puppeteerFileChooserHandler,\n          );\n        }\n        void session.detach();\n        this.puppeteerFileChooserHandler = undefined;\n        if (this.puppeteerFileChooserSession === session) {\n          this.puppeteerFileChooserSession = undefined;\n        }\n      },\n      getError: () => capturedError,\n    };\n  }\n}\n\nexport function forceClosePopup(\n  page: PuppeteerPage | PlaywrightPage,\n  debugProfile: DebugFunction,\n) {\n  page.on('popup', async (popup) => {\n    if (!popup) {\n      console.warn('got a popup event, but the popup is not ready yet, skip');\n      return;\n    }\n    const url = await (popup as PuppeteerPage).url();\n    console.log(`Popup opened: ${url}`);\n    if (!(popup as PuppeteerPage).isClosed()) {\n      try {\n        await (popup as PuppeteerPage).close(); // Close the newly opened TAB\n      } catch (error) {\n        debugProfile(`failed to close popup ${url}, error: ${error}`);\n      }\n    } else {\n      debugProfile(`popup is already closed, skip close ${url}`);\n    }\n\n    if (!page.isClosed()) {\n      try {\n        await page.goto(url);\n      } catch (error) {\n        debugProfile(`failed to goto ${url}, error: ${error}`);\n      }\n    } else {\n      debugProfile(`page is already closed, skip goto ${url}`);\n    }\n  });\n}\n\n/**\n * Force Chrome to render select elements using base-select appearance instead of OS-native rendering.\n * This makes select elements visible in screenshots captured by Playwright/Puppeteer.\n *\n * Reference: https://developer.chrome.com/blog/a-customizable-select\n *\n * Adds a style tag with CSS rules to make all select elements use base-select appearance.\n */\nexport function forceChromeSelectRendering(\n  page: PuppeteerPage | PlaywrightPage,\n): void {\n  // Force Chrome to render select elements using base-select appearance\n  // Reference: https://developer.chrome.com/blog/a-customizable-select\n  const styleContent = `\n/* Add by Midscene because of forceChromeSelectRendering is enabled*/\nselect {\n  &, &::picker(select) {\n    appearance: base-select !important;\n  }\n}`;\n  const styleId = 'midscene-force-select-rendering';\n\n  const injectStyle = async () => {\n    try {\n      await (page as PuppeteerPage & PlaywrightPage).evaluate(\n        (id, content) => {\n          if (document.getElementById(id)) return;\n          const style = document.createElement('style');\n          style.id = id;\n          style.textContent = content;\n          document.head.appendChild(style);\n        },\n        styleId,\n        styleContent,\n      );\n      console.log(\n        'Midscene - Added base-select appearance style for select elements because of forceChromeSelectRendering is enabled',\n      );\n    } catch (err) {\n      console.log(\n        'Midscene - Failed to add base-select appearance style:',\n        err,\n      );\n    }\n  };\n\n  // Inject immediately for the current document\n  void injectStyle();\n\n  // Ensure the style is reapplied on future navigations/new documents\n  (page as PuppeteerPage & PlaywrightPage).on('load', () => {\n    void injectStyle();\n  });\n}\n"],"names":["__webpack_require__","definition","key","Object","obj","prop","Symbol","debugPage","getDebug","sanitizeXpaths","xpaths","Array","xpath","Page","defaultActions","commonWebActionsForWebPage","customActions","pageFunction","arg","result","script","error","console","DEFAULT_WAIT_FOR_NETWORK_IDLE_CONCURRENCY","tree","treeToList","point","isOrderSensitive","elementInfosScriptContent","getElementInfosScriptContent","JSON","rect","options","center","Math","judgeResult","AiJudgeOrderSensitive","callAIWithObjectResponse","sanitized","feature","webFeature","elementInfo","matchedRect","Error","scripts","getExtraReturnLogic","assert","startTime","Date","captureElementSnapshot","endTime","sizeInfo","document","window","imgType","quality","base64","createImgBase64ByFormat","buffer","url","x","y","button","count","page","deltaX","deltaY","from","to","sleep","text","action","keys","k","commands","element","backspace","isMac","process","size","targetX","targetY","startingPoint","distance","innerHeight","scrollDistance","innerWidth","name","param","WebPageContextParser","duration","LONG_PRESS_THRESHOLD","MIN_PRESS_THRESHOLD","steps","delay","i","Promise","resolve","setTimeout","res","session","handler","capturedError","event","undefined","files","node","hasMultiple","underlyingPage","interfaceType","opts","DEFAULT_WAIT_FOR_NAVIGATION_TIMEOUT","DEFAULT_WAIT_FOR_NETWORK_IDLE_TIMEOUT","forceClosePopup","debugProfile","popup","forceChromeSelectRendering","styleContent","styleId","injectStyle","id","content","style","err"],"mappings":"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"}