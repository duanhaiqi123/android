{"version":3,"file":"bridge-mode/io-server.mjs","sources":["../../../src/bridge-mode/io-server.ts"],"sourcesContent":["import { createServer } from 'node:http';\nimport { sleep } from '@midscene/core/utils';\nimport { logMsg } from '@midscene/shared/utils';\nimport { Server, type Socket as ServerSocket } from 'socket.io';\nimport { io as ClientIO } from 'socket.io-client';\n\nimport {\n  type BridgeCall,\n  type BridgeCallResponse,\n  BridgeCallTimeout,\n  type BridgeConnectedEventPayload,\n  BridgeErrorCodeNoClientConnected,\n  BridgeEvent,\n  BridgeSignalKill,\n  DefaultBridgeServerPort,\n} from './common';\n\ndeclare const __VERSION__: string;\n\nexport const killRunningServer = async (port?: number, host = 'localhost') => {\n  try {\n    const client = ClientIO(`ws://${host}:${port || DefaultBridgeServerPort}`, {\n      query: {\n        [BridgeSignalKill]: 1,\n      },\n    });\n    await sleep(100);\n    await client.close();\n  } catch (e) {\n    // console.error('failed to kill port', e);\n  }\n};\n\n// ws server, this is where the request is sent\nexport class BridgeServer {\n  private callId = 0;\n  private io: Server | null = null;\n  private socket: ServerSocket | null = null;\n  private listeningTimeoutId: NodeJS.Timeout | null = null;\n  private listeningTimerFlag = false;\n  private connectionTipTimer: NodeJS.Timeout | null = null;\n  public calls: Record<string, BridgeCall> = {};\n\n  private connectionLost = false;\n  private connectionLostReason = '';\n\n  constructor(\n    public host: string,\n    public port: number,\n    public onConnect?: () => void,\n    public onDisconnect?: (reason: string) => void,\n    public closeConflictServer?: boolean,\n  ) {}\n\n  async listen(\n    opts: {\n      timeout?: number | false;\n    } = {},\n  ): Promise<void> {\n    const { timeout = 30000 } = opts;\n\n    if (this.closeConflictServer) {\n      await killRunningServer(this.port, this.host);\n    }\n\n    return new Promise((resolve, reject) => {\n      if (this.listeningTimerFlag) {\n        return reject(new Error('already listening'));\n      }\n      this.listeningTimerFlag = true;\n\n      this.listeningTimeoutId = timeout\n        ? setTimeout(() => {\n            reject(\n              new Error(\n                `no extension connected after ${timeout}ms (${BridgeErrorCodeNoClientConnected})`,\n              ),\n            );\n          }, timeout)\n        : null;\n\n      this.connectionTipTimer =\n        !timeout || timeout > 3000\n          ? setTimeout(() => {\n              logMsg('waiting for bridge to connect...');\n            }, 2000)\n          : null;\n\n      // Create HTTP server and start listening on the specified host and port\n      const httpServer = createServer();\n\n      // Set up HTTP server event listeners FIRST\n      httpServer.once('listening', () => {\n        resolve();\n      });\n\n      httpServer.once('error', (err: Error) => {\n        reject(new Error(`Bridge Listening Error: ${err.message}`));\n      });\n\n      // Start listening BEFORE creating Socket.IO Server\n      // When host is 127.0.0.1 (default), don't specify host to listen on all local interfaces (IPv4 + IPv6)\n      // This ensures localhost resolves correctly in both IPv4 and IPv6 environments\n      if (this.host === '127.0.0.1') {\n        httpServer.listen(this.port);\n      } else {\n        httpServer.listen(this.port, this.host);\n      }\n\n      // Now create Socket.IO Server attached to the already-listening HTTP server\n      this.io = new Server(httpServer, {\n        maxHttpBufferSize: 100 * 1024 * 1024, // 100MB\n      });\n\n      this.io.use((socket, next) => {\n        if (this.socket) {\n          next(new Error('server already connected by another client'));\n        }\n        next();\n      });\n\n      this.io.on('connection', (socket) => {\n        // check the connection url\n        const url = socket.handshake.url;\n        if (url.includes(BridgeSignalKill)) {\n          console.warn('kill signal received, closing bridge server');\n          return this.close();\n        }\n\n        this.connectionLost = false;\n        this.connectionLostReason = '';\n        this.listeningTimeoutId && clearTimeout(this.listeningTimeoutId);\n        this.listeningTimeoutId = null;\n        this.connectionTipTimer && clearTimeout(this.connectionTipTimer);\n        this.connectionTipTimer = null;\n        if (this.socket) {\n          socket.emit(BridgeEvent.Refused);\n          // close the socket\n          socket.disconnect();\n\n          return reject(\n            new Error('server already connected by another client'),\n          );\n        }\n\n        try {\n          logMsg('one client connected');\n          this.socket = socket;\n\n          const clientVersion = socket.handshake.query.version;\n          logMsg(\n            `Bridge connected, cli-side version v${__VERSION__}, browser-side version v${clientVersion}`,\n          );\n\n          socket.on(BridgeEvent.CallResponse, (params: BridgeCallResponse) => {\n            const id = params.id;\n            const response = params.response;\n            const error = params.error;\n\n            this.triggerCallResponseCallback(id, error, response);\n          });\n\n          socket.on('disconnect', (reason: string) => {\n            this.connectionLost = true;\n            this.connectionLostReason = reason;\n\n            try {\n              this.io?.close();\n            } catch (e) {\n              // ignore\n            }\n\n            // flush all pending calls as error\n            for (const id in this.calls) {\n              const call = this.calls[id];\n\n              if (!call.responseTime) {\n                const errorMessage = this.connectionLostErrorMsg();\n                this.triggerCallResponseCallback(\n                  id,\n                  new Error(errorMessage),\n                  null,\n                );\n              }\n            }\n\n            this.onDisconnect?.(reason);\n          });\n\n          setTimeout(() => {\n            this.onConnect?.();\n\n            const payload = {\n              version: __VERSION__,\n            } as BridgeConnectedEventPayload;\n            socket.emit(BridgeEvent.Connected, payload);\n            Promise.resolve().then(() => {\n              for (const id in this.calls) {\n                if (this.calls[id].callTime === 0) {\n                  this.emitCall(id);\n                }\n              }\n            });\n          }, 0);\n        } catch (e) {\n          console.error('failed to handle connection event', e);\n          reject(e);\n        }\n      });\n\n      this.io.on('close', () => {\n        this.close();\n      });\n    });\n  }\n\n  private connectionLostErrorMsg = () => {\n    return `Connection lost, reason: ${this.connectionLostReason}`;\n  };\n\n  private async triggerCallResponseCallback(\n    id: string | number,\n    error: Error | null,\n    response: any,\n  ) {\n    const call = this.calls[id];\n    if (!call) {\n      throw new Error(`call ${id} not found`);\n    }\n    call.error = error || undefined;\n    call.response = response;\n    call.responseTime = Date.now();\n\n    call.callback(call.error, response);\n  }\n\n  private async emitCall(id: string) {\n    const call = this.calls[id];\n    if (!call) {\n      throw new Error(`call ${id} not found`);\n    }\n\n    if (this.connectionLost) {\n      const message = `Connection lost, reason: ${this.connectionLostReason}`;\n      call.callback(new Error(message), null);\n      return;\n    }\n\n    if (this.socket) {\n      this.socket.emit(BridgeEvent.Call, {\n        id,\n        method: call.method,\n        args: call.args,\n      });\n      call.callTime = Date.now();\n    }\n  }\n\n  async call<T = any>(\n    method: string,\n    args: any[],\n    timeout = BridgeCallTimeout,\n  ): Promise<T> {\n    const id = `${this.callId++}`;\n\n    return new Promise((resolve, reject) => {\n      const timeoutId = setTimeout(() => {\n        logMsg(`bridge call timeout, id=${id}, method=${method}, args=`, args);\n        this.calls[id].error = new Error(\n          `Bridge call timeout after ${timeout}ms: ${method}`,\n        );\n        reject(this.calls[id].error);\n      }, timeout);\n\n      this.calls[id] = {\n        method,\n        args,\n        response: null,\n        callTime: 0,\n        responseTime: 0,\n        callback: (error: Error | undefined, response: any) => {\n          clearTimeout(timeoutId);\n          if (error) {\n            reject(error);\n          } else {\n            resolve(response);\n          }\n        },\n      };\n\n      this.emitCall(id);\n    });\n  }\n\n  // do NOT restart after close\n  async close() {\n    this.listeningTimeoutId && clearTimeout(this.listeningTimeoutId);\n    this.connectionTipTimer && clearTimeout(this.connectionTipTimer);\n    const closeProcess = this.io?.close();\n    this.io = null;\n\n    return closeProcess;\n  }\n}\n"],"names":["killRunningServer","port","host","client","ClientIO","DefaultBridgeServerPort","BridgeSignalKill","sleep","e","BridgeServer","opts","timeout","Promise","resolve","reject","Error","setTimeout","BridgeErrorCodeNoClientConnected","logMsg","httpServer","createServer","err","Server","socket","next","url","console","clearTimeout","BridgeEvent","clientVersion","params","id","response","error","reason","call","errorMessage","payload","__VERSION__","undefined","Date","message","method","args","BridgeCallTimeout","timeoutId","closeProcess","onConnect","onDisconnect","closeConflictServer"],"mappings":"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"}