{"version":3,"file":"chrome-extension/page.mjs","sources":["../../../src/chrome-extension/page.ts"],"sourcesContent":["/// <reference types=\"chrome\" />\n\n/*\n  It is used to interact with the page tab from the chrome extension.\n  The page must be active when interacting with it.\n*/\n\nimport { limitOpenNewTabScript } from '@/web-element';\nimport type { ElementTreeNode, Point, Size, UIContext } from '@midscene/core';\nimport type { AbstractInterface, DeviceAction } from '@midscene/core/device';\nimport type { ElementInfo } from '@midscene/shared/extractor';\nimport { treeToList } from '@midscene/shared/extractor';\nimport { createImgBase64ByFormat } from '@midscene/shared/img';\nimport { assert } from '@midscene/shared/utils';\nimport type { Protocol as CDPTypes } from 'devtools-protocol';\nimport { WebPageContextParser } from '../web-element';\nimport {\n  type KeyInput,\n  type MouseButton,\n  commonWebActionsForWebPage,\n} from '../web-page';\nimport { CdpKeyboard } from './cdpInput';\nimport {\n  getHtmlElementScript,\n  injectStopWaterFlowAnimation,\n  injectWaterFlowAnimation,\n} from './dynamic-scripts';\n\nfunction sleep(ms: number) {\n  return new Promise((resolve) => setTimeout(resolve, ms));\n}\n\nexport default class ChromeExtensionProxyPage implements AbstractInterface {\n  interfaceType = 'chrome-extension-proxy';\n\n  public forceSameTabNavigation: boolean;\n\n  private viewportSize?: Size;\n\n  private activeTabId: number | null = null;\n\n  private destroyed = false;\n\n  private isMobileEmulation: boolean | null = null;\n\n  public _continueWhenFailedToAttachDebugger = false;\n\n  constructor(forceSameTabNavigation: boolean) {\n    this.forceSameTabNavigation = forceSameTabNavigation;\n  }\n\n  actionSpace(): DeviceAction[] {\n    return commonWebActionsForWebPage(this);\n  }\n\n  public async setActiveTabId(tabId: number) {\n    if (this.activeTabId) {\n      throw new Error(\n        `Active tab id is already set, which is ${this.activeTabId}, cannot set it to ${tabId}`,\n      );\n    }\n    await chrome.tabs.update(tabId, { active: true });\n    this.activeTabId = tabId;\n  }\n\n  public async getActiveTabId() {\n    return this.activeTabId;\n  }\n\n  /**\n   * Get a list of current tabs\n   * @returns {Promise<Array<{id: number, title: string, url: string}>>}\n   */\n  public async getBrowserTabList(): Promise<\n    { id: string; title: string; url: string; currentActiveTab: boolean }[]\n  > {\n    const tabs = await chrome.tabs.query({ currentWindow: true });\n    return tabs\n      .map((tab) => ({\n        id: `${tab.id}`,\n        title: tab.title,\n        url: tab.url,\n        currentActiveTab: tab.active,\n      }))\n      .filter((tab) => tab.id && tab.title && tab.url) as {\n      id: string;\n      title: string;\n      url: string;\n      currentActiveTab: boolean;\n    }[];\n  }\n\n  public async getTabIdOrConnectToCurrentTab() {\n    if (this.activeTabId) {\n      // alway keep on the connected tab\n      return this.activeTabId;\n    }\n    const tabId = await chrome.tabs\n      .query({ active: true, currentWindow: true })\n      .then((tabs) => tabs[0]?.id);\n    this.activeTabId = tabId || 0;\n    return this.activeTabId;\n  }\n\n  /**\n   * Ensure debugger is attached to the current tab.\n   * Uses lazy attach pattern - only attaches when needed.\n   */\n  private async ensureDebuggerAttached() {\n    assert(!this.destroyed, 'Page is destroyed');\n\n    const url = await this.url();\n    if (url.startsWith('chrome://')) {\n      throw new Error(\n        'Cannot attach debugger to chrome:// pages, please use Midscene in a normal page with http://, https:// or file://',\n      );\n    }\n\n    const tabId = await this.getTabIdOrConnectToCurrentTab();\n\n    try {\n      await chrome.debugger.attach({ tabId }, '1.3');\n      console.log('Debugger attached to tab:', tabId);\n    } catch (error) {\n      const errorMsg = (error as Error)?.message || '';\n      // Already attached is OK, we can continue\n      if (errorMsg.includes('Another debugger is already attached')) {\n        console.log('Debugger already attached to tab:', tabId);\n        return;\n      }\n\n      if (this._continueWhenFailedToAttachDebugger) {\n        console.warn(\n          'Failed to attach debugger, but continuing due to _continueWhenFailedToAttachDebugger flag',\n          error,\n        );\n        return;\n      }\n\n      throw error;\n    }\n\n    // Wait for debugger banner in Chrome to appear\n    await sleep(500);\n\n    // Enable water flow animation\n    await this.enableWaterFlowAnimation();\n  }\n\n  private async showMousePointer(x: number, y: number) {\n    // update mouse pointer while redirecting\n    const pointerScript = `(() => {\n      if(typeof window.midsceneWaterFlowAnimation !== 'undefined') {\n        window.midsceneWaterFlowAnimation.enable();\n        window.midsceneWaterFlowAnimation.showMousePointer(${x}, ${y});\n      } else {\n        console.log('midsceneWaterFlowAnimation is not defined');\n      }\n    })()`;\n\n    await this.sendCommandToDebugger('Runtime.evaluate', {\n      expression: `${pointerScript}`,\n    });\n  }\n\n  private async hideMousePointer() {\n    await this.sendCommandToDebugger('Runtime.evaluate', {\n      expression: `(() => {\n        if(typeof window.midsceneWaterFlowAnimation !== 'undefined') {\n          window.midsceneWaterFlowAnimation.hideMousePointer();\n        }\n      })()`,\n    });\n  }\n\n  /**\n   * Public method to detach debugger without destroying the page instance.\n   * Useful for error recovery scenarios where we want to remove the debugger banner\n   * without completely destroying the page.\n   */\n  public async detachDebugger(tabId?: number) {\n    const tabIdToDetach = tabId || (await this.getTabIdOrConnectToCurrentTab());\n    console.log('detaching debugger from tab:', tabIdToDetach);\n\n    try {\n      await this.disableWaterFlowAnimation(tabIdToDetach);\n      await sleep(200); // wait for the animation to stop\n    } catch (error) {\n      console.warn('Failed to disable water flow animation', error);\n    }\n\n    try {\n      await chrome.debugger.detach({ tabId: tabIdToDetach });\n      console.log('Debugger detached successfully from tab:', tabIdToDetach);\n    } catch (error) {\n      // Tab might be closed or debugger already detached - this is OK\n      console.warn(\n        'Failed to detach debugger (may already be detached):',\n        error,\n      );\n    }\n  }\n\n  private async enableWaterFlowAnimation() {\n    const tabId = await this.getTabIdOrConnectToCurrentTab();\n\n    // limit open page in new tab\n    if (this.forceSameTabNavigation) {\n      await chrome.debugger.sendCommand({ tabId }, 'Runtime.evaluate', {\n        expression: limitOpenNewTabScript,\n      });\n    }\n\n    const script = await injectWaterFlowAnimation();\n    // we will call this function in sendCommandToDebugger, so we have to use the chrome.debugger.sendCommand\n    await chrome.debugger.sendCommand({ tabId }, 'Runtime.evaluate', {\n      expression: script,\n    });\n  }\n\n  private async disableWaterFlowAnimation(tabId: number) {\n    const script = await injectStopWaterFlowAnimation();\n\n    await chrome.debugger.sendCommand({ tabId }, 'Runtime.evaluate', {\n      expression: script,\n    });\n  }\n\n  /**\n   * Send a command to the debugger with automatic attach and retry on detachment.\n   * Uses lazy attach pattern - will automatically attach if not already attached.\n   */\n  private async sendCommandToDebugger<ResponseType = any, RequestType = any>(\n    command: string,\n    params: RequestType,\n    retryCount = 0,\n  ): Promise<ResponseType> {\n    const MAX_RETRIES = 2;\n    const tabId = await this.getTabIdOrConnectToCurrentTab();\n\n    try {\n      // Try to send command directly first\n      const result = (await chrome.debugger.sendCommand(\n        { tabId },\n        command,\n        params as any,\n      )) as ResponseType;\n\n      // Enable water flow animation after successful command (don't await)\n      this.enableWaterFlowAnimation().catch((err) => {\n        console.warn('Failed to enable water flow animation:', err);\n      });\n\n      return result;\n    } catch (error) {\n      // If command failed, check if it's because debugger is not attached\n      const errorMsg = (error as Error)?.message || '';\n      const isDetachError =\n        errorMsg.includes('Debugger is not attached') ||\n        errorMsg.includes('Cannot access a Target') ||\n        errorMsg.includes('No target with given id');\n\n      if (isDetachError && retryCount < MAX_RETRIES) {\n        console.log(\n          `Debugger not attached for command \"${command}\", attempting to attach (retry ${retryCount + 1}/${MAX_RETRIES})`,\n        );\n\n        // Try to attach and retry\n        await this.ensureDebuggerAttached();\n\n        return this.sendCommandToDebugger<ResponseType, RequestType>(\n          command,\n          params,\n          retryCount + 1,\n        );\n      }\n\n      // Not a detach error or out of retries\n      throw error;\n    }\n  }\n\n  private async getPageContentByCDP() {\n    const script = await getHtmlElementScript();\n\n    // check tab url\n    await this.sendCommandToDebugger<\n      CDPTypes.Runtime.EvaluateResponse,\n      CDPTypes.Runtime.EvaluateRequest\n    >('Runtime.evaluate', {\n      expression: script,\n    });\n\n    const expression = () => {\n      const tree = (\n        window as any\n      ).midscene_element_inspector.webExtractNodeTree();\n\n      return {\n        tree,\n        size: {\n          width: document.documentElement.clientWidth,\n          height: document.documentElement.clientHeight,\n          dpr: window.devicePixelRatio,\n        },\n      };\n    };\n    const returnValue = await this.sendCommandToDebugger<\n      CDPTypes.Runtime.EvaluateResponse,\n      CDPTypes.Runtime.EvaluateRequest\n    >('Runtime.evaluate', {\n      expression: `(${expression.toString()})()`,\n      returnByValue: true,\n    });\n\n    if (!returnValue.result.value) {\n      const errorDescription =\n        returnValue.exceptionDetails?.exception?.description || '';\n      if (!errorDescription) {\n        console.error('returnValue from cdp', returnValue);\n      }\n      throw new Error(\n        `Failed to get page content from page, error: ${errorDescription}`,\n      );\n    }\n\n    return returnValue.result.value as {\n      tree: ElementTreeNode<ElementInfo>;\n      size: Size;\n    };\n  }\n\n  public async evaluateJavaScript(script: string) {\n    return this.sendCommandToDebugger('Runtime.evaluate', {\n      expression: script,\n      awaitPromise: true,\n    });\n  }\n\n  async beforeInvokeAction(): Promise<void> {\n    // current implementation is wait until domReadyState is complete\n    try {\n      await this.waitUntilNetworkIdle();\n    } catch (error) {\n      // console.warn('Failed to wait until network idle', error);\n    }\n  }\n\n  private async waitUntilNetworkIdle() {\n    const timeout = 10000;\n    const startTime = Date.now();\n    let lastReadyState = '';\n    while (Date.now() - startTime < timeout) {\n      const result = await this.sendCommandToDebugger('Runtime.evaluate', {\n        expression: 'document.readyState',\n      });\n      lastReadyState = result.result.value;\n      if (lastReadyState === 'complete') {\n        await new Promise((resolve) => setTimeout(resolve, 300));\n        return;\n      }\n      await new Promise((resolve) => setTimeout(resolve, 300));\n    }\n    throw new Error(\n      `Failed to wait until network idle, last readyState: ${lastReadyState}`,\n    );\n  }\n\n  // @deprecated\n  async getElementsInfo() {\n    const tree = await this.getElementsNodeTree();\n    return treeToList(tree);\n  }\n\n  async getXpathsByPoint(point: Point, isOrderSensitive = false) {\n    const script = await getHtmlElementScript();\n\n    await this.sendCommandToDebugger<\n      CDPTypes.Runtime.EvaluateResponse,\n      CDPTypes.Runtime.EvaluateRequest\n    >('Runtime.evaluate', {\n      expression: script,\n    });\n\n    const result = await this.sendCommandToDebugger('Runtime.evaluate', {\n      expression: `window.midscene_element_inspector.getXpathsByPoint({left: ${point.left}, top: ${point.top}}, ${isOrderSensitive})`,\n      returnByValue: true,\n    });\n    return result.result.value;\n  }\n\n  async getElementInfoByXpath(xpath: string) {\n    const script = await getHtmlElementScript();\n\n    // check tab url\n    await this.sendCommandToDebugger<\n      CDPTypes.Runtime.EvaluateResponse,\n      CDPTypes.Runtime.EvaluateRequest\n    >('Runtime.evaluate', {\n      expression: script,\n    });\n    const result = await this.sendCommandToDebugger('Runtime.evaluate', {\n      expression: `window.midscene_element_inspector.getElementInfoByXpath(${JSON.stringify(xpath)})`,\n      returnByValue: true,\n    });\n    return result.result.value;\n  }\n\n  async getElementsNodeTree() {\n    await this.hideMousePointer();\n    const content = await this.getPageContentByCDP();\n    if (content?.size) {\n      this.viewportSize = content.size;\n    }\n\n    return content?.tree || { node: null, children: [] };\n  }\n\n  async getContext(): Promise<UIContext> {\n    return await WebPageContextParser(this, {});\n  }\n\n  async size() {\n    if (this.viewportSize) return this.viewportSize;\n\n    const result = await this.sendCommandToDebugger('Runtime.evaluate', {\n      expression:\n        '({width: document.documentElement.clientWidth, height: document.documentElement.clientHeight, dpr: window.devicePixelRatio})',\n      returnByValue: true,\n    });\n\n    const sizeInfo: Size = result.result.value;\n    console.log('sizeInfo', sizeInfo);\n\n    this.viewportSize = sizeInfo;\n    return sizeInfo;\n  }\n\n  async screenshotBase64() {\n    // screenshot by cdp\n    await this.hideMousePointer();\n    const format = 'jpeg';\n    const base64 = await this.sendCommandToDebugger('Page.captureScreenshot', {\n      format,\n      quality: 90,\n    });\n    return createImgBase64ByFormat(format, base64.data);\n  }\n\n  async url() {\n    const tabId = await this.getTabIdOrConnectToCurrentTab();\n    const url = await chrome.tabs.get(tabId).then((tab) => tab.url);\n    return url || '';\n  }\n\n  async navigate(url: string): Promise<void> {\n    const tabId = await this.getTabIdOrConnectToCurrentTab();\n    await chrome.tabs.update(tabId, { url });\n    // Wait for navigation to complete\n    // Note: debugger will auto-reattach on next command if detached during navigation\n    await this.waitUntilNetworkIdle();\n  }\n\n  async reload(): Promise<void> {\n    const tabId = await this.getTabIdOrConnectToCurrentTab();\n    await chrome.tabs.reload(tabId);\n    // Wait for reload to complete\n    await this.waitUntilNetworkIdle();\n  }\n\n  async goBack(): Promise<void> {\n    const tabId = await this.getTabIdOrConnectToCurrentTab();\n    await chrome.tabs.goBack(tabId);\n    // Wait for navigation to complete\n    await this.waitUntilNetworkIdle();\n  }\n\n  async scrollUntilTop(startingPoint?: Point) {\n    if (startingPoint) {\n      await this.mouse.move(startingPoint.left, startingPoint.top);\n    }\n    return this.mouse.wheel(0, -9999999);\n  }\n\n  async scrollUntilBottom(startingPoint?: Point) {\n    if (startingPoint) {\n      await this.mouse.move(startingPoint.left, startingPoint.top);\n    }\n    return this.mouse.wheel(0, 9999999);\n  }\n\n  async scrollUntilLeft(startingPoint?: Point) {\n    if (startingPoint) {\n      await this.mouse.move(startingPoint.left, startingPoint.top);\n    }\n    return this.mouse.wheel(-9999999, 0);\n  }\n\n  async scrollUntilRight(startingPoint?: Point) {\n    if (startingPoint) {\n      await this.mouse.move(startingPoint.left, startingPoint.top);\n    }\n    return this.mouse.wheel(9999999, 0);\n  }\n\n  async scrollUp(distance?: number, startingPoint?: Point) {\n    const { height } = await this.size();\n    const scrollDistance = distance || height * 0.7;\n    return this.mouse.wheel(\n      0,\n      -scrollDistance,\n      startingPoint?.left,\n      startingPoint?.top,\n    );\n  }\n\n  async scrollDown(distance?: number, startingPoint?: Point) {\n    const { height } = await this.size();\n    const scrollDistance = distance || height * 0.7;\n    return this.mouse.wheel(\n      0,\n      scrollDistance,\n      startingPoint?.left,\n      startingPoint?.top,\n    );\n  }\n\n  async scrollLeft(distance?: number, startingPoint?: Point) {\n    const { width } = await this.size();\n    const scrollDistance = distance || width * 0.7;\n    return this.mouse.wheel(\n      -scrollDistance,\n      0,\n      startingPoint?.left,\n      startingPoint?.top,\n    );\n  }\n\n  async scrollRight(distance?: number, startingPoint?: Point) {\n    const { width } = await this.size();\n    const scrollDistance = distance || width * 0.7;\n    return this.mouse.wheel(\n      scrollDistance,\n      0,\n      startingPoint?.left,\n      startingPoint?.top,\n    );\n  }\n\n  async clearInput(element: ElementInfo) {\n    if (!element) {\n      console.warn('No element to clear input');\n      return;\n    }\n\n    await this.mouse.click(element.center[0], element.center[1]);\n\n    await this.sendCommandToDebugger('Input.dispatchKeyEvent', {\n      type: 'keyDown',\n      commands: ['selectAll'],\n    });\n\n    await this.sendCommandToDebugger('Input.dispatchKeyEvent', {\n      type: 'keyUp',\n      commands: ['selectAll'],\n    });\n\n    await sleep(100);\n\n    await this.keyboard.press({\n      key: 'Backspace',\n    });\n  }\n\n  private latestMouseX = 100;\n  private latestMouseY = 100;\n\n  mouse = {\n    click: async (\n      x: number,\n      y: number,\n      options?: { button?: MouseButton; count?: number },\n    ) => {\n      const { button = 'left', count = 1 } = options || {};\n      await this.mouse.move(x, y);\n      // detect if the page is in mobile emulation mode\n      if (this.isMobileEmulation === null) {\n        const result = await this.sendCommandToDebugger('Runtime.evaluate', {\n          expression: `(() => {\n            return /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);\n          })()`,\n          returnByValue: true,\n        });\n        this.isMobileEmulation = result?.result?.value;\n      }\n\n      if (this.isMobileEmulation && button === 'left') {\n        // in mobile emulation mode, directly inject click event\n        const touchPoints = [{ x: Math.round(x), y: Math.round(y) }];\n        await this.sendCommandToDebugger('Input.dispatchTouchEvent', {\n          type: 'touchStart',\n          touchPoints,\n          modifiers: 0,\n        });\n\n        await this.sendCommandToDebugger('Input.dispatchTouchEvent', {\n          type: 'touchEnd',\n          touchPoints: [],\n          modifiers: 0,\n        });\n      } else {\n        // standard mousePressed + mouseReleased\n        for (let i = 0; i < count; i++) {\n          await this.sendCommandToDebugger('Input.dispatchMouseEvent', {\n            type: 'mousePressed',\n            x,\n            y,\n            button,\n            clickCount: 1,\n          });\n          await this.sendCommandToDebugger('Input.dispatchMouseEvent', {\n            type: 'mouseReleased',\n            x,\n            y,\n            button,\n            clickCount: 1,\n          });\n          await sleep(50);\n        }\n      }\n    },\n    wheel: async (\n      deltaX: number,\n      deltaY: number,\n      startX?: number,\n      startY?: number,\n    ) => {\n      const finalX = startX || this.latestMouseX;\n      const finalY = startY || this.latestMouseY;\n      await this.showMousePointer(finalX, finalY);\n      await this.sendCommandToDebugger('Input.dispatchMouseEvent', {\n        type: 'mouseWheel',\n        x: finalX,\n        y: finalY,\n        deltaX,\n        deltaY,\n      });\n      this.latestMouseX = finalX;\n      this.latestMouseY = finalY;\n    },\n    move: async (x: number, y: number) => {\n      await this.showMousePointer(x, y);\n      await this.sendCommandToDebugger('Input.dispatchMouseEvent', {\n        type: 'mouseMoved',\n        x,\n        y,\n      });\n      this.latestMouseX = x;\n      this.latestMouseY = y;\n    },\n    drag: async (\n      from: { x: number; y: number },\n      to: { x: number; y: number },\n    ) => {\n      await this.mouse.move(from.x, from.y);\n\n      await sleep(200);\n      await this.sendCommandToDebugger('Input.dispatchMouseEvent', {\n        type: 'mousePressed',\n        x: from.x,\n        y: from.y,\n        button: 'left',\n        clickCount: 1,\n      });\n\n      await sleep(300);\n\n      await this.sendCommandToDebugger('Input.dispatchMouseEvent', {\n        type: 'mouseMoved',\n        x: to.x,\n        y: to.y,\n      });\n\n      await sleep(500);\n\n      await this.sendCommandToDebugger('Input.dispatchMouseEvent', {\n        type: 'mouseReleased',\n        x: to.x,\n        y: to.y,\n        button: 'left',\n        clickCount: 1,\n      });\n\n      await sleep(200);\n\n      await this.mouse.move(to.x, to.y);\n    },\n  };\n\n  keyboard = {\n    type: async (text: string) => {\n      const cdpKeyboard = new CdpKeyboard({\n        send: this.sendCommandToDebugger.bind(this),\n      });\n      await cdpKeyboard.type(text, { delay: 0 });\n    },\n    press: async (\n      action:\n        | { key: KeyInput; command?: string }\n        | { key: KeyInput; command?: string }[],\n    ) => {\n      const cdpKeyboard = new CdpKeyboard({\n        send: this.sendCommandToDebugger.bind(this),\n      });\n      const keys = Array.isArray(action) ? action : [action];\n      for (const k of keys) {\n        const commands = k.command ? [k.command] : [];\n        await cdpKeyboard.down(k.key, { commands });\n      }\n      for (const k of [...keys].reverse()) {\n        await cdpKeyboard.up(k.key);\n      }\n    },\n  };\n\n  async destroy(): Promise<void> {\n    this.destroyed = true;\n    this.activeTabId = null;\n    await this.detachDebugger();\n  }\n\n  async longPress(x: number, y: number, duration?: number) {\n    duration = duration || 500;\n    const LONG_PRESS_THRESHOLD = 600;\n    const MIN_PRESS_THRESHOLD = 300;\n    if (duration > LONG_PRESS_THRESHOLD) {\n      duration = LONG_PRESS_THRESHOLD;\n    }\n    if (duration < MIN_PRESS_THRESHOLD) {\n      duration = MIN_PRESS_THRESHOLD;\n    }\n    await this.mouse.move(x, y);\n\n    if (this.isMobileEmulation === null) {\n      const result = await this.sendCommandToDebugger('Runtime.evaluate', {\n        expression: `(() => {\n          return /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);\n        })()`,\n        returnByValue: true,\n      });\n      this.isMobileEmulation = result?.result?.value;\n    }\n\n    if (this.isMobileEmulation) {\n      const touchPoints = [{ x: Math.round(x), y: Math.round(y) }];\n      await this.sendCommandToDebugger('Input.dispatchTouchEvent', {\n        type: 'touchStart',\n        touchPoints,\n        modifiers: 0,\n      });\n      await new Promise((res) => setTimeout(res, duration));\n      await this.sendCommandToDebugger('Input.dispatchTouchEvent', {\n        type: 'touchEnd',\n        touchPoints: [],\n        modifiers: 0,\n      });\n    } else {\n      await this.sendCommandToDebugger('Input.dispatchMouseEvent', {\n        type: 'mousePressed',\n        x,\n        y,\n        button: 'left',\n        clickCount: 1,\n      });\n      await new Promise((res) => setTimeout(res, duration));\n      await this.sendCommandToDebugger('Input.dispatchMouseEvent', {\n        type: 'mouseReleased',\n        x,\n        y,\n        button: 'left',\n        clickCount: 1,\n      });\n    }\n    this.latestMouseX = x;\n    this.latestMouseY = y;\n  }\n\n  async swipe(\n    from: { x: number; y: number },\n    to: { x: number; y: number },\n    duration?: number,\n  ) {\n    const LONG_PRESS_THRESHOLD = 500;\n    const MIN_PRESS_THRESHOLD = 150;\n    duration = duration || 300;\n    if (duration < MIN_PRESS_THRESHOLD) {\n      duration = MIN_PRESS_THRESHOLD;\n    }\n    if (duration > LONG_PRESS_THRESHOLD) {\n      duration = LONG_PRESS_THRESHOLD;\n    }\n\n    if (this.isMobileEmulation === null) {\n      const result = await this.sendCommandToDebugger('Runtime.evaluate', {\n        expression: `(() => {\n          return /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);\n        })()`,\n        returnByValue: true,\n      });\n      this.isMobileEmulation = result?.result?.value;\n    }\n\n    const steps = 30;\n    const delay = duration / steps;\n\n    if (this.isMobileEmulation) {\n      await this.sendCommandToDebugger('Input.dispatchTouchEvent', {\n        type: 'touchStart',\n        touchPoints: [{ x: Math.round(from.x), y: Math.round(from.y) }],\n        modifiers: 0,\n      });\n\n      for (let i = 1; i <= steps; i++) {\n        const x = from.x + (to.x - from.x) * (i / steps);\n        const y = from.y + (to.y - from.y) * (i / steps);\n        await this.sendCommandToDebugger('Input.dispatchTouchEvent', {\n          type: 'touchMove',\n          touchPoints: [{ x: Math.round(x), y: Math.round(y) }],\n          modifiers: 0,\n        });\n        await new Promise((res) => setTimeout(res, delay));\n      }\n\n      await this.sendCommandToDebugger('Input.dispatchTouchEvent', {\n        type: 'touchEnd',\n        touchPoints: [],\n        modifiers: 0,\n      });\n    } else {\n      await this.mouse.move(from.x, from.y);\n      await this.sendCommandToDebugger('Input.dispatchMouseEvent', {\n        type: 'mousePressed',\n        x: from.x,\n        y: from.y,\n        button: 'left',\n        clickCount: 1,\n      });\n\n      for (let i = 1; i <= steps; i++) {\n        const x = from.x + (to.x - from.x) * (i / steps);\n        const y = from.y + (to.y - from.y) * (i / steps);\n        await this.mouse.move(x, y);\n        await new Promise((res) => setTimeout(res, delay));\n      }\n\n      await this.sendCommandToDebugger('Input.dispatchMouseEvent', {\n        type: 'mouseReleased',\n        x: to.x,\n        y: to.y,\n        button: 'left',\n        clickCount: 1,\n      });\n    }\n\n    this.latestMouseX = to.x;\n    this.latestMouseY = to.y;\n  }\n}\n"],"names":["sleep","ms","Promise","resolve","setTimeout","ChromeExtensionProxyPage","commonWebActionsForWebPage","tabId","Error","chrome","tabs","tab","assert","url","console","error","errorMsg","x","y","pointerScript","tabIdToDetach","limitOpenNewTabScript","script","injectWaterFlowAnimation","injectStopWaterFlowAnimation","command","params","retryCount","MAX_RETRIES","result","err","isDetachError","getHtmlElementScript","expression","tree","window","document","returnValue","errorDescription","timeout","startTime","Date","lastReadyState","treeToList","point","isOrderSensitive","xpath","JSON","content","WebPageContextParser","sizeInfo","format","base64","createImgBase64ByFormat","startingPoint","distance","height","scrollDistance","width","element","duration","LONG_PRESS_THRESHOLD","MIN_PRESS_THRESHOLD","touchPoints","Math","res","from","to","steps","delay","i","forceSameTabNavigation","options","button","count","deltaX","deltaY","startX","startY","finalX","finalY","text","cdpKeyboard","CdpKeyboard","action","keys","Array","k","commands"],"mappings":"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"}