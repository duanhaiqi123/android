{"version":3,"file":"mcp-tools.mjs","sources":["../../src/mcp-tools.ts"],"sourcesContent":["import { z } from '@midscene/core';\nimport { BaseMidsceneTools, type ToolDefinition } from '@midscene/shared/mcp';\nimport { AgentOverChromeBridge } from './bridge-mode';\nimport { StaticPage } from './static';\n\n/**\n * Tools manager for Web bridge-mode MCP\n */\nexport class WebMidsceneTools extends BaseMidsceneTools<AgentOverChromeBridge> {\n  protected createTemporaryDevice() {\n    // Use require to avoid type incompatibility with DeviceAction vs ActionSpaceItem\n    // StaticPage.actionSpace() returns DeviceAction[] which is compatible at runtime\n    return new StaticPage({\n      screenshotBase64: '',\n      size: { width: 1920, height: 1080 },\n    });\n  }\n\n  protected async ensureAgent(\n    openNewTabWithUrl?: string,\n  ): Promise<AgentOverChromeBridge> {\n    // Re-init if URL provided\n    if (this.agent && openNewTabWithUrl) {\n      try {\n        await this.agent?.destroy?.();\n      } catch (error) {\n        console.debug('Failed to destroy agent during re-init:', error);\n      }\n      this.agent = undefined;\n    }\n\n    if (this.agent) return this.agent;\n\n    // Bridge mode requires a URL to connect to browser\n    if (!openNewTabWithUrl) {\n      throw new Error(\n        'Bridge mode requires a URL. Use web_connect tool to connect to a page first.',\n      );\n    }\n\n    this.agent = await this.initBridgeModeAgent(openNewTabWithUrl);\n\n    return this.agent;\n  }\n\n  private async initBridgeModeAgent(\n    url?: string,\n  ): Promise<AgentOverChromeBridge> {\n    const agent = new AgentOverChromeBridge({ closeConflictServer: true });\n\n    if (!url) {\n      await agent.connectCurrentTab();\n    } else {\n      await agent.connectNewTabWithUrl(url);\n    }\n\n    return agent;\n  }\n\n  protected preparePlatformTools(): ToolDefinition[] {\n    return [\n      {\n        name: 'web_connect',\n        description: 'Connect to web page by opening new tab with URL',\n        schema: {\n          url: z.string().url().describe('URL to connect to'),\n        },\n        handler: async (args) => {\n          const { url } = args as { url: string };\n          const agent = await this.ensureAgent(url);\n          const screenshot = await agent.page?.screenshotBase64();\n          if (!screenshot) {\n            return {\n              content: [\n                {\n                  type: 'text',\n                  text: `Connected to: ${url}`,\n                },\n              ],\n            };\n          }\n\n          return {\n            content: [\n              {\n                type: 'text',\n                text: `Connected to: ${url}`,\n              },\n              ...this.buildScreenshotContent(screenshot),\n            ],\n          };\n        },\n        autoDestroy: false,\n      },\n    ];\n  }\n}\n"],"names":["WebMidsceneTools","BaseMidsceneTools","StaticPage","openNewTabWithUrl","error","console","undefined","Error","url","agent","AgentOverChromeBridge","z","args","screenshot"],"mappings":";;;;AAQO,MAAMA,yBAAyBC;IAC1B,wBAAwB;QAGhC,OAAO,IAAIC,WAAW;YACpB,kBAAkB;YAClB,MAAM;gBAAE,OAAO;gBAAM,QAAQ;YAAK;QACpC;IACF;IAEA,MAAgB,YACdC,iBAA0B,EACM;QAEhC,IAAI,IAAI,CAAC,KAAK,IAAIA,mBAAmB;YACnC,IAAI;gBACF,MAAM,IAAI,CAAC,KAAK,EAAE;YACpB,EAAE,OAAOC,OAAO;gBACdC,QAAQ,KAAK,CAAC,2CAA2CD;YAC3D;YACA,IAAI,CAAC,KAAK,GAAGE;QACf;QAEA,IAAI,IAAI,CAAC,KAAK,EAAE,OAAO,IAAI,CAAC,KAAK;QAGjC,IAAI,CAACH,mBACH,MAAM,IAAII,MACR;QAIJ,IAAI,CAAC,KAAK,GAAG,MAAM,IAAI,CAAC,mBAAmB,CAACJ;QAE5C,OAAO,IAAI,CAAC,KAAK;IACnB;IAEA,MAAc,oBACZK,GAAY,EACoB;QAChC,MAAMC,QAAQ,IAAIC,sBAAsB;YAAE,qBAAqB;QAAK;QAEpE,IAAKF,KAGH,MAAMC,MAAM,oBAAoB,CAACD;aAFjC,MAAMC,MAAM,iBAAiB;QAK/B,OAAOA;IACT;IAEU,uBAAyC;QACjD,OAAO;YACL;gBACE,MAAM;gBACN,aAAa;gBACb,QAAQ;oBACN,KAAKE,EAAE,MAAM,GAAG,GAAG,GAAG,QAAQ,CAAC;gBACjC;gBACA,SAAS,OAAOC;oBACd,MAAM,EAAEJ,GAAG,EAAE,GAAGI;oBAChB,MAAMH,QAAQ,MAAM,IAAI,CAAC,WAAW,CAACD;oBACrC,MAAMK,aAAa,MAAMJ,MAAM,IAAI,EAAE;oBACrC,IAAI,CAACI,YACH,OAAO;wBACL,SAAS;4BACP;gCACE,MAAM;gCACN,MAAM,CAAC,cAAc,EAAEL,KAAK;4BAC9B;yBACD;oBACH;oBAGF,OAAO;wBACL,SAAS;4BACP;gCACE,MAAM;gCACN,MAAM,CAAC,cAAc,EAAEA,KAAK;4BAC9B;+BACG,IAAI,CAAC,sBAAsB,CAACK;yBAChC;oBACH;gBACF;gBACA,aAAa;YACf;SACD;IACH;AACF"}