{"version":3,"file":"server.mjs","sources":["../../src/server.ts"],"sourcesContent":["import { existsSync, readFileSync, writeFileSync } from 'node:fs';\nimport type { Server } from 'node:http';\nimport { dirname, join } from 'node:path';\nimport { fileURLToPath } from 'node:url';\nimport type { ExecutionDump } from '@midscene/core';\nimport type { Agent as PageAgent } from '@midscene/core/agent';\nimport { getTmpDir } from '@midscene/core/utils';\nimport { PLAYGROUND_SERVER_PORT } from '@midscene/shared/constants';\nimport { overrideAIConfig } from '@midscene/shared/env';\nimport { uuid } from '@midscene/shared/utils';\nimport express, { type Request, type Response } from 'express';\nimport { executeAction, formatErrorMessage } from './common';\n\nimport 'dotenv/config';\n\nconst defaultPort = PLAYGROUND_SERVER_PORT;\n\n// Static path for playground files\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = dirname(__filename);\nconst STATIC_PATH = join(__dirname, '..', '..', 'static');\n\nconst errorHandler = (\n  err: unknown,\n  req: Request,\n  res: Response,\n  next: express.NextFunction,\n) => {\n  console.error(err);\n  const errorMessage =\n    err instanceof Error ? err.message : 'Internal server error';\n  res.status(500).json({\n    error: errorMessage,\n  });\n};\n\nclass PlaygroundServer {\n  private _app: express.Application;\n  tmpDir: string;\n  server?: Server;\n  port?: number | null;\n  agent: PageAgent;\n  staticPath: string;\n  taskExecutionDumps: Record<string, ExecutionDump | null>; // Store execution dumps directly\n  id: string; // Unique identifier for this server instance\n\n  private _initialized = false;\n\n  // Factory function for recreating agent\n  private agentFactory?: (() => PageAgent | Promise<PageAgent>) | null;\n\n  // Track current running task\n  private currentTaskId: string | null = null;\n\n  constructor(\n    agent: PageAgent | (() => PageAgent) | (() => Promise<PageAgent>),\n    staticPath = STATIC_PATH,\n    id?: string, // Optional override ID\n  ) {\n    this._app = express();\n    this.tmpDir = getTmpDir()!;\n    this.staticPath = staticPath;\n    this.taskExecutionDumps = {}; // Initialize as empty object\n    // Use provided ID, or generate random UUID for each startup\n    this.id = id || uuid();\n\n    // Support both instance and factory function modes\n    if (typeof agent === 'function') {\n      this.agentFactory = agent;\n      this.agent = null as any; // Will be initialized in launch()\n    } else {\n      this.agent = agent;\n      this.agentFactory = null;\n    }\n  }\n\n  /**\n   * Get the Express app instance for custom configuration\n   *\n   * IMPORTANT: Add middleware (like CORS) BEFORE calling launch()\n   * The routes are initialized when launch() is called, so middleware\n   * added after launch() will not affect the API routes.\n   *\n   * @example\n   * ```typescript\n   * import cors from 'cors';\n   *\n   * const server = new PlaygroundServer(agent);\n   *\n   * // Add CORS middleware before launch\n   * server.app.use(cors({\n   *   origin: true,\n   *   credentials: true,\n   *   methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS']\n   * }));\n   *\n   * await server.launch();\n   * ```\n   */\n  get app(): express.Application {\n    return this._app;\n  }\n\n  /**\n   * Initialize Express app with all routes and middleware\n   * Called automatically by launch() if not already initialized\n   */\n  private initializeApp(): void {\n    if (this._initialized) return;\n\n    // Built-in middleware to parse JSON bodies\n    this._app.use(express.json({ limit: '50mb' }));\n\n    // Context update middleware (after JSON parsing)\n    this._app.use(\n      (req: Request, _res: Response, next: express.NextFunction) => {\n        const { context } = req.body || {};\n        if (\n          context &&\n          'updateContext' in this.agent.interface &&\n          typeof this.agent.interface.updateContext === 'function'\n        ) {\n          this.agent.interface.updateContext(context);\n          console.log('Context updated by PlaygroundServer middleware');\n        }\n        next();\n      },\n    );\n\n    // NOTE: CORS middleware should be added externally via server.app.use()\n    // before calling server.launch() if needed\n\n    // API routes\n    this.setupRoutes();\n\n    // Static file serving (if staticPath is provided)\n    this.setupStaticRoutes();\n\n    // Error handler middleware (must be last)\n    this._app.use(errorHandler);\n\n    this._initialized = true;\n  }\n\n  filePathForUuid(uuid: string) {\n    return join(this.tmpDir, `${uuid}.json`);\n  }\n\n  saveContextFile(uuid: string, context: string) {\n    const tmpFile = this.filePathForUuid(uuid);\n    console.log(`save context file: ${tmpFile}`);\n    writeFileSync(tmpFile, context);\n    return tmpFile;\n  }\n\n  /**\n   * Recreate agent instance (for cancellation)\n   */\n  private async recreateAgent(): Promise<void> {\n    if (!this.agentFactory) {\n      throw new Error(\n        'Cannot recreate agent: factory function not provided. Attempting to destroy existing agent only.',\n      );\n    }\n\n    console.log('Recreating agent to cancel current task...');\n\n    // Destroy old agent instance\n    try {\n      if (this.agent && typeof this.agent.destroy === 'function') {\n        await this.agent.destroy();\n      }\n    } catch (error) {\n      console.warn('Failed to destroy old agent:', error);\n    }\n\n    // Create new agent instance\n    try {\n      this.agent = await this.agentFactory();\n      console.log('Agent recreated successfully');\n    } catch (error) {\n      console.error('Failed to recreate agent:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Setup all API routes\n   */\n  private setupRoutes(): void {\n    this._app.get('/status', async (req: Request, res: Response) => {\n      res.send({\n        status: 'ok',\n        id: this.id,\n      });\n    });\n\n    this._app.get('/context/:uuid', async (req: Request, res: Response) => {\n      const { uuid } = req.params;\n      const contextFile = this.filePathForUuid(uuid);\n\n      if (!existsSync(contextFile)) {\n        return res.status(404).json({\n          error: 'Context not found',\n        });\n      }\n\n      const context = readFileSync(contextFile, 'utf8');\n      res.json({\n        context,\n      });\n    });\n\n    this._app.get(\n      '/task-progress/:requestId',\n      async (req: Request, res: Response) => {\n        const { requestId } = req.params;\n        const executionDump = this.taskExecutionDumps[requestId] || null;\n\n        res.json({\n          executionDump,\n        });\n      },\n    );\n\n    this._app.post('/action-space', async (req: Request, res: Response) => {\n      try {\n        let actionSpace = [];\n\n        actionSpace = this.agent.interface.actionSpace();\n\n        // Process actionSpace to make paramSchema serializable with shape info\n        const processedActionSpace = actionSpace.map((action: unknown) => {\n          if (action && typeof action === 'object' && 'paramSchema' in action) {\n            const typedAction = action as {\n              paramSchema?: { shape?: object; [key: string]: unknown };\n              [key: string]: unknown;\n            };\n            if (\n              typedAction.paramSchema &&\n              typeof typedAction.paramSchema === 'object'\n            ) {\n              // Extract shape information from Zod schema\n              let processedSchema = null;\n\n              try {\n                // Extract shape from runtime Zod object\n                if (\n                  typedAction.paramSchema.shape &&\n                  typeof typedAction.paramSchema.shape === 'object'\n                ) {\n                  processedSchema = {\n                    type: 'ZodObject',\n                    shape: typedAction.paramSchema.shape,\n                  };\n                }\n              } catch (e) {\n                const actionName =\n                  'name' in typedAction && typeof typedAction.name === 'string'\n                    ? typedAction.name\n                    : 'unknown';\n                console.warn(\n                  'Failed to process paramSchema for action:',\n                  actionName,\n                  e,\n                );\n              }\n\n              return {\n                ...typedAction,\n                paramSchema: processedSchema,\n              };\n            }\n          }\n          return action;\n        });\n\n        res.json(processedActionSpace);\n      } catch (error: unknown) {\n        const errorMessage =\n          error instanceof Error ? error.message : 'Unknown error';\n        console.error('Failed to get action space:', error);\n        res.status(500).json({\n          error: errorMessage,\n        });\n      }\n    });\n\n    // -------------------------\n    // actions from report file\n    this._app.post(\n      '/playground-with-context',\n      async (req: Request, res: Response) => {\n        const context = req.body.context;\n\n        if (!context) {\n          return res.status(400).json({\n            error: 'context is required',\n          });\n        }\n\n        const requestId = uuid();\n        this.saveContextFile(requestId, context);\n        return res.json({\n          location: `/playground/${requestId}`,\n          uuid: requestId,\n        });\n      },\n    );\n\n    this._app.post('/execute', async (req: Request, res: Response) => {\n      const {\n        type,\n        prompt,\n        params,\n        requestId,\n        deepThink,\n        screenshotIncluded,\n        domIncluded,\n        deviceOptions,\n      } = req.body;\n\n      if (!type) {\n        return res.status(400).json({\n          error: 'type is required',\n        });\n      }\n\n      // Always recreate agent before execution to ensure latest config is applied\n      if (this.agentFactory) {\n        console.log('Destroying old agent before execution...');\n        try {\n          if (this.agent && typeof this.agent.destroy === 'function') {\n            await this.agent.destroy();\n          }\n        } catch (error) {\n          console.warn('Failed to destroy old agent:', error);\n        }\n\n        console.log('Creating new agent with latest config...');\n        try {\n          this.agent = await this.agentFactory();\n          console.log('Agent created successfully');\n        } catch (error) {\n          console.error('Failed to create agent:', error);\n          return res.status(500).json({\n            error: `Failed to create agent: ${error instanceof Error ? error.message : 'Unknown error'}`,\n          });\n        }\n      }\n\n      // Update device options if provided\n      if (\n        deviceOptions &&\n        this.agent.interface &&\n        'options' in this.agent.interface\n      ) {\n        this.agent.interface.options = {\n          ...(this.agent.interface.options || {}),\n          ...deviceOptions,\n        };\n      }\n\n      // Check if another task is running\n      if (this.currentTaskId) {\n        return res.status(409).json({\n          error: 'Another task is already running',\n          currentTaskId: this.currentTaskId,\n        });\n      }\n\n      // Lock this task\n      if (requestId) {\n        this.currentTaskId = requestId;\n        this.taskExecutionDumps[requestId] = null;\n\n        // Use onDumpUpdate to receive and store executionDump directly\n        this.agent.onDumpUpdate = (\n          _dump: string,\n          executionDump?: ExecutionDump,\n        ) => {\n          if (executionDump) {\n            // Store the execution dump directly without transformation\n            this.taskExecutionDumps[requestId] = executionDump;\n          }\n        };\n      }\n\n      const response: {\n        result: unknown;\n        dump: string | null;\n        error: string | null;\n        reportHTML: string | null;\n        requestId?: string;\n      } = {\n        result: null,\n        dump: null,\n        error: null,\n        reportHTML: null,\n        requestId,\n      };\n\n      const startTime = Date.now();\n      try {\n        // Get action space to check for dynamic actions\n        const actionSpace = this.agent.interface.actionSpace();\n\n        // Prepare value object for executeAction\n        const value = {\n          type,\n          prompt,\n          params,\n        };\n\n        response.result = await executeAction(\n          this.agent,\n          type,\n          actionSpace,\n          value,\n          {\n            deepThink,\n            screenshotIncluded,\n            domIncluded,\n            deviceOptions,\n          },\n        );\n      } catch (error: unknown) {\n        response.error = formatErrorMessage(error);\n      }\n\n      try {\n        const dumpString = this.agent.dumpDataString();\n        if (dumpString) {\n          const groupedDump = JSON.parse(dumpString);\n          // Extract first execution from grouped dump, matching local execution adapter behavior\n          response.dump = groupedDump.executions?.[0] || null;\n        } else {\n          response.dump = null;\n        }\n        response.reportHTML = this.agent.reportHTMLString() || null;\n\n        this.agent.writeOutActionDumps();\n        this.agent.resetDump();\n      } catch (error: unknown) {\n        const errorMessage =\n          error instanceof Error ? error.message : 'Unknown error';\n        console.error(\n          `write out dump failed: requestId: ${requestId}, ${errorMessage}`,\n        );\n      }\n\n      res.send(response);\n      const timeCost = Date.now() - startTime;\n\n      if (response.error) {\n        console.error(\n          `handle request failed after ${timeCost}ms: requestId: ${requestId}, ${response.error}`,\n        );\n      } else {\n        console.log(\n          `handle request done after ${timeCost}ms: requestId: ${requestId}`,\n        );\n      }\n\n      // Clean up task execution dumps and unlock after execution completes\n      if (requestId) {\n        delete this.taskExecutionDumps[requestId];\n        // Release the lock\n        if (this.currentTaskId === requestId) {\n          this.currentTaskId = null;\n        }\n      }\n    });\n\n    this._app.post(\n      '/cancel/:requestId',\n      async (req: Request, res: Response) => {\n        const { requestId } = req.params;\n\n        if (!requestId) {\n          return res.status(400).json({\n            error: 'requestId is required',\n          });\n        }\n\n        try {\n          // Check if this is the current running task\n          if (this.currentTaskId !== requestId) {\n            return res.json({\n              status: 'not_found',\n              message: 'Task not found or already completed',\n            });\n          }\n\n          console.log(`Cancelling task: ${requestId}`);\n\n          // Get current execution data before cancelling (dump and reportHTML)\n          let dump: any = null;\n          let reportHTML: string | null = null;\n\n          try {\n            const dumpString = this.agent.dumpDataString?.();\n            if (dumpString) {\n              const groupedDump = JSON.parse(dumpString);\n              // Extract first execution from grouped dump\n              dump = groupedDump.executions?.[0] || null;\n            }\n\n            reportHTML = this.agent.reportHTMLString?.() || null;\n          } catch (error: unknown) {\n            console.warn('Failed to get execution data before cancel:', error);\n          }\n\n          // Recreate/destroy agent to cancel the current task\n          await this.recreateAgent();\n\n          // Clean up\n          delete this.taskExecutionDumps[requestId];\n          this.currentTaskId = null;\n\n          res.json({\n            status: 'cancelled',\n            message: 'Task cancelled successfully',\n            dump,\n            reportHTML,\n          });\n        } catch (error: unknown) {\n          const errorMessage =\n            error instanceof Error ? error.message : 'Unknown error';\n          console.error(`Failed to cancel: ${errorMessage}`);\n          res.status(500).json({\n            error: `Failed to cancel: ${errorMessage}`,\n          });\n        }\n      },\n    );\n\n    // Screenshot API for real-time screenshot polling\n    this._app.get('/screenshot', async (_req: Request, res: Response) => {\n      try {\n        // Check if page has screenshotBase64 method\n        if (typeof this.agent.interface.screenshotBase64 !== 'function') {\n          return res.status(500).json({\n            error: 'Screenshot method not available on current interface',\n          });\n        }\n\n        const base64Screenshot = await this.agent.interface.screenshotBase64();\n\n        res.json({\n          screenshot: base64Screenshot,\n          timestamp: Date.now(),\n        });\n      } catch (error: unknown) {\n        const errorMessage =\n          error instanceof Error ? error.message : 'Unknown error';\n        console.error(`Failed to take screenshot: ${errorMessage}`);\n        res.status(500).json({\n          error: `Failed to take screenshot: ${errorMessage}`,\n        });\n      }\n    });\n\n    // Interface info API for getting interface type and description\n    this._app.get('/interface-info', async (_req: Request, res: Response) => {\n      try {\n        const type = this.agent.interface.interfaceType || 'Unknown';\n        const description = this.agent.interface.describe?.() || undefined;\n\n        res.json({\n          type,\n          description,\n        });\n      } catch (error: unknown) {\n        const errorMessage =\n          error instanceof Error ? error.message : 'Unknown error';\n        console.error(`Failed to get interface info: ${errorMessage}`);\n        res.status(500).json({\n          error: `Failed to get interface info: ${errorMessage}`,\n        });\n      }\n    });\n\n    this.app.post('/config', async (req: Request, res: Response) => {\n      const { aiConfig } = req.body;\n\n      if (!aiConfig || typeof aiConfig !== 'object') {\n        return res.status(400).json({\n          error: 'aiConfig is required and must be an object',\n        });\n      }\n\n      if (Object.keys(aiConfig).length === 0) {\n        return res.json({\n          status: 'ok',\n          message: 'AI config not changed due to empty object',\n        });\n      }\n\n      try {\n        overrideAIConfig(aiConfig);\n\n        // Note: Agent will be recreated on next execution to apply new config\n        return res.json({\n          status: 'ok',\n          message:\n            'AI config updated. Agent will be recreated on next execution.',\n        });\n      } catch (error: unknown) {\n        const errorMessage =\n          error instanceof Error ? error.message : 'Unknown error';\n        console.error(`Failed to update AI config: ${errorMessage}`);\n        return res.status(500).json({\n          error: `Failed to update AI config: ${errorMessage}`,\n        });\n      }\n    });\n  }\n\n  /**\n   * Setup static file serving routes\n   */\n  private setupStaticRoutes(): void {\n    // Handle index.html with port injection\n    this._app.get('/', (_req: Request, res: Response) => {\n      this.serveHtmlWithPorts(res);\n    });\n\n    this._app.get('/index.html', (_req: Request, res: Response) => {\n      this.serveHtmlWithPorts(res);\n    });\n\n    // Use express.static middleware for secure static file serving\n    this._app.use(express.static(this.staticPath));\n\n    // Fallback to index.html for SPA routing\n    this._app.get('*', (_req: Request, res: Response) => {\n      this.serveHtmlWithPorts(res);\n    });\n  }\n\n  /**\n   * Serve HTML with injected port configuration\n   */\n  private serveHtmlWithPorts(res: Response): void {\n    try {\n      const htmlPath = join(this.staticPath, 'index.html');\n      let html = readFileSync(htmlPath, 'utf8');\n\n      // Get scrcpy server port from global\n      const scrcpyPort = (global as any).scrcpyServerPort || this.port! + 1;\n\n      // Inject scrcpy port configuration script into HTML head\n      const configScript = `\n        <script>\n          window.SCRCPY_PORT = ${scrcpyPort};\n        </script>\n      `;\n\n      // Insert the script before closing </head> tag\n      html = html.replace('</head>', `${configScript}</head>`);\n\n      res.setHeader('Content-Type', 'text/html');\n      res.send(html);\n    } catch (error) {\n      console.error('Error serving HTML with ports:', error);\n      res.status(500).send('Internal Server Error');\n    }\n  }\n\n  /**\n   * Launch the server on specified port\n   */\n  async launch(port?: number): Promise<PlaygroundServer> {\n    // If using factory mode, initialize agent\n    if (this.agentFactory) {\n      console.log('Initializing agent from factory function...');\n      this.agent = await this.agentFactory();\n      console.log('Agent initialized successfully');\n    }\n\n    // Initialize routes now, after any middleware has been added\n    this.initializeApp();\n\n    this.port = port || defaultPort;\n\n    return new Promise((resolve) => {\n      const serverPort = this.port;\n      this.server = this._app.listen(serverPort, () => {\n        resolve(this);\n      });\n    });\n  }\n\n  /**\n   * Close the server and clean up resources\n   */\n  async close(): Promise<void> {\n    return new Promise((resolve, reject) => {\n      if (this.server) {\n        // Clean up the single agent\n        try {\n          this.agent.destroy();\n        } catch (error) {\n          console.warn('Failed to destroy agent:', error);\n        }\n        this.taskExecutionDumps = {};\n\n        // Close the server\n        this.server.close((error) => {\n          if (error) {\n            reject(error);\n          } else {\n            this.server = undefined;\n            resolve();\n          }\n        });\n      } else {\n        resolve();\n      }\n    });\n  }\n}\n\nexport default PlaygroundServer;\nexport { PlaygroundServer };\n"],"names":["defaultPort","PLAYGROUND_SERVER_PORT","__filename","fileURLToPath","__dirname","dirname","STATIC_PATH","join","errorHandler","err","req","res","next","console","errorMessage","Error","PlaygroundServer","express","_res","context","uuid","tmpFile","writeFileSync","error","contextFile","existsSync","readFileSync","requestId","executionDump","actionSpace","processedActionSpace","action","typedAction","processedSchema","e","actionName","type","prompt","params","deepThink","screenshotIncluded","domIncluded","deviceOptions","_dump","response","startTime","Date","value","executeAction","formatErrorMessage","dumpString","groupedDump","JSON","timeCost","dump","reportHTML","_req","base64Screenshot","description","undefined","aiConfig","Object","overrideAIConfig","htmlPath","html","scrcpyPort","global","configScript","port","Promise","resolve","serverPort","reject","agent","staticPath","id","getTmpDir"],"mappings":"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"}