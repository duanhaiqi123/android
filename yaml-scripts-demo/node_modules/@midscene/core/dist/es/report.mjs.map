{"version":3,"file":"report.mjs","sources":["../../src/report.ts"],"sourcesContent":["import * as fs from 'node:fs';\nimport * as path from 'node:path';\nimport { getMidsceneRunSubDir } from '@midscene/shared/common';\nimport { getReportFileName } from './agent';\nimport type { ReportFileWithAttributes } from './types';\nimport { getReportTpl, reportHTMLContent } from './utils';\n\nexport class ReportMergingTool {\n  private reportInfos: ReportFileWithAttributes[] = [];\n  public append(reportInfo: ReportFileWithAttributes) {\n    this.reportInfos.push(reportInfo);\n  }\n  public clear() {\n    this.reportInfos = [];\n  }\n  private extractScriptContent(filePath: string): string {\n    // Regular expression to match content between script tags\n    // Requires newline before <script and </script>\n    const scriptRegex =\n      /\\n<script type=\"midscene_web_dump\" type=\"application\\/json\"[^>]*>([\\s\\S]*?)\\n<\\/script>/;\n\n    const fileContent = fs.readFileSync(filePath, 'utf-8');\n    const match = scriptRegex.exec(fileContent);\n\n    return match ? match[1].trim() : '';\n  }\n\n  public mergeReports(\n    reportFileName: 'AUTO' | string = 'AUTO', // user custom report filename, save into midscene report dir if undefined\n    opts?: {\n      rmOriginalReports?: boolean; // whether to remove origin report files\n      overwrite?: boolean; // if output filepath specified, throw an error when overwrite = true, otherwise overwrite the file\n    },\n  ): string | null {\n    if (this.reportInfos.length <= 1) {\n      console.log('Not enough report to merge');\n      return null;\n    }\n    opts = Object.assign(\n      {\n        rmOriginalReports: false,\n        overwrite: false,\n      },\n      opts || {},\n    );\n    const { rmOriginalReports, overwrite } = opts;\n    let outputFilePath;\n    const targetDir = `${getMidsceneRunSubDir('report')}`;\n    if (reportFileName === 'AUTO') {\n      outputFilePath = path.resolve(\n        targetDir,\n        `${getReportFileName('merged-report')}.html`,\n      );\n    } else {\n      // user specified a output filepath\n      outputFilePath = path.resolve(targetDir, `${reportFileName}.html`);\n      if (fs.existsSync(outputFilePath) && !overwrite) {\n        throw Error(\n          `report file already existed: ${outputFilePath}\\nset override to true to overwrite this file.`,\n        );\n      } else if (fs.existsSync(outputFilePath) && overwrite) {\n        fs.unlinkSync(outputFilePath);\n      }\n    }\n\n    console.log(\n      `Start merging ${this.reportInfos.length} reports...\\nCreating template file...`,\n    );\n\n    try {\n      // Write template\n      fs.appendFileSync(outputFilePath, getReportTpl());\n\n      // Process all reports one by one\n      for (let i = 0; i < this.reportInfos.length; i++) {\n        const reportInfo = this.reportInfos[i];\n        console.log(`Processing report ${i + 1}/${this.reportInfos.length}`);\n\n        const dumpString = this.extractScriptContent(reportInfo.reportFilePath);\n        const reportAttributes = reportInfo.reportAttributes;\n\n        const reportHtmlStr = `${reportHTMLContent(\n          {\n            dumpString,\n            attributes: {\n              playwright_test_duration: reportAttributes.testDuration,\n              playwright_test_status: reportAttributes.testStatus,\n              playwright_test_title: reportAttributes.testTitle,\n              playwright_test_id: reportAttributes.testId,\n              playwright_test_description: reportAttributes.testDescription,\n            },\n          },\n          undefined,\n          undefined,\n          false,\n        )}\\n`; // use existed function to achieve report script content\n\n        fs.appendFileSync(outputFilePath, reportHtmlStr);\n      }\n\n      console.log(`Successfully merged new report: ${outputFilePath}`);\n\n      // Remove original reports if needed\n      if (rmOriginalReports) {\n        for (const info of this.reportInfos) {\n          try {\n            fs.unlinkSync(info.reportFilePath);\n          } catch (error) {\n            console.error(\n              `Error deleting report ${info.reportFilePath}:`,\n              error,\n            );\n          }\n        }\n        console.log(`Removed ${this.reportInfos.length} original reports`);\n      }\n      return outputFilePath;\n    } catch (error) {\n      console.error('Error in mergeReports:', error);\n      throw error;\n    }\n  }\n}\n"],"names":["ReportMergingTool","reportInfo","filePath","scriptRegex","fileContent","fs","match","reportFileName","opts","console","Object","rmOriginalReports","overwrite","outputFilePath","targetDir","getMidsceneRunSubDir","path","getReportFileName","Error","getReportTpl","i","dumpString","reportAttributes","reportHtmlStr","reportHTMLContent","undefined","info","error"],"mappings":";;;;;;;;;;;;;;;AAOO,MAAMA;IAEJ,OAAOC,UAAoC,EAAE;QAClD,IAAI,CAAC,WAAW,CAAC,IAAI,CAACA;IACxB;IACO,QAAQ;QACb,IAAI,CAAC,WAAW,GAAG,EAAE;IACvB;IACQ,qBAAqBC,QAAgB,EAAU;QAGrD,MAAMC,cACJ;QAEF,MAAMC,cAAcC,aAAgBH,UAAU;QAC9C,MAAMI,QAAQH,YAAY,IAAI,CAACC;QAE/B,OAAOE,QAAQA,KAAK,CAAC,EAAE,CAAC,IAAI,KAAK;IACnC;IAEO,aACLC,iBAAkC,MAAM,EACxCC,IAGC,EACc;QACf,IAAI,IAAI,CAAC,WAAW,CAAC,MAAM,IAAI,GAAG;YAChCC,QAAQ,GAAG,CAAC;YACZ,OAAO;QACT;QACAD,OAAOE,OAAO,MAAM,CAClB;YACE,mBAAmB;YACnB,WAAW;QACb,GACAF,QAAQ,CAAC;QAEX,MAAM,EAAEG,iBAAiB,EAAEC,SAAS,EAAE,GAAGJ;QACzC,IAAIK;QACJ,MAAMC,YAAY,GAAGC,qBAAqB,WAAW;QACrD,IAAIR,AAAmB,WAAnBA,gBACFM,iBAAiBG,QACfF,WACA,GAAGG,kBAAkB,iBAAiB,KAAK,CAAC;aAEzC;YAELJ,iBAAiBG,QAAaF,WAAW,GAAGP,eAAe,KAAK,CAAC;YACjE,IAAIF,WAAcQ,mBAAmB,CAACD,WACpC,MAAMM,MACJ,CAAC,6BAA6B,EAAEL,eAAe,8CAA8C,CAAC;YAE3F,IAAIR,WAAcQ,mBAAmBD,WAC1CP,WAAcQ;QAElB;QAEAJ,QAAQ,GAAG,CACT,CAAC,cAAc,EAAE,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,sCAAsC,CAAC;QAGlF,IAAI;YAEFJ,eAAkBQ,gBAAgBM;YAGlC,IAAK,IAAIC,IAAI,GAAGA,IAAI,IAAI,CAAC,WAAW,CAAC,MAAM,EAAEA,IAAK;gBAChD,MAAMnB,aAAa,IAAI,CAAC,WAAW,CAACmB,EAAE;gBACtCX,QAAQ,GAAG,CAAC,CAAC,kBAAkB,EAAEW,IAAI,EAAE,CAAC,EAAE,IAAI,CAAC,WAAW,CAAC,MAAM,EAAE;gBAEnE,MAAMC,aAAa,IAAI,CAAC,oBAAoB,CAACpB,WAAW,cAAc;gBACtE,MAAMqB,mBAAmBrB,WAAW,gBAAgB;gBAEpD,MAAMsB,gBAAgB,GAAGC,kBACvB;oBACEH;oBACA,YAAY;wBACV,0BAA0BC,iBAAiB,YAAY;wBACvD,wBAAwBA,iBAAiB,UAAU;wBACnD,uBAAuBA,iBAAiB,SAAS;wBACjD,oBAAoBA,iBAAiB,MAAM;wBAC3C,6BAA6BA,iBAAiB,eAAe;oBAC/D;gBACF,GACAG,QACAA,QACA,OACA,EAAE,CAAC;gBAELpB,eAAkBQ,gBAAgBU;YACpC;YAEAd,QAAQ,GAAG,CAAC,CAAC,gCAAgC,EAAEI,gBAAgB;YAG/D,IAAIF,mBAAmB;gBACrB,KAAK,MAAMe,QAAQ,IAAI,CAAC,WAAW,CACjC,IAAI;oBACFrB,WAAcqB,KAAK,cAAc;gBACnC,EAAE,OAAOC,OAAO;oBACdlB,QAAQ,KAAK,CACX,CAAC,sBAAsB,EAAEiB,KAAK,cAAc,CAAC,CAAC,CAAC,EAC/CC;gBAEJ;gBAEFlB,QAAQ,GAAG,CAAC,CAAC,QAAQ,EAAE,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,iBAAiB,CAAC;YACnE;YACA,OAAOI;QACT,EAAE,OAAOc,OAAO;YACdlB,QAAQ,KAAK,CAAC,0BAA0BkB;YACxC,MAAMA;QACR;IACF;;QAjHA,uBAAQ,eAA0C,EAAE;;AAkHtD"}