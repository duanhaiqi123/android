{"version":3,"file":"adapters/remote-execution.mjs","sources":["../../../src/adapters/remote-execution.ts"],"sourcesContent":["import type { DeviceAction, ExecutionDump } from '@midscene/core';\nimport { parseStructuredParams } from '../common';\nimport type { ExecutionOptions, FormValue, ValidationResult } from '../types';\nimport { BasePlaygroundAdapter } from './base';\n\nexport class RemoteExecutionAdapter extends BasePlaygroundAdapter {\n  private serverUrl?: string;\n  private _id?: string;\n  private dumpUpdateCallback?: (\n    dump: string,\n    executionDump?: ExecutionDump,\n  ) => void;\n  private pollingIntervalId?: ReturnType<typeof setInterval>;\n\n  constructor(serverUrl: string) {\n    super();\n    this.serverUrl = serverUrl;\n  }\n\n  // Set dump update callback\n  onDumpUpdate(\n    callback: (dump: string, executionDump?: ExecutionDump) => void,\n  ): void {\n    this.dumpUpdateCallback = undefined;\n    this.dumpUpdateCallback = callback;\n  }\n\n  // Get adapter ID (cached after first status check for remote)\n  get id(): string | undefined {\n    return this._id;\n  }\n\n  // Override validateParams for remote execution\n  // Since schemas from server are JSON-serialized and lack .parse() method\n  validateParams(\n    value: FormValue,\n    action: DeviceAction<unknown> | undefined,\n  ): ValidationResult {\n    if (!action?.paramSchema) {\n      return { valid: true };\n    }\n\n    const needsStructuredParams = this.actionNeedsStructuredParams(action);\n\n    if (!needsStructuredParams) {\n      return { valid: true };\n    }\n\n    if (!value.params) {\n      return { valid: false, errorMessage: 'Parameters are required' };\n    }\n\n    // For remote execution, perform basic validation without .parse()\n    // Check if required fields are present\n    if (action.paramSchema && typeof action.paramSchema === 'object') {\n      const schema = action.paramSchema as any;\n      if (schema.shape || schema.type === 'ZodObject') {\n        const shape = schema.shape || {};\n        const missingFields = Object.keys(shape).filter((key) => {\n          const fieldDef = shape[key];\n          // Check if field is required (not optional)\n          const isOptional =\n            fieldDef?.isOptional ||\n            fieldDef?._def?.innerType || // ZodOptional\n            fieldDef?._def?.typeName === 'ZodOptional';\n          return (\n            !isOptional &&\n            (value.params![key] === undefined || value.params![key] === '')\n          );\n        });\n\n        if (missingFields.length > 0) {\n          return {\n            valid: false,\n            errorMessage: `Missing required parameters: ${missingFields.join(', ')}`,\n          };\n        }\n      }\n    }\n\n    return { valid: true };\n  }\n\n  async parseStructuredParams(\n    action: DeviceAction<unknown>,\n    params: Record<string, unknown>,\n    options: ExecutionOptions,\n  ): Promise<unknown[]> {\n    // Use shared implementation from common.ts\n    return await parseStructuredParams(action, params, options);\n  }\n\n  formatErrorMessage(error: any): string {\n    const message = error?.message || '';\n\n    // Handle Android-specific errors\n    const androidErrors = [\n      {\n        keyword: 'adb',\n        message:\n          'ADB connection error. Please ensure device is connected and USB debugging is enabled.',\n      },\n      {\n        keyword: 'UIAutomator',\n        message:\n          'UIAutomator error. Please ensure the UIAutomator server is running on the device.',\n      },\n    ];\n\n    const androidError = androidErrors.find(({ keyword }) =>\n      message.includes(keyword),\n    );\n    if (androidError) {\n      return androidError.message;\n    }\n\n    return this.formatBasicErrorMessage(error);\n  }\n\n  // Remote execution adapter - simplified interface\n  async executeAction(\n    actionType: string,\n    value: FormValue,\n    options: ExecutionOptions,\n  ): Promise<unknown> {\n    // If serverUrl is provided, use server-side execution\n    if (this.serverUrl && typeof window !== 'undefined') {\n      return this.executeViaServer(actionType, value, options);\n    }\n\n    throw new Error(\n      'Remote execution adapter requires server URL for execution',\n    );\n  }\n\n  // Remote execution via server - uses same endpoint as requestPlaygroundServer\n  private async executeViaServer(\n    actionType: string,\n    value: FormValue,\n    options: ExecutionOptions,\n  ): Promise<unknown> {\n    const payload: Record<string, unknown> = {\n      type: actionType,\n      prompt: value.prompt,\n      ...this.buildOptionalPayloadParams(options, value),\n    };\n\n    // Add context only if it exists (server can handle single agent case without context)\n    if (options.context) {\n      payload.context = options.context;\n    }\n\n    // Start polling if requestId is provided and dumpUpdateCallback is set\n    if (options.requestId && this.dumpUpdateCallback) {\n      this.startProgressPolling(options.requestId);\n    }\n\n    try {\n      const response = await fetch(`${this.serverUrl}/execute`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(payload),\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text().catch(() => 'Unknown error');\n        throw new Error(\n          `Server request failed (${response.status}): ${errorText}`,\n        );\n      }\n\n      const result = await response.json();\n\n      return result;\n    } catch (error) {\n      console.error('Execute via server failed:', error);\n      throw error;\n    } finally {\n      // Stop polling when execution completes (success or error)\n      this.stopProgressPolling();\n    }\n  }\n\n  // Helper method to build optional payload parameters\n  private buildOptionalPayloadParams(\n    options: ExecutionOptions,\n    value: FormValue,\n  ): Record<string, unknown> {\n    const optionalParams: Record<string, unknown> = {};\n\n    // Add optional parameters only if they have meaningful values\n    const optionalFields = [\n      { key: 'requestId', value: options.requestId },\n      { key: 'deepThink', value: options.deepThink },\n      { key: 'screenshotIncluded', value: options.screenshotIncluded },\n      { key: 'domIncluded', value: options.domIncluded },\n      { key: 'deviceOptions', value: options.deviceOptions },\n      { key: 'params', value: value.params },\n    ] as const;\n\n    optionalFields.forEach(({ key, value }) => {\n      if (value !== undefined && value !== null && value !== '') {\n        optionalParams[key] = value;\n      }\n    });\n\n    return optionalParams;\n  }\n\n  // Get action space from server with fallback\n  async getActionSpace(context?: unknown): Promise<DeviceAction<unknown>[]> {\n    // Try server first if available\n    if (this.serverUrl && typeof window !== 'undefined') {\n      try {\n        const response = await fetch(`${this.serverUrl}/action-space`, {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify({ context }),\n        });\n\n        if (!response.ok) {\n          throw new Error(`Failed to get action space: ${response.statusText}`);\n        }\n\n        const result = await response.json();\n        return Array.isArray(result) ? result : [];\n      } catch (error) {\n        console.error('Failed to get action space from server:', error);\n        // Fall through to context fallback\n      }\n    }\n\n    // Fallback: try context.actionSpace if available\n    if (context && typeof context === 'object' && 'actionSpace' in context) {\n      try {\n        const actionSpaceMethod = (\n          context as {\n            actionSpace: () =>\n              | DeviceAction<unknown>[]\n              | Promise<DeviceAction<unknown>[]>;\n          }\n        ).actionSpace;\n        const result = await actionSpaceMethod();\n        return Array.isArray(result) ? result : [];\n      } catch (error) {\n        console.error('Failed to get action space from context:', error);\n      }\n    }\n\n    return [];\n  }\n\n  // Uses base implementation for validateParams and createDisplayContent\n\n  // Server communication methods\n  async checkStatus(): Promise<boolean> {\n    if (!this.serverUrl) {\n      return false;\n    }\n\n    try {\n      const res = await fetch(`${this.serverUrl}/status`);\n      if (res.status === 200) {\n        // Try to extract id from response\n        try {\n          const data = await res.json();\n          if (data.id && typeof data.id === 'string') {\n            this._id = data.id;\n          }\n        } catch (jsonError) {\n          // If JSON parsing fails, id remains undefined but status is still OK\n          console.debug('Failed to parse status response:', jsonError);\n        }\n        return true;\n      }\n      return false;\n    } catch (error) {\n      console.warn('Server status check failed:', error);\n      return false;\n    }\n  }\n\n  async overrideConfig(aiConfig: Record<string, unknown>): Promise<void> {\n    if (!this.serverUrl) {\n      throw new Error('Server URL not configured');\n    }\n\n    try {\n      const response = await fetch(`${this.serverUrl}/config`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ aiConfig }),\n      });\n\n      if (!response.ok) {\n        throw new Error(\n          `Failed to override server config: ${response.statusText}`,\n        );\n      }\n    } catch (error) {\n      console.error('Failed to override server config:', error);\n      throw error;\n    }\n  }\n\n  async getTaskProgress(requestId: string): Promise<{\n    executionDump?: ExecutionDump;\n  }> {\n    if (!this.serverUrl) {\n      return {};\n    }\n\n    if (!requestId?.trim()) {\n      console.warn('Invalid requestId provided for task progress');\n      return {};\n    }\n\n    try {\n      const response = await fetch(\n        `${this.serverUrl}/task-progress/${encodeURIComponent(requestId)}`,\n      );\n\n      if (!response.ok) {\n        console.warn(`Task progress request failed: ${response.statusText}`);\n        return {};\n      }\n\n      return await response.json();\n    } catch (error) {\n      console.error('Failed to poll task progress:', error);\n      return {};\n    }\n  }\n\n  /**\n   * Start polling for task progress and invoke dump update callback\n   */\n  private startProgressPolling(requestId: string): void {\n    // Clear any existing polling\n    this.stopProgressPolling();\n\n    // Poll every 500ms for progress updates\n    this.pollingIntervalId = setInterval(async () => {\n      try {\n        const progressData = await this.getTaskProgress(requestId);\n\n        if (progressData.executionDump) {\n          // Invoke dump update callback if set\n          if (this.dumpUpdateCallback) {\n            this.dumpUpdateCallback('', progressData.executionDump);\n          }\n        }\n      } catch (error) {\n        console.error('Error polling task progress:', error);\n      }\n    }, 500); // Poll every 500ms\n  }\n\n  /**\n   * Stop polling for task progress\n   */\n  private stopProgressPolling(): void {\n    if (this.pollingIntervalId) {\n      clearInterval(this.pollingIntervalId);\n      this.pollingIntervalId = undefined;\n    }\n  }\n\n  // Cancel task\n  async cancelTask(\n    requestId: string,\n  ): Promise<{ error?: string; success?: boolean }> {\n    if (!this.serverUrl) {\n      return { error: 'No server URL configured' };\n    }\n\n    if (!requestId?.trim()) {\n      return { error: 'Invalid request ID' };\n    }\n\n    try {\n      const res = await fetch(\n        `${this.serverUrl}/cancel/${encodeURIComponent(requestId)}`,\n        {\n          method: 'POST',\n        },\n      );\n\n      if (!res.ok) {\n        return { error: `Cancel request failed: ${res.statusText}` };\n      }\n\n      const result = await res.json();\n      return { success: true, ...result };\n    } catch (error) {\n      console.error('Failed to cancel task:', error);\n      return { error: 'Failed to cancel task' };\n    }\n  }\n\n  // Get screenshot from server\n  async getScreenshot(): Promise<{\n    screenshot: string;\n    timestamp: number;\n  } | null> {\n    if (!this.serverUrl) {\n      return null;\n    }\n\n    try {\n      const response = await fetch(`${this.serverUrl}/screenshot`);\n\n      if (!response.ok) {\n        console.warn(`Screenshot request failed: ${response.statusText}`);\n        return null;\n      }\n\n      return await response.json();\n    } catch (error) {\n      console.error('Failed to get screenshot:', error);\n      return null;\n    }\n  }\n\n  // Get interface information from server\n  async getInterfaceInfo(): Promise<{\n    type: string;\n    description?: string;\n  } | null> {\n    if (!this.serverUrl) {\n      return null;\n    }\n\n    try {\n      const response = await fetch(`${this.serverUrl}/interface-info`);\n\n      if (!response.ok) {\n        console.warn(`Interface info request failed: ${response.statusText}`);\n        return null;\n      }\n\n      return await response.json();\n    } catch (error) {\n      console.error('Failed to get interface info:', error);\n      return null;\n    }\n  }\n}\n"],"names":["RemoteExecutionAdapter","BasePlaygroundAdapter","callback","undefined","value","action","needsStructuredParams","schema","shape","missingFields","Object","key","fieldDef","isOptional","params","options","parseStructuredParams","error","message","androidErrors","androidError","keyword","actionType","window","Error","payload","response","fetch","JSON","errorText","result","console","optionalParams","optionalFields","context","Array","actionSpaceMethod","res","data","jsonError","aiConfig","requestId","encodeURIComponent","setInterval","progressData","clearInterval","serverUrl"],"mappings":"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"}