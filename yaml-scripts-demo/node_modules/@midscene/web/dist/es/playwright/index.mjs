import { Agent } from "@midscene/core/agent";
import { WebPage } from "./page.mjs";
import { PlaywrightAiFixture } from "./ai-fixture.mjs";
import { overrideAIConfig } from "@midscene/shared/env";
import { getDebug } from "@midscene/shared/logger";
import semver from "semver";
import { forceChromeSelectRendering as base_page_mjs_forceChromeSelectRendering, forceClosePopup } from "../puppeteer/base-page.mjs";
import { getWebpackRequire } from "../utils.mjs";
const debug = getDebug('playwright:agent');
function getPlaywrightVersion() {
    try {
        const playwrightPkg = getWebpackRequire()('playwright/package.json');
        return playwrightPkg.version || null;
    } catch (error) {
        console.error('[midscene:error] Failed to get Playwright version', error);
        return null;
    }
}
class PlaywrightAgent extends Agent {
    async waitForNetworkIdle(timeout = 1000) {
        await this.page.underlyingPage.waitForLoadState('networkidle', {
            timeout
        });
    }
    constructor(page, opts){
        const webPage = new WebPage(page, opts);
        super(webPage, opts);
        const { forceSameTabNavigation = true, forceChromeSelectRendering } = opts ?? {};
        if (forceSameTabNavigation) forceClosePopup(page, debug);
        if (forceChromeSelectRendering) {
            const playwrightVersion = getPlaywrightVersion();
            if (playwrightVersion && !semver.gte(playwrightVersion, '1.52.0')) console.warn(`[midscene:error] forceChromeSelectRendering requires Playwright >= 1.52.0, but current version is ${playwrightVersion}. This feature may not work correctly.`);
            base_page_mjs_forceChromeSelectRendering(page);
        }
    }
}
export { PlaywrightAgent, PlaywrightAiFixture, WebPage as PlaywrightWebPage, overrideAIConfig };

//# sourceMappingURL=index.mjs.map